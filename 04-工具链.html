<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">04-工具链 </span></span><ul><li><span class="name"><span class="innerContentContainer">Android代码下载  **</span></span><ul><li><span class="name"><span class="innerContentContainer">国内可用的镜像：https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/</span></span></li><li><span class="name"><span class="innerContentContainer">下载Repo： 启动Cygwin,然后cd /bin,切到bin目录执行</span></span><ul><li><span class="name"><span class="innerContentContainer">curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo &gt; ~/bin/repo , 下载repo到bin目录.</span></span></li><li><span class="name"><span class="innerContentContainer">chmod a+x ~/bin/repo , 赋予它可执行的权限.</span></span></li><li><span class="name"><span class="innerContentContainer">修改repo文件:</span></span><ul><li><span class="name"><span class="innerContentContainer">REPO_URL = 'https://gerrit.googlesource.com/git-repo'  替换为</span></span></li><li><span class="name"><span class="innerContentContainer">REPO_URL = 'https://gerrit-google.tuna.tsinghua.edu.cn/git-repo'</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest</span></span></li><li><span class="name"><span class="innerContentContainer">repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-10.0.0_r14 --repo-url=https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/</span></span></li><li><span class="name"><span class="innerContentContainer">repo sync</span></span></li><li><span class="name"><span class="innerContentContainer">repo 常见异常</span></span><ul><li><span class="name"><span class="innerContentContainer">fatal: the remote end hung up unexpectedly</span></span></li><li><span class="name"><span class="innerContentContainer">fatal: early EOF</span></span></li><li><span class="name"><span class="innerContentContainer">解决方法: ~/.gitconfig  加入如下语句:</span></span><ul><li><span class="name"><span class="innerContentContainer">[http]</span></span><ul><li><span class="name"><span class="innerContentContainer">postBuffer = 524288000</span></span></li></ul></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Windows上安装cygwin</span></span><ul><li><span class="name"><span class="innerContentContainer">下载&nbsp;Cygwin&nbsp;,然后就是一路的下一步。第一次安装, 要选 install from internet。</span></span></li><li><span class="name"><span class="innerContentContainer">使用镜像：</span></span><ul><li><span class="name"><span class="innerContentContainer">http://mirrors.aliyun.com</span></span></li><li><span class="name"><span class="innerContentContainer">http://www.cygwin.cn</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">安装过程中报错“Unable to get setup from &lt;http://mirrors.aliyun.com/&gt;”</span></span><ul><li><span class="name"><span class="innerContentContainer">通过命令行： cygwin-x86_64.exe -X 启动安装</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">选择需要下载安装的组件包。需要选择分类视图。然后选择下面几个库:</span></span><ul><li><span class="name"><span class="innerContentContainer">Net -&gt; curl</span></span></li><li><span class="name"><span class="innerContentContainer">Devel -&gt; git, git-completion, git-gui, gitk</span></span></li><li><span class="name"><span class="innerContentContainer">Libs -&gt; libreadline7, libiconv2</span></span></li><li><span class="name"><span class="innerContentContainer">Editors -&gt; vim</span></span></li><li><span class="name"><span class="innerContentContainer">Python -&gt; python</span></span></li><li><span class="name"><span class="innerContentContainer">如果要gcc编译，则安装 binutils，gcc，gcc-mingw，gdb</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Mac上的特殊设置</span></span><ul><li><span class="name"><span class="innerContentContainer">https://blog.csdn.net/u012455213/article/details/54647010</span></span></li><li><span class="name"><span class="innerContentContainer">https://www.zhihu.com/question/19759722  搜 nothing chen</span></span></li><li><span class="name"><span class="innerContentContainer">分区一定要是大小写敏感的文件系统. 通过磁盘工具检查. 如果不是, 则要创建.</span></span><ul><li><span class="name"><span class="innerContentContainer">hdiutil create -type SPARSE -fs 'Case-sensitive Journaled HFS+' -size 60g ~/android.dmg    // android.dmg 为自定义文件名.</span></span></li><li><span class="name"><span class="innerContentContainer">加载分区: hdiutil attach ~/android.dmg.sparseimage -mountpoint /Volumes/android</span></span></li><li><span class="name"><span class="innerContentContainer">调整分区大小: hdiutil resize -size &lt;new-size-you-want&gt;g ~/android.dmg.sparseimage</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">修改文件打开数量上限</span></span><ul><li><span class="name"><span class="innerContentContainer">mac默认是1024, Android编译时可能超过. 需要修改:</span></span><ul><li><span class="name"><span class="innerContentContainer">~/.bash_profile 中添加内容：</span></span></li><li><span class="name"><span class="innerContentContainer">ulimit -S -n 1024</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">安装 Gradle</span></span><ul><li><span class="name"><span class="innerContentContainer">brew install gradle (前提: 要先安装xCode)</span></span></li><li><span class="name"><span class="innerContentContainer">安装位置: /usr/local/Cellar/gradle/2.2.1</span></span></li><li><span class="name"><span class="innerContentContainer">check安装是否成功: gradle -version</span></span></li><li><span class="name"><span class="innerContentContainer">写入环境变量:</span></span><ul><li><span class="name"><span class="innerContentContainer">vim ~/.bash_profile</span></span></li><li><span class="name"><span class="innerContentContainer">GRADLE_HOME=/usr/local/Cellar/gradle/2.2.1</span></span></li><li><span class="name"><span class="innerContentContainer">export GRADLE_HOME</span></span></li><li><span class="name"><span class="innerContentContainer">export PATH=$PATH:$GRADLE_HOME/bin</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">android看代码环境</span></span><ul><li><span class="name"><span class="innerContentContainer">IEDA 和 AS 的方法一样.</span></span></li><li><span class="name"><span class="innerContentContainer">1. 修改MacOS sdk 版本</span></span><ul><li><span class="name"><span class="innerContentContainer">/build/soong/cc/config/x86_darwin_host.go</span></span></li><li><span class="name"><span class="innerContentContainer">darwinSupportedSdkVersions 中添加 "10.15"</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">2. 生成idegen.jar</span></span><ul><li><span class="name"><span class="innerContentContainer">工程根目录下执行:</span></span></li><li><span class="name"><span class="innerContentContainer">source build/envsetup.sh</span></span><ul><li><span class="name"><span class="innerContentContainer">执行结果: 无任何返回值.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">mmm development/tools/idegen</span></span><ul><li><span class="name"><span class="innerContentContainer">执行结果: #### build completed successfully (10:35 (mm:ss)) ####</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">development/tools/idegen/idegen.sh</span></span><ul><li><span class="name"><span class="innerContentContainer">执行结果: Traversed tree: 143730ms</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">此时会在根目录生成两个文件：android.ipr 和 android.iml</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">3. IDEA 中打开</span></span><ul><li><span class="name"><span class="innerContentContainer">FIle - New - Module from Existing Sourese, 打开刚生成的 android.iml.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">4. 裁剪工程大小</span></span></li><li><span class="name"><span class="innerContentContainer">5. 更换fwk codepath</span></span><ul><li><span class="name"><span class="innerContentContainer">默认情况下, fwk代码会指到jar包中去, 但是既然我们有fwk的源代码, 这显然不是我们想要的.</span></span></li><li><span class="name"></span></li></ul></li><li><span class="name"><span class="innerContentContainer">问题: Mac默认分区不区分大小</span></span><ul><li><span class="name"><span class="innerContentContainer">报错：You are building on a case-insensitive filesystem.</span></span><ul><li><span class="name"><span class="innerContentContainer">Please move your source tree to a case-sensitive filesystem.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">解决方法: 创建一个区分大小写的分区</span></span><ul><li><span class="name"><span class="innerContentContainer">打开磁盘工具, 文件 - 新建映像 - 空白映像, 弹出如下界面;</span></span></li><li><span class="name"><span class="innerContentContainer">填写信息，格式选择区分大小写格式，点击存储，</span></span></li><li><span class="name"><span class="innerContentContainer">然后会在你的位置文件夹内生成一个Android.dmg文件，</span></span></li><li><span class="name"><span class="innerContentContainer">双击即可安装，然后将Android源码考入即可操作。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">android编译环境-windows</span></span><ul><li><span class="name"><span class="innerContentContainer">Windows下使用Docker编译Android系统源代码: https://blog.csdn.net/loongembedded/article/details/88714960</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">android编译环境-Mac  ***</span></span><ul><li><span class="name"><span class="innerContentContainer">更新java sdk到 8u45 或更高版本:</span></span><ul><li><span class="name"><span class="innerContentContainer">检查java sdk版本号: /usr/libexec/java_home -V</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">下载对应设备的vendor代码</span></span><ul><li><span class="name"><span class="innerContentContainer">官方驱动: <a class="contentLink" target="_blank" rel="noreferrer" href="https://developers.google.com/android/drivers">https://developers.google.com/android/drivers</a></span></span></li><li><span class="name"><span class="innerContentContainer">要编译 AOSP 的 master 分支，请使用二进制文件预览。</span></span></li><li><span class="name"><span class="innerContentContainer">Pixel 2 XL: <a class="contentLink" target="_blank" rel="noreferrer" href="https://developers.google.com/android/blobs-preview#taimen6428072">https://developers.google.com/android/blobs-preview#taimen6428072</a></span></span></li><li><span class="name"><span class="innerContentContainer">解压缩下载的文件, 会得到一个sh文件. 拷贝到aosp的根目录.</span></span></li><li><span class="name"><span class="innerContentContainer">命令行窗口输入  sh <a class="contentLink" target="_blank" rel="noreferrer" href="http://xxx.sh">xxx.sh</a> 运行sh文件. </span></span></li><li><span class="name"><span class="innerContentContainer">需要阅读用户协议. 输入999跳到最后一行, 然后输入 "I ACCEPT" 即可。</span></span></li><li><span class="name"><span class="innerContentContainer">sh运行完成之后aosp的根目录会生成一个vendor文件夹.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">清理上一次的编译文件: make clobber</span></span></li><li><span class="name"><span class="innerContentContainer">配置参数: source build/<a class="contentLink" target="_blank" rel="noreferrer" href="http://envsetup.sh">envsetup.sh</a></span></span></li><li><span class="name"><span class="innerContentContainer">选择目标设备: lunch</span></span><ul><li><span class="name"><span class="innerContentContainer">我选择: aosp_taimen-userdebug</span></span></li><li><span class="name"><span class="innerContentContainer">也可以: aosp_blueline-userdebug</span></span></li><li><span class="name"><span class="innerContentContainer">版本类型有:</span></span><ul><li><span class="name"><span class="innerContentContainer">user: 权限受限；适用于生产环境</span></span></li><li><span class="name"><span class="innerContentContainer">userdebug: 与“user”类似，但具有 root 权限和可调试性；是进行调试时的首选编译类型</span></span></li><li><span class="name"><span class="innerContentContainer">eng: 具有额外调试工具的开发配置</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">全编译: make -j7</span></span></li><li><span class="name"><span class="innerContentContainer">编译指定模块: mmm packages/apps/Settings</span></span></li><li><span class="name"><span class="innerContentContainer">编译log: ./out/error.log</span></span></li><li><span class="name"><span class="innerContentContainer">编译问题:</span></span><ul><li><span class="name"><span class="innerContentContainer">module "libscudo" variant "darwin_x86_64_static": depends on disabled module "bionic_libc_platform_headers"</span></span><ul><li><span class="name"><span class="innerContentContainer">external/scudo/Android.bp</span></span></li><li><span class="name"><span class="innerContentContainer">bionic/libc/Android.bp</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">too many open files</span></span><ul><li><span class="name"><span class="innerContentContainer">launchctl limit: 查看文件打开数量限制 (默认值为256)</span></span></li><li><span class="name"><span class="innerContentContainer">sudo launchctl limit maxfiles 2048 unlimited:  修改数量限制</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">关键仓的基本信息</span></span><ul><li><span class="name"><span class="innerContentContainer">模块名，仓名，目录，二进制包名</span></span></li><li><span class="name"><span class="innerContentContainer">framework, frameworks/base , frameworks/base, /system/framework/framework.jar</span></span></li><li><span class="name"><span class="innerContentContainer">framework-res, frameworks/base , frameworks/base/core/res, /system/framework/framework-res.jar</span></span></li><li><span class="name"><span class="innerContentContainer">services, frameworks/base , frameworks/base/service, /system/framework/services.jar</span></span></li><li><span class="name"><span class="innerContentContainer">libinputflinger, frameworks/native, frameworks/native/services/inputflinger, /system/lib64/<a class="contentLink" target="_blank" rel="noreferrer" href="http://libinputflinger.so">libinputflinger.so</a></span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">编译命令</span></span><ul><li><span class="name"><span class="innerContentContainer">新增jar包时android.mk文件中的修改</span></span><ul><li><span class="name"><span class="innerContentContainer">Local_static_java_libraries:=</span></span><ul><li><span class="name"><span class="innerContentContainer">android_support_v4\</span></span></li><li><span class="name"><span class="innerContentContainer">Netpad_system</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Local_prebuilt_static_java_libraries:=</span></span><ul><li><span class="name"><span class="innerContentContainer">libs/function_SDK.jar</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">kernel 中加特性宏</span></span><ul><li><span class="name"><span class="innerContentContainer">android\kernel\arch\arm\configs\defconfig ， CONFIG_HUAWEI_FEATURE_OEMINFO=y</span></span></li><li><span class="name"><span class="innerContentContainer">android\kernel\arch\arm\mach-msm\Kconfig</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">只编译 kernel的命令: make bootimage</span></span></li><li><span class="name"><span class="innerContentContainer">编译带root权限的kernel: make bootimage -eng</span></span></li><li><span class="name"><span class="innerContentContainer">内核模块添加类</span></span><ul><li><span class="name"><span class="innerContentContainer">在该模块的Makefile中，在末尾添加一行：obj-y += rmt_server.o</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">新增一个自启动的内核进程</span></span><ul><li><span class="name"><span class="innerContentContainer">修改 system\core\rootdir\init.rc，在最后面加一行，即：service rmt_server /system/bin/rmt_server</span></span></li><li><span class="name"><span class="innerContentContainer">init.rc 会编译到boot.img中。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">更新frameworks api后, 需调用 updata-api 命令刷新api。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">编译系统: bp文件的语法</span></span><ul><li><span class="name"><span class="innerContentContainer">Android 7用ninja系统替代make来管理编译。 其配置文件叫 Android.bp。</span></span></li><li><span class="name"><span class="innerContentContainer">Android的编译处理流程是: 用blueprint和soong来解析bp文件，将其转换为ninja文件。</span></span><ul><li><span class="name"><span class="innerContentContainer">Android还支持 mk文件, 使用 kati 将mk文件转化为 ninja文件.</span></span></li><li><span class="name"><span class="innerContentContainer">最终用 ninja文件来管理编译过程.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">blueprint和soong是go语言写的. 代码在 build 目录下。</span></span></li><li><span class="name"><span class="innerContentContainer">Android.bp 格式如下:</span></span><ul><li><span class="name"><span class="innerContentContainer">java_library {</span></span><ul><li><span class="name"><span class="innerContentContainer">name: "services",    // 模块名</span></span></li><li><span class="name"><span class="innerContentContainer">dex_preopt: {</span></span><ul><li><span class="name"><span class="innerContentContainer">app_image: true,</span></span></li><li><span class="name"><span class="innerContentContainer">profile: "art-profile",</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">},</span></span></li><li><span class="name"><span class="innerContentContainer">srcs: [    // 指定源代码文件</span></span><ul><li><span class="name"><span class="innerContentContainer">"java/**/*.java",</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">],</span></span></li><li><span class="name"><span class="innerContentContainer">static_libs: [   // 依赖的静态库</span></span><ul><li><span class="name"><span class="innerContentContainer">"services.core",</span></span></li><li><span class="name"><span class="innerContentContainer">"services.accessibility",</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">],</span></span></li><li><span class="name"><span class="innerContentContainer">libs: [    // 依赖的动态库</span></span><ul><li><span class="name"><span class="innerContentContainer">"android.hidl.manager-V1.0-java",</span></span></li><li><span class="name"><span class="innerContentContainer">"miuisdk",</span></span></li><li><span class="name"><span class="innerContentContainer">"miuisystemsdk"</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">],</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li><li><span class="name"><span class="innerContentContainer">cc_library_shared {   // 输出文件</span></span><ul><li><span class="name"><span class="innerContentContainer">name: "libandroid_servers",</span></span></li><li><span class="name"><span class="innerContentContainer">defaults: ["libservices.core-libs"],</span></span></li><li><span class="name"><span class="innerContentContainer">whole_static_libs: ["libservices.core"],</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">第三方刷机包</span></span><ul><li><span class="name"><span class="innerContentContainer">设备型号: Pixel2 xl 的手机</span></span></li><li><span class="name"><span class="innerContentContainer">官方刷机工具包: <a class="contentLink" target="_blank" rel="noreferrer" href="https://dl.google.com/android/repository/platform-tools-latest-darwin.zip">https://dl.google.com/android/repository/platform-tools-latest-darwin.zip</a></span></span></li><li><span class="name"><span class="innerContentContainer">官方刷机包下载: <a class="contentLink" target="_blank" rel="noreferrer" href="https://developers.google.com/android/images#taimen">https://developers.google.com/android/images#taimen</a></span></span></li><li><span class="name"><span class="innerContentContainer">打开adb: 在“设置”中，点按关于手机，然后点按版本号七 (7) 次, 进入开发人员选项.</span></span><ul><li><span class="name"><span class="innerContentContainer">打开 USB 调试.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">进入fastboot模式: adb reboot bootloader</span></span></li><li><span class="name"><span class="innerContentContainer">强制进fastboot模式: Pixel XL:按住音量调低键，然后按住电源键。</span></span></li><li><span class="name"><span class="innerContentContainer">引导加载程序解锁: fastboot flashing lock</span></span><ul><li><span class="name"><span class="innerContentContainer">然后, fastboot flashing unlock_critical</span></span></li><li><span class="name"><span class="innerContentContainer">注意: 在 Motorola Xoom 上重新锁定引导加载程序会清空用户数据</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">刷机: fastboot flashall -w</span></span><ul><li><span class="name"><span class="innerContentContainer">-w&nbsp;选项会清除设备上的&nbsp;/data&nbsp;分区；该选项在您第一次刷写特定设备时非常有用.</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">AVD：&nbsp;(android virtual machine):安卓虚拟设备,就是安卓的模拟器</span></span></li><li><span class="name"><span class="innerContentContainer">ADT：&nbsp;(android development tools)安卓开发工具</span></span></li><li><span class="name"><span class="innerContentContainer">DDMS：(dalvik debug monitor service)安卓调试工具</span></span></li><li><span class="name"><span class="innerContentContainer">adb：安卓调试桥,在sdk的platform-tools目录下,功能很多,命令行必备</span></span></li></ul>
  </body>
</html>