<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">14-Camera</span></span><ul><li><span class="name"><span class="innerContentContainer">相机系统框图</span></span><ul><li><span class="name"><span class="innerContentContainer">用户态</span></span><ul><li><span class="name"><span class="innerContentContainer">1. HAL</span></span><ul><li><span class="name"><span class="innerContentContainer">(2) 原始的yuv数据和meta数据发给APP。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Binder通讯</span></span></li><li><span class="name"><span class="innerContentContainer">2. APP</span></span><ul><li><span class="name"><span class="innerContentContainer">(1) 拍照请求发给HAL。</span></span></li><li><span class="name"><span class="innerContentContainer">(3) yuv数据和meta数据发给APS。</span></span></li><li><span class="name"><span class="innerContentContainer">(5) yuv数据发给IPA.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">直接调用</span></span></li><li><span class="name"><span class="innerContentContainer">3. IPA</span></span><ul><li><span class="name"><span class="innerContentContainer">功能</span></span><ul><li><span class="name"><span class="innerContentContainer">HDR</span></span></li><li><span class="name"><span class="innerContentContainer">多帧合成</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">(6) 处理后的JPEG数据传给APP。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Binder通讯</span></span></li><li><span class="name"><span class="innerContentContainer">核心态：4. APS</span></span><ul><li><span class="name"><span class="innerContentContainer">功能</span></span><ul><li><span class="name"><span class="innerContentContainer">美颜</span></span></li><li><span class="name"><span class="innerContentContainer">滤镜</span></span></li><li><span class="name"><span class="innerContentContainer">水印</span></span></li><li><span class="name"><span class="innerContentContainer">贴纸</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">(4) 叠加效果的yuv数据传给APP。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">模式</span></span><ul><li><span class="name"><span class="innerContentContainer">拍照</span></span></li><li><span class="name"><span class="innerContentContainer">录像</span></span></li><li><span class="name"><span class="innerContentContainer">人像</span></span></li><li><span class="name"><span class="innerContentContainer">全景</span></span></li><li><span class="name"><span class="innerContentContainer">夜景</span></span></li><li><span class="name"><span class="innerContentContainer">萌拍</span></span></li><li><span class="name"><span class="innerContentContainer">更多模式方案，3K</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">功能</span></span><ul><li><span class="name"><span class="innerContentContainer">预览</span></span></li><li><span class="name"><span class="innerContentContainer">快门</span></span><ul><li><span class="name"><span class="innerContentContainer">ZSL: Zero Shutter Lag, 零延迟快门</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">文件保存</span></span><ul><li><span class="name"><span class="innerContentContainer">媒体数据库: /data/data/com.andorid.providers.media</span></span><ul><li><span class="name"><span class="innerContentContainer">目录中, extend.db 是外部数据库, internal.db 是内部数据库.</span></span></li><li><span class="name"><span class="innerContentContainer">这两个数据库结构一样, 一般使用外部那个.</span></span></li><li><span class="name"><span class="innerContentContainer">其中表结构如下:</span></span><ul><li><span class="name"><span class="innerContentContainer">Images: 图片信息</span></span></li><li><span class="name"><span class="innerContentContainer">thumbnails: 缩略图信息</span></span></li><li><span class="name"><span class="innerContentContainer">Video: 录像</span></span></li><li><span class="name"><span class="innerContentContainer">Videothumbnails: 录像缩略图</span></span></li><li><span class="name"><span class="innerContentContainer">Andio: 音频信息, 比如一些音乐的专辑, 歌手等信息.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">db文件用 SQLite.exper.professianal 打开.</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">缩略图  <span class="contentTag" title="Filter #面试题">#<span class="contentTagText">面试题</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">预览界面的右下角，显示上一张照片的缩略图。</span></span></li><li><span class="name"><span class="innerContentContainer">它是在上一次拍照时自动生成的。</span></span></li><li><span class="name"><span class="innerContentContainer">如果缩略图文件找不到，则会找当前最晚一张照片自动生成.</span></span></li><li><span class="name"><span class="innerContentContainer">如果一张照片都没有，则显示空白框。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">闪光灯</span></span></li><li><span class="name"><span class="innerContentContainer">锁屏下相机</span></span><ul><li><span class="name"><span class="innerContentContainer">相机是全功能的.</span></span></li><li><span class="name"><span class="innerContentContainer">照片和缩略图有隐私问题。 原则是仅可见本次锁屏拍的照片。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">大数据</span></span><ul><li><span class="name"><span class="innerContentContainer">大数据打点方案，1K</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">效果</span></span><ul><li><span class="name"><span class="innerContentContainer">滤镜</span></span><ul><li><span class="name"><span class="innerContentContainer">滤镜归一方案，3.5K</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">美颜</span></span></li><li><span class="name"><span class="innerContentContainer">广角</span></span></li><li><span class="name"><span class="innerContentContainer">微距</span></span></li><li><span class="name"><span class="innerContentContainer">HDR</span></span><ul><li><span class="name"><span class="innerContentContainer">硬件HDR方案， 1.5K</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">防抖</span></span><ul><li><span class="name"><span class="innerContentContainer">软件防抖：减少曝光时间，加快成像速度。</span></span></li><li><span class="name"><span class="innerContentContainer">物理防抖</span></span></li><li><span class="name"><span class="innerContentContainer">数码防抖</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">虚化</span></span></li><li><span class="name"><span class="innerContentContainer">水印</span></span></li><li><span class="name"><span class="innerContentContainer">降噪</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">屏幕适配</span></span><ul><li><span class="name"><span class="innerContentContainer">长宽比适配</span></span></li><li><span class="name"><span class="innerContentContainer">挖孔屏适配</span></span></li><li><span class="name"><span class="innerContentContainer">升降屏适配</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">第三方相机</span></span><ul><li><span class="name"><span class="innerContentContainer">第一种方案: 使用Camera API定制相机</span></span><ul><li><span class="name"><span class="innerContentContainer">适用于需要定制相机界面或者开发特殊相机功能的场景，如需要对照片做裁剪、滤镜处理，添加贴纸，表情，地点标签等。</span></span></li><li><span class="name"><span class="innerContentContainer">一般使用 Camera API 2. 它可把 exif, rawdata, yuv, jpeg 等格式的数据传送给应用层. Camera API 1 只提供jpeg , 后期处理很受限.</span></span></li><li><span class="name"><span class="innerContentContainer">关键类</span></span><ul><li><span class="name"><span class="innerContentContainer">Camera：最主要的类，用于管理和操作camera资源。它提供了完整的相机底层接口，主要方法有以下这些： <span class="contentTag" title="Filter #面试题">#<span class="contentTagText">面试题</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer"><b>open</b>()：获取camera实例。</span></span></li><li><span class="name"><span class="innerContentContainer">setPrameters(): 设置相机参数，包括前后摄像头，闪光灯模式、聚焦模式、预览和拍照尺寸等。</span></span></li><li><span class="name"><span class="innerContentContainer"><b>setPreviewDisplay</b>(SurfaceHolder)：绑定绘制预览图像的surface。</span></span><ul><li><span class="name"><span class="innerContentContainer">surface是指向屏幕窗口原始图像缓冲区（raw buffer）的一个句柄，通过它可以获得这块屏幕上对应的 canvas，进而完成在屏幕上绘制View的工作。</span></span></li><li><span class="name"><span class="innerContentContainer">通过 surfaceHolder 可以将Camera和 surface连接起来.</span></span></li><li><span class="name"><span class="innerContentContainer">连接后，camera获得的预览帧数据就可以通过surface显示在屏幕上了。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>startPreview</b>(): 开始预览，将camera底层硬件传来的预览帧数据显示在绑定的surface上。</span></span></li><li><span class="name"><span class="innerContentContainer">stopPreview(): 停止预览，关闭camra底层的帧数据传递以及surface上的绘制。</span></span></li><li><span class="name"><span class="innerContentContainer"><b>takePicture</b>(Camera.ShutterCallback shutter, Camera.PictureCallback raw, Camera.PictureCallback jpeg):这个是实现相机拍照的主要方法. 包含了三个回调参数: </span></span><ul><li><span class="name"><span class="innerContentContainer">shutter 是快门按下时的回调，</span></span></li><li><span class="name"><span class="innerContentContainer">raw 是获取拍照原始数据的回调，</span></span></li><li><span class="name"><span class="innerContentContainer">jpeg 是获取经过压缩成jpg格式的图像数据的回调。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">release(): 释放Camera实例</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">SurfaceView: 用于绘制相机预览图像的类，提供给用户实时的预览图像。</span></span><ul><li><span class="name"><span class="innerContentContainer">普通的view以及派生类都是共享同一个surface的，所有的绘制都必须在UI线程中进行。</span></span></li><li><span class="name"><span class="innerContentContainer">而surfaceview是一种比较特殊的view，它并不与其他普通view共享surface，而是在内部持有了一个独立的surface. 因此效率较高.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Surface ：surfaceholder是控制surface的一个抽象接口，它能够控制surface的尺寸和格式，修改surface的像素，监视surface的变化等.</span></span><ul><li><span class="name"><span class="innerContentContainer">surfaceview通过 getHolder() 方法获得surfaceholder 实例，通过后者管理监听surface 的状态。</span></span></li><li><span class="name"><span class="innerContentContainer">SurfaceHolder.Callback接口：负责监听surface状态变化的接口，有三个方法：</span></span></li><li><span class="name"><span class="innerContentContainer"><b>surfaceCreated</b>(SurfaceHolder holder)：在surface创建后立即被调用。在开发自定义相机时，可以通过重载这个函数调用camera.open()、camera.setPreviewDisplay()，来实现获取相机资源、连接camera和surface等操作。</span></span></li><li><span class="name"><span class="innerContentContainer"><b>surfaceChanged</b>(SurfaceHolder holder, int format, int width, int height):在surface发生format或size变化时调用。在开发自定义相机时，可以通过重载这个函数调用camera.startPreview来开启相机预览，使得camera预览帧数据可以传递给surface，从而实时显示相机预览图像。</span></span></li><li><span class="name"><span class="innerContentContainer"><b>surfaceDestroyed</b>(SurfaceHolder holder)：在surface销毁之前被调用。在开发自定义相机时，可以通过重载这个函数调用camera.stopPreview()，camera.release()来实现停止相机预览及释放相机资源等操作。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">自定义相机的步骤</span></span><ul><li><span class="name"><span class="innerContentContainer">1: 创建相机</span></span><ul><li><span class="name"><span class="innerContentContainer">private Camera getCamera() {</span></span><ul><li><span class="name"><span class="innerContentContainer">//获取Camera 注意导包正确 </span></span></li><li><span class="name"><span class="innerContentContainer">Camera camera = null; </span></span></li><li><span class="name"><span class="innerContentContainer">try {</span></span><ul><li><span class="name"><span class="innerContentContainer">camera = Camera.open();</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">} catch (Exception e) {</span></span><ul><li><span class="name"><span class="innerContentContainer">e.printStackTrace(); </span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">} </span></span></li><li><span class="name"><span class="innerContentContainer">return camera;</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">} </span></span></li><li><span class="name"><span class="innerContentContainer">private Camera mCamera;</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">2: 创建SurfaceView</span></span><ul><li><span class="name"><span class="innerContentContainer">mSurface = (SurfaceView) findViewById(R.id.preview);</span></span></li><li><span class="name"><span class="innerContentContainer">mHolder.addCallback(this);</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">3: 关联相机和SurfaceView</span></span><ul><li><span class="name"><span class="innerContentContainer">mHolder = mSurface.getHolder();</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">4: 调整相机的显示效果</span></span><ul><li><span class="name"><span class="innerContentContainer">public void capture(View v) {</span></span><ul><li><span class="name"><span class="innerContentContainer">// 获取当前照相机参数</span></span></li><li><span class="name"><span class="innerContentContainer">Camera.Parameters parameters = mCamera.getParameters();</span></span></li><li><span class="name"><span class="innerContentContainer">// 设置参数</span></span></li><li><span class="name"><span class="innerContentContainer">parameters.setPictureFormat(ImageFormat.JPEG);</span></span></li><li><span class="name"><span class="innerContentContainer">//设置照片格式</span></span></li><li><span class="name"><span class="innerContentContainer">parameters.setPictureSize(800, 400);</span></span></li><li><span class="name"><span class="innerContentContainer">//设置大小</span></span></li><li><span class="name"><span class="innerContentContainer">parameters.setFocusMode(Camera.Parameters.FLASH_MODE_AUTO);</span></span></li><li><span class="name"><span class="innerContentContainer">//设置对焦回调函数, 设置对焦模式</span></span></li><li><span class="name"><span class="innerContentContainer">mCamera.autoFocus(new Camera.AutoFocusCallback() {</span></span><ul><li><span class="name"><span class="innerContentContainer">public void onAutoFocus(boolean success, Camera camera) {</span></span><ul><li><span class="name"><span class="innerContentContainer">if (success) {</span></span><ul><li><span class="name"><span class="innerContentContainer">//当对焦成功时获取图片</span></span></li><li><span class="name"><span class="innerContentContainer">mCamera.takePicture(null, null, mPictureCallback);</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">});</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">微信、支付宝、美颜等头部应用用这种方案。三方适配问题由HAL负责。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">第二种方案: 通过Intent调用系统相机</span></span><ul><li><span class="name"><span class="innerContentContainer">这种方法快速方便，适用于直接获得照片的场景，如上传相册，微博、朋友圈发照片等。</span></span></li><li><span class="name"><span class="innerContentContainer">启动Camera的两种方式</span></span><ul><li><span class="name"><span class="innerContentContainer">直接在intent中指定应用程序的包名（前提是知道完整的包名）</span></span></li><li><span class="name"><span class="innerContentContainer">使用隐式intent的方式来启动包名</span></span><ul><li><span class="name"><span class="innerContentContainer">Intent camera = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);</span></span></li><li><span class="name"><span class="innerContentContainer">startActivity(camera);</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">拍照完成之后获取图片</span></span><ul><li><span class="name"><span class="innerContentContainer">第一种方式, 直接通过data中获取，但得到的照片是缩略图</span></span><ul><li><span class="name"><span class="innerContentContainer">protected void onActivityResult(int requestCode, int resultCode, Intent data) { </span></span><ul><li><span class="name"><span class="innerContentContainer">super.onActivityResult(requestCode, resultCode, data); </span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">第二种方式</span></span><ul><li><span class="name"><span class="innerContentContainer">step1: 获取文件保存路径</span></span></li><li><span class="name"><span class="innerContentContainer">private String mFilePath; // 定义sd卡路径</span></span></li><li><span class="name"><span class="innerContentContainer">protected void onCreate(Bundle savedInstanceState) {</span></span><ul><li><span class="name"><span class="innerContentContainer">super.onCreate(savedInstanceState);</span></span></li><li><span class="name"><span class="innerContentContainer">setContentView(R.layout.activity_main);</span></span></li><li><span class="name"><span class="innerContentContainer">mFilePath = Environment.getExternalStorageDirectory().getPath();  // 获得sd卡路径</span></span></li><li><span class="name"><span class="innerContentContainer">mFilePath = mFilePath + "/" + "temp.png";</span></span></li><li><span class="name"><span class="innerContentContainer">init();</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li><li><span class="name"><span class="innerContentContainer">step2: 启动相机</span></span></li><li><span class="name"><span class="innerContentContainer">Intent camera2 = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);</span></span></li><li><span class="name"><span class="innerContentContainer">Uri photoUri = Uri.fromFile(new File(mFilePath));</span></span></li><li><span class="name"><span class="innerContentContainer">camera2.putExtra(MediaStore.EXTRA_OUTPUT, photoUri);</span></span></li><li><span class="name"><span class="innerContentContainer">startActivityForResult(camera2, REQ_2);  // 通过返回requestCode来读取相机照片</span></span></li><li><span class="name"><span class="innerContentContainer">step3: 获取文件流，并转换为bitmap显示出来</span></span></li><li><span class="name"><span class="innerContentContainer">FileInputStream fis = null;</span></span></li><li><span class="name"><span class="innerContentContainer">try {</span></span><ul><li><span class="name"><span class="innerContentContainer">// 将文件转换成Bitmap </span></span></li><li><span class="name"><span class="innerContentContainer">fis = new FileInputStream(mFilePath); </span></span></li><li><span class="name"><span class="innerContentContainer">Bitmap bitmap = BitmapFactory.decodeStream(fis); </span></span></li><li><span class="name"><span class="innerContentContainer">iv_photo.setImageBitmap(bitmap); </span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">} catch (FileNotFoundException e) {</span></span><ul><li><span class="name"><span class="innerContentContainer"> e.printStackTrace(); </span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">} finally {</span></span><ul><li><span class="name"><span class="innerContentContainer">try { </span></span><ul><li><span class="name"><span class="innerContentContainer">fis.close();</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">} catch (IOException e) {</span></span><ul><li><span class="name"><span class="innerContentContainer">e.printStackTrace(); </span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li></ul></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">相机问题debug  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">Home键问题   <span class="contentTag" title="Filter #面试题">#<span class="contentTagText">面试题</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">为了让用户感觉拍照快，现在手机相机都是缩略图生成后就提示用户拍照关闭。</span></span></li><li><span class="name"><span class="innerContentContainer">这样就存在一个风险：用户看到拍照关闭，就按home键退出相机，而在Acticity的onPause中，会销毁相机资源，这样会导致大图没有生成。</span></span></li><li><span class="name"><span class="innerContentContainer">解决办法是把大图生成放在 service中。可在后台慢慢保存。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">闪烁问题</span></span><ul><li><span class="name"><span class="innerContentContainer">一般是动画没处理好导致.</span></span></li><li><span class="name"><span class="innerContentContainer">切换分辨率等操作时, 蒙版消失得太早导致闪烁.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">预览性能低导致卡顿、拖影  <span class="contentTag" title="Filter #面试题">#<span class="contentTagText">面试题</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">预览至少要达到30帧，最好达到60帧。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">相机功耗高的解决方法  <span class="contentTag" title="Filter #面试题">#<span class="contentTagText">面试题</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">降低帧率</span></span></li><li><span class="name"><span class="innerContentContainer">通过OpenGL画预览界面。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">花屏</span></span><ul><li><span class="name"><span class="innerContentContainer">效果之间产生冲突导致. 比如HDR和滤镜</span></span></li><li><span class="name"><span class="innerContentContainer">底层问题</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">裂屏</span></span><ul><li><span class="name"><span class="innerContentContainer">LCD自身刷新（Refresh：从GRAM中读取数据往屏上刷）和MDP的数据刷新（update：将数据从EBI2送到GRAM中）没有同步。</span></span></li><li><span class="name"><span class="innerContentContainer">分为两种情况：</span></span><ul><li><span class="name"><span class="innerContentContainer">LCD的Refresh rate小于MDP的update rate时，可能出现数据丢失的现象，即LCD还没有刷新完一帧，MDP就已经将GRAM中的数据更新了。</span></span></li><li><span class="name"><span class="innerContentContainer">LCD的Refresh rate大于MDP的update rate时，可能出现同一数据重复刷新的现象。</span></span><ul><li><span class="name"><span class="innerContentContainer">当一帧的数据一部分是新的，一部分是旧的时，就可能出现裂屏。</span></span></li><li><span class="name"><span class="innerContentContainer">这是主要情况。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">偏红偏绿问题</span></span><ul><li><span class="name"><span class="innerContentContainer">效果问题，找turning团队。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">拉伸变形问题</span></span><ul><li><span class="name"><span class="innerContentContainer">SurfaceView、PreviewSize、PictureSize三个尺寸不一致.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">管灯下的 flick 问题</span></span><ul><li><span class="name"><span class="innerContentContainer">flick问题即照片上的明暗条纹。</span></span></li><li><span class="name"><span class="innerContentContainer">原因是我们用的管灯一般以50hz或60hz的频率来闪烁。当sensor以行为定位曝光时，如果存在灯管的波峰位置，光强度大，就比较明亮。反之则暗淡。</span></span></li><li><span class="name"><span class="innerContentContainer">解决方案: 保证每一次曝光都会在1/100的整数倍的话，则每部分的光能都一样，就不会有flick出现。</span></span><ul><li><span class="name"><span class="innerContentContainer">代码：camera_antibanding_type。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">照片数据格式  <span class="contentTag" title="Filter #面试题">#<span class="contentTagText">面试题</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">JPEG</span></span><ul><li><span class="name"><span class="innerContentContainer">最常见的图像的有损压缩格式。</span></span></li><li><span class="name"><span class="innerContentContainer">低分辨率sensor，一般自带JPEG engine，可以直接输出JPEG。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">YUV</span></span><ul><li><span class="name"><span class="innerContentContainer">uma (Y) + chroma (UV) 格式。</span></span></li><li><span class="name"><span class="innerContentContainer">常见sensor都支持 YUV422格式，即数据格式是按Y-U-Y-V次序输出的。</span></span></li><li><span class="name"><span class="innerContentContainer">一个像素占2B。如果像素太高可能芯片处理不过来。</span></span></li><li><span class="name"><span class="innerContentContainer">YUV输出亮度信号没有任何损失，而色偏信号人眼并不是特别敏感，所以YUV图像质量和稳定性较好。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">RGB</span></span><ul><li><span class="name"><span class="innerContentContainer">传统的红绿蓝格式。</span></span></li><li><span class="name"><span class="innerContentContainer">比如RGB565，其16-bit数据格式为5b R + 6b G + 5b B。G多一位，原因是人眼对绿色比较敏感。</span></span></li><li><span class="name"><span class="innerContentContainer">RGB可直接往屏幕上刷。</span></span></li><li><span class="name"><span class="innerContentContainer">RGB565 会丢掉很多原始信息，所以图像质量和稳定性较差。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Bayer</span></span><ul><li><span class="name"><span class="innerContentContainer">也就是raw data。</span></span></li><li><span class="name"><span class="innerContentContainer">sensor的每一像素对应一个彩色滤光片，滤光片按Bayer pattern分布。参见“Bayer阵列”。</span></span></li><li><span class="name"><span class="innerContentContainer">将每一个像素的数据直接输出，即RAW RGB data.</span></span></li><li><span class="name"><span class="innerContentContainer">每个像素就1B，数据量要少很多。</span></span></li><li><span class="name"><span class="innerContentContainer">一般5M以上sensor就只输出RAW数据，以保证比较快的输出速度，后端挂一个DSP来处理输出的数据。</span></span></li></ul></li></ul></li><li><span class="name"></span></li><li><span class="name"><span class="innerContentContainer">CameraDriver</span></span><ul><li><span class="name"><span class="innerContentContainer">模组硬件结构</span></span><ul><li><span class="name"><span class="innerContentContainer">Lens(镜头）</span></span><ul><li><span class="name"><span class="innerContentContainer">Lens一般有个Hold(座）作支撑。</span></span></li><li><span class="name"><span class="innerContentContainer">镜头有玻璃和塑料两种。</span></span></li><li><span class="name"><span class="innerContentContainer">玻璃的透光率高，折射率低，成像效果好，但比较贵；塑料则相反。</span></span></li><li><span class="name"><span class="innerContentContainer">塑料还有个优势，它是非球面的，可校正畸变。</span></span></li><li><span class="name"><span class="innerContentContainer">一般令两者组合，常见1G3P(1片玻璃 + 3片塑料）。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">分色滤色片（2R Cut)</span></span><ul><li><span class="name"><span class="innerContentContainer">为何要分色？</span></span></li><li><span class="name"><span class="innerContentContainer">因为Sensor上每个像素只能识别一种颜色，所以需要把射入的光线过滤。有两种：</span></span></li><li><span class="name"><span class="innerContentContainer">RGB原色分色法。</span></span></li><li><span class="name"><span class="innerContentContainer">CMYK补色分色法，由青、洋红、黄、黑四种，但颜色不如RGB。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">感光Sensor</span></span><ul><li><span class="name"><span class="innerContentContainer">是一种半导体芯片，其表面含有几十万到几百万的光电二极管。有两种：</span></span></li><li><span class="name"><span class="innerContentContainer">CCD</span></span><ul><li><span class="name"><span class="innerContentContainer">工艺较成熟，生成稳定。</span></span></li><li><span class="name"><span class="innerContentContainer">以G-R-G-B型CCD为例，4个感光单元的中心点构成一个“像素点”，每个感光单元的光值复用了4次（边缘单元除外），所以每4个感光单元计算出4个信号。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">CMOS</span></span><ul><li><span class="name"><span class="innerContentContainer">被认为是未来的成像器材。</span></span></li><li><span class="name"><span class="innerContentContainer">成本低，速度快，功耗低。</span></span></li><li><span class="name"><span class="innerContentContainer">但目前工艺不成熟，坏点率较高，无法满足高分辨率的要求。</span></span></li><li><span class="name"><span class="innerContentContainer">其特点是一个感光单元对应一个像素。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">光电二极管的原理</span></span><ul><li><span class="name"><span class="innerContentContainer">P-N反向充电，在光照下放电，通过检测剩余电荷数量而得到光强信号。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Bayer阵列</span></span><ul><li><span class="name"><span class="innerContentContainer">bayer格式图片是伊士曼·柯达公司科学家Bryce&nbsp;Bayer发明的，拜耳阵列被广泛运用数字图像。</span></span></li><li><span class="name"><span class="innerContentContainer">如果每个像素都采样RGB3种颜色，则需要3块滤镜，且要保证滤镜严格对齐，代码非常大。</span></span></li><li><span class="name"><span class="innerContentContainer">Bayer注意到人眼对彩色的响应带宽不高，精细度不够的特点，采用每个像素只采样一种颜色，其它颜色使用周围像素的颜色。</span></span></li><li><span class="name"><span class="innerContentContainer">在采样时，奇数行分别采用R、G、R、G，偶数行分别采样G、B、G、B。</span></span><ul><li><span class="name"><span class="innerContentContainer">G的采样数量是RB的和，因为人眼对绿光最敏感。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">这样，一个像素的R、G、B数据将由相邻的4个感光单元构成。</span></span></li><li><span class="name"><span class="innerContentContainer">这种采样方式，在基本不降低<b>感官图像质量</b>的前提下，可以将数据量降低60%以上。</span></span></li><li><span class="name"><span class="innerContentContainer">相机sensor基本上用的都是Bayer阵列。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">FPC(柔板）</span></span><ul><li><span class="name"><span class="innerContentContainer">连接器。一般手机camera分前后置，会有比较长的连接线。</span></span></li><li><span class="name"><span class="innerContentContainer">CPU到camera的连线有：</span></span><ul><li><span class="name"><span class="innerContentContainer">Vdd（供电）</span></span></li><li><span class="name"><span class="innerContentContainer">mCLK（时钟源）</span></span><ul><li><span class="name"><span class="innerContentContainer">设置为24M</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">camera到CPU的连线有：</span></span><ul><li><span class="name"><span class="innerContentContainer">同步线有3根：</span></span><ul><li><span class="name"><span class="innerContentContainer">pCLK</span></span><ul><li><span class="name"><span class="innerContentContainer">pCLK传输一个像素点后click一次</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">hsync</span></span><ul><li><span class="name"><span class="innerContentContainer">hsync传输1行click一次</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">vsync</span></span><ul><li><span class="name"><span class="innerContentContainer">vsync传输一帧click一次</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">data线有8或10根</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">vfe：图像前端处理</span></span><ul><li><span class="name"><span class="innerContentContainer">camera同步线和数据线都直接连接vfe。这是一个关键的DSP芯片。</span></span></li><li><span class="name"><span class="innerContentContainer">vfe主要功能是处理白平衡、去边、去坏点、调节锐度、插值。</span></span></li><li><span class="name"><span class="innerContentContainer">驱动代码通过I2C总线给vfe传递camera配置参数。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Interface（总线）</span></span><ul><li><span class="name"><span class="innerContentContainer">并口</span></span><ul><li><span class="name"><span class="innerContentContainer">中低端相机用得多。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">MIPI</span></span><ul><li><span class="name"><span class="innerContentContainer">高像素camera中更常见。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">I2C</span></span></li><li><span class="name"><span class="innerContentContainer">Power</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">camera结构设计问题  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">成像方向</span></span><ul><li><span class="name"><span class="innerContentContainer">翻转90度</span></span></li><li><span class="name"><span class="innerContentContainer">翻转180度</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">视场角</span></span></li><li><span class="name"><span class="innerContentContainer">焦距</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">常见硬件问题  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">驱动能力不足或过大；</span></span></li><li><span class="name"><span class="innerContentContainer">上下电时序不满足规格，导致点不亮、裂屏、噪点多。</span></span></li><li><span class="name"><span class="innerContentContainer">I2C地址冲突。不同型号camera用不同地址。</span></span></li><li><span class="name"><span class="innerContentContainer">连接器选择和线序有问题。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">PCB设计review要点  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">AVDD和AGND走线要严格：同层包地，相邻层不能有高速线（clk、data、sync），AVDD线宽要保证150mA的过流能力。AVDD干扰易引起camera条纹。</span></span></li><li><span class="name"><span class="innerContentContainer">pclk和mclk要全程包地，相邻层要避免影响射频信号。</span></span></li><li><span class="name"><span class="innerContentContainer">mclk匹配电阻靠近平台芯片，pclk匹配电阻靠近camera。这叫源端匹配原理。</span></span></li><li><span class="name"><span class="innerContentContainer">I2C两根线走在一起，外侧包地。</span></span></li><li><span class="name"><span class="innerContentContainer">hsync和vsync尽量包地。</span></span></li><li><span class="name"><span class="innerContentContainer">各电源的滤波电容应尽量靠近camera的电源引脚。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">camera 点亮步骤</span></span><ul><li><span class="name"><span class="innerContentContainer">按sensor spec的上电电压和时序上电，包括reset和shutdown配置。</span></span></li><li><span class="name"><span class="innerContentContainer">建立I2C通讯，保证slave地址正确，保证地址和数据宽度正确。</span></span></li><li><span class="name"><span class="innerContentContainer">初始化成功后，就应该有图像了。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">数据处理过程</span></span><ul><li><span class="name"><span class="innerContentContainer">sensor来的数据通过vfe的处理后，输出yuv格式的数据到内存中。</span></span></li><li><span class="name"><span class="innerContentContainer">内存一般为系统开机就预分配的PMEM，大小一般为36MB。</span></span></li><li><span class="name"><span class="innerContentContainer">后面的处理分为两条线：</span></span><ul><li><span class="name"><span class="innerContentContainer">如果是预览，则数据会送给 mdsp，通过overlay技术显示在屏幕上。</span></span></li><li><span class="name"><span class="innerContentContainer">如果是拍照，则送到 adsp（video core）编码为jpeg格式，然后送到文件系统保存。</span></span></li><li><span class="name"><span class="innerContentContainer">如果是录像，则两条线都送。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Camera HAL代码</span></span><ul><li><span class="name"><span class="innerContentContainer">托管代码通过jni接口调用本地代码的c interface 层。</span></span></li><li><span class="name"><span class="innerContentContainer">interface 层通过IPC方式调用camera service层。</span></span></li><li><span class="name"><span class="innerContentContainer">service层以下则为hal层，包括google hal和qcom hal两层。</span></span></li><li><span class="name"><span class="innerContentContainer">qcom hal层通过syscall方式调用核心态代码，即camera driver。</span></span></li><li><span class="name"><span class="innerContentContainer">由于相机涉及到知识产权较密集，所以核心代码都在HAL层。driver中的代码很少。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">google native代码</span></span><ul><li><span class="name"><span class="innerContentContainer">jni层代码</span></span><ul><li><span class="name"><span class="innerContentContainer">framework/base/core_java/android/hardware/camera.java，../jni/android_hardware_camera.cpp。编译成 libandroid_runtime.so。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">framework层</span></span><ul><li><span class="name"><span class="innerContentContainer">framework/base/camera/libcameraservice/cameraservice.cpp。编译 libcameraservice.so。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">HAL层</span></span><ul><li><span class="name"><span class="innerContentContainer">framework/base/libs/ui/camera.cpp, ../ICamera.cpp, ../ICameraClient.cpp, ../ICameraService.cpp, 编译成 libui.so。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">高通native代码</span></span><ul><li><span class="name"><span class="innerContentContainer">代码位置： 也是按照camera型号组织的，比如：vendor/qcom/proprietany/mm_camera/targets/tgtcommon/sensor/ov5647_sunny/。</span></span></li><li><span class="name"><span class="innerContentContainer">3A代码路径：vendor/.../tgtcommon/isp3a</span></span></li><li><span class="name"><span class="innerContentContainer">效果代码路径：/chrometix_ov6547_sunny_preview.h</span></span></li><li><span class="name"><span class="innerContentContainer">特效代码路径：vendor/.../futhers/bestshot/</span></span></li><li><span class="name"><span class="innerContentContainer">闪光灯代码路径：vendor/.../flash/</span></span></li><li><span class="name"><span class="innerContentContainer">变焦代码路径：vendor/.../zoom/</span></span></li><li><span class="name"><span class="innerContentContainer">vfe代码路径：vendor/.../targets/vef31/7x30/vfe_porview.c, vfe_proc_msg_evt.c</span></span></li><li><span class="name"><span class="innerContentContainer">接口层： hardware/qcom/camera/QualcommCameraHardware.cpp</span></span></li><li><span class="name"><span class="innerContentContainer">初始化流程：</span></span><ul><li><span class="name"><span class="innerContentContainer">open /dev/msm_camera；</span></span></li><li><span class="name"><span class="innerContentContainer">load liboemcamera.so；</span></span></li><li><span class="name"><span class="innerContentContainer">生成三个线程：control、config、frame。</span></span><ul><li><span class="name"><span class="innerContentContainer">这个明显是和driver的三个内核设备对应。</span></span></li><li><span class="name"><span class="innerContentContainer">容易出问题的是config线程，它负责配置3A。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">预览流程</span></span><ul><li><span class="name"><span class="innerContentContainer">注册pmem；</span></span></li><li><span class="name"><span class="innerContentContainer">创建frame线程；</span></span></li><li><span class="name"><span class="innerContentContainer">下发 start_preview命令；</span></span></li><li><span class="name"><span class="innerContentContainer">唤醒config线程；</span></span></li><li><span class="name"><span class="innerContentContainer">从frame线程获取数据，显示在overlay中。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Camera driver</span></span><ul><li><span class="name"><span class="innerContentContainer">代码在kernel/drivers/media/video/msm。</span></span></li><li><span class="name"><span class="innerContentContainer">文件按camera型号和总线类型排列，比如 ov5647_sunny.c等。接口在 msm_camera.h。</span></span></li><li><span class="name"><span class="innerContentContainer">driver 代码包括如下3部分：</span></span></li><li><span class="name"><span class="innerContentContainer">vfe driver</span></span></li><li><span class="name"><span class="innerContentContainer">flash driver（闪光灯）</span></span></li><li><span class="name"><span class="innerContentContainer">sensor driver（重点）</span></span><ul><li><span class="name"><span class="innerContentContainer">camera驱动采用平台设备模型。初始化流程如下：</span></span></li><li><span class="name"><span class="innerContentContainer">首先是platform_device结构，包括 name、data 等字段，然后放在devices[]数组中。</span></span><ul><li><span class="name"><span class="innerContentContainer">可以通过adb cat /dev/platform/msm_camera_s5k4 看到其中的一些参数。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">其次是 platform_driver结构，包括 name、open、probe等字段。camera_start()调用时，会将device和driver通过name字段对应上。</span></span></li><li><span class="name"><span class="innerContentContainer">识别camera类型，加载对应driver过程。</span></span></li><li><span class="name"><span class="innerContentContainer">初始化的重点是probe()函数，主要完成如下工作：</span></span><ul><li><span class="name"><span class="innerContentContainer">alloc_chrdev_region：分配字符设备号，一次性分配15个；</span></span></li><li><span class="name"><span class="innerContentContainer">置gpio、时钟；</span></span></li><li><span class="name"><span class="innerContentContainer">驱动I2C；</span></span></li><li><span class="name"><span class="innerContentContainer">上电、配置mclk；</span></span></li><li><span class="name"><span class="innerContentContainer">通过I2C读取camera id；</span></span></li><li><span class="name"><span class="innerContentContainer">申请三个内核设备节点：</span></span><ul><li><span class="name"><span class="innerContentContainer">/dev/msm_camera/control、config、frame。如果有前后camera，则有6个，即control0和control1，config0和config1，frame0和frame1。</span></span></li><li><span class="name"><span class="innerContentContainer">control节点负责提供命令接口，比如打开设备/关闭设备/拍照/预览。通过I2C发给vfe芯片，然后vfe芯片再按定义的方式转给sensor。</span></span></li><li><span class="name"><span class="innerContentContainer">config节点负责提供配置camera的接口，主要是处理3A：AF（自动对焦）、AES（自动曝光）、AWB（自动白平衡）。</span></span></li><li><span class="name"><span class="innerContentContainer">frame节点负责提供数据通道。注意这个点得到的数据是vfe输出的，格式为yuv。raw data数据软件是得不到的。</span></span></li></ul></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">拍照相关的内存使用</span></span><ul><li><span class="name"><span class="innerContentContainer">预览使用的是preview buffer；</span></span></li><li><span class="name"><span class="innerContentContainer">拍照过程用两块</span></span><ul><li><span class="name"><span class="innerContentContainer">缩略图用thumbail buffer</span></span></li><li><span class="name"><span class="innerContentContainer">照片用 spark shot buffer</span></span></li><li><span class="name"><span class="innerContentContainer">这两块都来自pmem。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Camera测试环境</span></span><ul><li><span class="name"><span class="innerContentContainer">标准灯箱</span></span></li><li><span class="name"><span class="innerContentContainer">色卡</span></span></li><li><span class="name"><span class="innerContentContainer">测试分辨率的chart（可破插值算法）</span></span></li><li><span class="name"><span class="innerContentContainer">软件photoshop</span></span></li><li><span class="name"><span class="innerContentContainer">照度计</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">手机相机各各摄影头是干啥的?</span></span><ul><li><span class="name"><span class="innerContentContainer">双摄</span></span><ul><li><span class="name"><span class="innerContentContainer">主摄: 广角</span></span></li><li><span class="name"><span class="innerContentContainer">次摄: 长焦, 实现光学变焦.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">三摄</span></span><ul><li><span class="name"><span class="innerContentContainer">主摄: 广角</span></span></li><li><span class="name"><span class="innerContentContainer">黑白镜头</span></span></li><li><span class="name"><span class="innerContentContainer">长焦, 实现景深, 虚化</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">四摄</span></span><ul><li><span class="name"><span class="innerContentContainer">主摄</span></span></li><li><span class="name"><span class="innerContentContainer">变焦镜头</span></span></li><li><span class="name"><span class="innerContentContainer">超广角</span></span></li><li><span class="name"><span class="innerContentContainer">景深辅助</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">五摄</span></span><ul><li><span class="name"><span class="innerContentContainer">主摄</span></span></li><li><span class="name"><span class="innerContentContainer">长焦</span></span></li><li><span class="name"><span class="innerContentContainer">广角</span></span></li><li><span class="name"><span class="innerContentContainer">深度</span></span></li><li><span class="name"><span class="innerContentContainer">未知功能</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Tuning</span></span><ul><li><span class="name"><span class="innerContentContainer">调整camera各个模块的参数，使其在当前的环境下能够获得一个比较好的成像效果。</span></span></li><li><span class="name"><span class="innerContentContainer">Tuning主要有两大块：3A和ISP</span></span></li><li><span class="name"><span class="innerContentContainer">3A: 即AWB, AE, AF的统称。  <span class="contentTag" title="Filter #面试题">#<span class="contentTagText">面试题</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">AWB：自动白平衡</span></span><ul><li><span class="name"><span class="innerContentContainer">百平衡的本质是使白色物体在任何光源下都显示白色。</span></span></li><li><span class="name"><span class="innerContentContainer">一般的算法是通过调节白平衡增益，使拍照画面的颜色接近物体真实的颜色，增益调节的依据是环境光源的色温。</span></span></li><li><span class="name"><span class="innerContentContainer">AWB算法的步骤：</span></span></li><li><span class="name"><span class="innerContentContainer">1. 估计环境光色温。算法包括：</span></span><ul><li><span class="name"><span class="innerContentContainer">灰度世界假设算法</span></span><ul><li><span class="name"><span class="innerContentContainer">假设一幅图片其颜色分量的均值G，R，B，趋向于同一灰度下。</span></span></li><li><span class="name"><span class="innerContentContainer">在图像色彩分布均匀时，该算法效果较好。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">白色块假设算法</span></span><ul><li><span class="name"><span class="innerContentContainer">假设图像上最亮的点是白色的。以此为基准进行色温估计。</span></span></li><li><span class="name"><span class="innerContentContainer">实际效果不好。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">2. 计算增益并调节</span></span><ul><li><span class="name"><span class="innerContentContainer">最简单的方法是通过求取图像的平均颜色分量对应的增益：</span></span><ul><li><span class="name"><span class="innerContentContainer">α = G / R， β = G / B</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">然后对整幅图的RGB进行调整：</span></span><ul><li><span class="name"><span class="innerContentContainer">R = αR</span></span></li><li><span class="name"><span class="innerContentContainer">G = G</span></span></li><li><span class="name"><span class="innerContentContainer">B = βB</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">如何获得白平衡参数？</span></span><ul><li><span class="name"><span class="innerContentContainer">在无自然光的实验室中，利用光源设备产生4种标准光源，</span></span></li><li><span class="name"><span class="innerContentContainer">在光源下对标准色板进行拍照；再用软件分析照片的<b>色偏</b>，就可以得到一组参数。</span></span></li><li><span class="name"><span class="innerContentContainer">通过这种参数的校准，尽量将拍出的照片和标准照片一样。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">AE：自动曝光</span></span><ul><li><span class="name"><span class="innerContentContainer">自动曝光是为了使感光器件获得合适的曝光量。</span></span></li><li><span class="name"><span class="innerContentContainer">一般的算法是通过获取图像的亮度调节调节相应的曝光参数，得到合适的曝光量。</span></span></li><li><span class="name"><span class="innerContentContainer">曝光参数包括：</span></span><ul><li><span class="name"><span class="innerContentContainer">光圈大小</span></span></li><li><span class="name"><span class="innerContentContainer">快门速度</span></span></li><li><span class="name"><span class="innerContentContainer">摄影头传感器的亮度增益</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">AE算法的步骤是：</span></span></li><li><span class="name"><span class="innerContentContainer">1. 获取图像亮度。算法是：</span></span><ul><li><span class="name"><span class="innerContentContainer">平均亮度</span></span></li><li><span class="name"><span class="innerContentContainer">分区加权平均亮度： 加权即加大屏幕中心的权重，目的是把重点放在中心。</span></span></li><li><span class="name"><span class="innerContentContainer">设置不同亮度门限，对背光、正光、强光区域进行区分。</span></span></li><li><span class="name"><span class="innerContentContainer">对主要对象（比如人脸）进行曝光补偿。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">2. 调整参数。算法有：</span></span><ul><li><span class="name"><span class="innerContentContainer">查表法：系统预置一张曝光参数调整的步长和图像亮度之间的对应表。</span></span></li><li><span class="name"><span class="innerContentContainer">迭代法</span></span></li><li><span class="name"><span class="innerContentContainer">数值计算法</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">AF：自动对焦</span></span><ul><li><span class="name"><span class="innerContentContainer">自动对焦即自动调节摄影头焦距以获得当前图像的最清晰图像的过程。</span></span></li><li><span class="name"><span class="innerContentContainer">常见的AF算法是对焦深度法（DFF），主要步骤是：</span></span></li><li><span class="name"><span class="innerContentContainer">1. 判断图像的模糊程度，通过模糊度评价函数得到每一帧的模糊值。评价函数有很多种，主要考虑因素是:</span></span><ul><li><span class="name"><span class="innerContentContainer">图像频率。清晰的图像纹理多，高频分布较多；</span></span></li><li><span class="name"><span class="innerContentContainer">图像的灰度分布。图像对应的灰度图的分量分布范围越大，说明图像细节越多，图像越清晰。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">2. 通过检索算法得到一系列模糊值的峰值.</span></span><ul><li><span class="name"><span class="innerContentContainer">爬山算法。检索窗口有黄金分割点、对焦嵌套窗口等。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">3. 通过电机驱动镜头调节到峰值位置。</span></span></li><li><span class="name"><span class="innerContentContainer">算法的关键是达到准确度和速度的平衡。</span></span></li><li><span class="name"><span class="innerContentContainer">其它AF算法还有 对比度法和相位法。</span></span></li><li><span class="name"><span class="innerContentContainer">自动对焦的关键是测距。测距首先要确认镜头中的主要对象。</span></span><ul><li><span class="name"><span class="innerContentContainer">如何识别照片中的主要对象？</span></span></li><li><span class="name"><span class="innerContentContainer">当我们把一个画面的光线数据通过傅里叶变换到向量空间时，会发现画面中有明显轮廓的位置都是一个高频区域。通过这点，我们就可以达到目标。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">主动式自动对焦</span></span><ul><li><span class="name"><span class="innerContentContainer">相机上的红外线发生器、超声波发生器发出红外光或超声波到被摄体。</span></span></li><li><span class="name"><span class="innerContentContainer">可以用于细线条物体和动体，也可以在低反差，弱光下对焦。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">被动式自动对焦</span></span><ul><li><span class="name"><span class="innerContentContainer">接受景物自身的反光。</span></span></li><li><span class="name"><span class="innerContentContainer">优点：不要发射系统，耗能小，易小型化。可以在逆光下或透过玻璃对焦。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">ISP</span></span><ul><li><span class="name"><span class="innerContentContainer">坏点校准和降噪</span></span><ul><li><span class="name"><span class="innerContentContainer">坏点和噪点，都会在图像上产生错误的颜色点。</span></span></li><li><span class="name"><span class="innerContentContainer">坏点是成像芯片上的物理损坏，会在每张图像上出现，一般不超过3个。</span></span></li><li><span class="name"><span class="innerContentContainer">噪点则和芯片的稳定性有关，属于成像各环节出现的噪音信号，在图像上可能会成片出现。</span></span></li><li><span class="name"><span class="innerContentContainer">噪点可以通过后期处理去掉。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">颜色校正</span></span></li><li><span class="name"><span class="innerContentContainer">伽马校正（Gamma Correction）</span></span><ul><li><span class="name"><span class="innerContentContainer">非常复杂的概念。参见： 我理解的伽马校正： https://blog.csdn.net/candycat1992/article/details/46228771</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">边缘锐化（Edge&nbsp;Enhancement）</span></span><ul><li><span class="name"><span class="innerContentContainer">加强影像的边缘对比度。</span></span></li><li><span class="name"><span class="innerContentContainer">在视觉上，具有清晰边界的影像较受用户喜爱。</span></span></li></ul></li></ul></li></ul></li></ul>
  </body>
</html>