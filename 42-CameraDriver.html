<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">42-CameraDriver</span></span><ul><li><span class="name"><span class="innerContentContainer">模组硬件结构</span></span><ul><li><span class="name"><span class="innerContentContainer">Lens(镜头）</span></span><ul><li><span class="name"><span class="innerContentContainer">Lens一般有个Hold(座）作支撑。</span></span></li><li><span class="name"><span class="innerContentContainer">镜头有玻璃和塑料两种。</span></span></li><li><span class="name"><span class="innerContentContainer">玻璃的透光率高，折射率低，成像效果好，但比较贵；塑料则相反。</span></span></li><li><span class="name"><span class="innerContentContainer">塑料还有个优势，它是非球面的，可校正畸变。</span></span></li><li><span class="name"><span class="innerContentContainer">一般令两者组合，常见1G3P(1片玻璃 + 3片塑料）。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">分色滤色片（2R Cut)</span></span><ul><li><span class="name"><span class="innerContentContainer">为何要分色？</span></span></li><li><span class="name"><span class="innerContentContainer">因为Sensor上每个像素只能识别一种颜色，所以需要把射入的光线过滤。有两种：</span></span></li><li><span class="name"><span class="innerContentContainer">RGB原色分色法。</span></span></li><li><span class="name"><span class="innerContentContainer">CMYK补色分色法，由青、洋红、黄、黑四种，但颜色不如RGB。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">感光Sensor</span></span><ul><li><span class="name"><span class="innerContentContainer">是一种半导体芯片，其表面含有几十万到几百万的光电二极管。有两种：</span></span></li><li><span class="name"><span class="innerContentContainer">CCD</span></span><ul><li><span class="name"><span class="innerContentContainer">工艺较成熟，生成稳定。</span></span></li><li><span class="name"><span class="innerContentContainer">以G-R-G-B型CCD为例，4个感光单元的中心点构成一个“像素点”，每个感光单元的光值复用了4次（边缘单元除外），所以每4个感光单元计算出4个信号。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">CMOS</span></span><ul><li><span class="name"><span class="innerContentContainer">被认为是未来的成像器材。</span></span></li><li><span class="name"><span class="innerContentContainer">成本低，速度快，功耗低。</span></span></li><li><span class="name"><span class="innerContentContainer">但目前工艺不成熟，坏点率较高，无法满足高分辨率的要求。</span></span></li><li><span class="name"><span class="innerContentContainer">其特点是一个感光单元对应一个像素。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">光电二极管的原理</span></span><ul><li><span class="name"><span class="innerContentContainer">P-N反向充电，在光照下放电，通过检测剩余电荷数量而得到光强信号。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Bayer阵列</span></span><ul><li><span class="name"><span class="innerContentContainer">bayer格式图片是伊士曼·柯达公司科学家Bryce&nbsp;Bayer发明的，拜耳阵列被广泛运用数字图像。</span></span></li><li><span class="name"><span class="innerContentContainer">如果每个像素都采样RGB3种颜色，则需要3块滤镜，且要保证滤镜严格对齐，代码非常大。</span></span></li><li><span class="name"><span class="innerContentContainer">Bayer注意到人眼对彩色的响应带宽不高，精细度不够的特点，采用每个像素只采样一种颜色，其它颜色使用周围像素的颜色。</span></span></li><li><span class="name"><span class="innerContentContainer">在采样时，奇数行分别采用R、G、R、G，偶数行分别采样G、B、G、B。</span></span><ul><li><span class="name"><span class="innerContentContainer">G的采样数量是RB的和，因为人眼对绿光最敏感。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">这样，一个像素的R、G、B数据将由相邻的4个感光单元构成。</span></span></li><li><span class="name"><span class="innerContentContainer">这种采样方式，在基本不降低<b>感官图像质量</b>的前提下，可以将数据量降低60%以上。</span></span></li><li><span class="name"><span class="innerContentContainer">相机sensor基本上用的都是Bayer阵列。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">FPC(柔板）</span></span><ul><li><span class="name"><span class="innerContentContainer">连接器。一般手机camera分前后置，会有比较长的连接线。</span></span></li><li><span class="name"><span class="innerContentContainer">CPU到camera的连线有：</span></span><ul><li><span class="name"><span class="innerContentContainer">Vdd（供电）</span></span></li><li><span class="name"><span class="innerContentContainer">mCLK（时钟源）</span></span><ul><li><span class="name"><span class="innerContentContainer">设置为24M</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">camera到CPU的连线有：</span></span><ul><li><span class="name"><span class="innerContentContainer">同步线有3根：</span></span><ul><li><span class="name"><span class="innerContentContainer">pCLK</span></span><ul><li><span class="name"><span class="innerContentContainer">pCLK传输一个像素点后click一次</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">hsync</span></span><ul><li><span class="name"><span class="innerContentContainer">hsync传输1行click一次</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">vsync</span></span><ul><li><span class="name"><span class="innerContentContainer">vsync传输一帧click一次</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">data线有8或10根</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">vfe：图像前端处理</span></span><ul><li><span class="name"><span class="innerContentContainer">camera同步线和数据线都直接连接vfe。这是一个关键的DSP芯片。</span></span></li><li><span class="name"><span class="innerContentContainer">vfe主要功能是处理白平衡、去边、去坏点、调节锐度、插值。</span></span></li><li><span class="name"><span class="innerContentContainer">驱动代码通过I2C总线给vfe传递camera配置参数。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Interface（总线）</span></span><ul><li><span class="name"><span class="innerContentContainer">并口</span></span><ul><li><span class="name"><span class="innerContentContainer">中低端相机用得多。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">MIPI</span></span><ul><li><span class="name"><span class="innerContentContainer">高像素camera中更常见。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">I2C</span></span></li><li><span class="name"><span class="innerContentContainer">Power</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">camera结构设计问题  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">成像方向</span></span><ul><li><span class="name"><span class="innerContentContainer">翻转90度</span></span></li><li><span class="name"><span class="innerContentContainer">翻转180度</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">视场角</span></span></li><li><span class="name"><span class="innerContentContainer">焦距</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">常见硬件问题  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">驱动能力不足或过大；</span></span></li><li><span class="name"><span class="innerContentContainer">上下电时序不满足规格，导致点不亮、裂屏、噪点多。</span></span></li><li><span class="name"><span class="innerContentContainer">I2C地址冲突。不同型号camera用不同地址。</span></span></li><li><span class="name"><span class="innerContentContainer">连接器选择和线序有问题。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">PCB设计review要点  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">AVDD和AGND走线要严格：同层包地，相邻层不能有高速线（clk、data、sync），AVDD线宽要保证150mA的过流能力。AVDD干扰易引起camera条纹。</span></span></li><li><span class="name"><span class="innerContentContainer">pclk和mclk要全程包地，相邻层要避免影响射频信号。</span></span></li><li><span class="name"><span class="innerContentContainer">mclk匹配电阻靠近平台芯片，pclk匹配电阻靠近camera。这叫源端匹配原理。</span></span></li><li><span class="name"><span class="innerContentContainer">I2C两根线走在一起，外侧包地。</span></span></li><li><span class="name"><span class="innerContentContainer">hsync和vsync尽量包地。</span></span></li><li><span class="name"><span class="innerContentContainer">各电源的滤波电容应尽量靠近camera的电源引脚。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">camera 点亮步骤</span></span><ul><li><span class="name"><span class="innerContentContainer">按sensor spec的上电电压和时序上电，包括reset和shutdown配置。</span></span></li><li><span class="name"><span class="innerContentContainer">建立I2C通讯，保证slave地址正确，保证地址和数据宽度正确。</span></span></li><li><span class="name"><span class="innerContentContainer">初始化成功后，就应该有图像了。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">数据处理过程</span></span><ul><li><span class="name"><span class="innerContentContainer">sensor来的数据通过vfe的处理后，输出yuv格式的数据到内存中。</span></span></li><li><span class="name"><span class="innerContentContainer">内存一般为系统开机就预分配的PMEM，大小一般为36MB。</span></span></li><li><span class="name"><span class="innerContentContainer">后面的处理分为两条线：</span></span><ul><li><span class="name"><span class="innerContentContainer">如果是预览，则数据会送给 mdsp，通过overlay技术显示在屏幕上。</span></span></li><li><span class="name"><span class="innerContentContainer">如果是拍照，则送到 adsp（video core）编码为jpeg格式，然后送到文件系统保存。</span></span></li><li><span class="name"><span class="innerContentContainer">如果是录像，则两条线都送。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Camera HAL代码</span></span><ul><li><span class="name"><span class="innerContentContainer">托管代码通过jni接口调用本地代码的c interface 层。</span></span></li><li><span class="name"><span class="innerContentContainer">interface 层通过IPC方式调用camera service层。</span></span></li><li><span class="name"><span class="innerContentContainer">service层以下则为hal层，包括google hal和qcom hal两层。</span></span></li><li><span class="name"><span class="innerContentContainer">qcom hal层通过syscall方式调用核心态代码，即camera driver。</span></span></li><li><span class="name"><span class="innerContentContainer">由于相机涉及到知识产权较密集，所以核心代码都在HAL层。driver中的代码很少。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">google native代码</span></span><ul><li><span class="name"><span class="innerContentContainer">jni层代码</span></span><ul><li><span class="name"><span class="innerContentContainer">framework/base/core_java/android/hardware/camera.java，../jni/android_hardware_camera.cpp。编译成 libandroid_runtime.so。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">framework层</span></span><ul><li><span class="name"><span class="innerContentContainer">framework/base/camera/libcameraservice/cameraservice.cpp。编译 libcameraservice.so。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">HAL层</span></span><ul><li><span class="name"><span class="innerContentContainer">framework/base/libs/ui/camera.cpp, ../ICamera.cpp, ../ICameraClient.cpp, ../ICameraService.cpp, 编译成 libui.so。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">高通native代码</span></span><ul><li><span class="name"><span class="innerContentContainer">代码位置： 也是按照camera型号组织的，比如：vendor/qcom/proprietany/mm_camera/targets/tgtcommon/sensor/ov5647_sunny/。</span></span></li><li><span class="name"><span class="innerContentContainer">3A代码路径：vendor/.../tgtcommon/isp3a</span></span></li><li><span class="name"><span class="innerContentContainer">效果代码路径：/chrometix_ov6547_sunny_preview.h</span></span></li><li><span class="name"><span class="innerContentContainer">特效代码路径：vendor/.../futhers/bestshot/</span></span></li><li><span class="name"><span class="innerContentContainer">闪光灯代码路径：vendor/.../flash/</span></span></li><li><span class="name"><span class="innerContentContainer">变焦代码路径：vendor/.../zoom/</span></span></li><li><span class="name"><span class="innerContentContainer">vfe代码路径：vendor/.../targets/vef31/7x30/vfe_porview.c, vfe_proc_msg_evt.c</span></span></li><li><span class="name"><span class="innerContentContainer">接口层： hardware/qcom/camera/QualcommCameraHardware.cpp</span></span></li><li><span class="name"><span class="innerContentContainer">初始化流程：</span></span><ul><li><span class="name"><span class="innerContentContainer">open /dev/msm_camera；</span></span></li><li><span class="name"><span class="innerContentContainer">load liboemcamera.so；</span></span></li><li><span class="name"><span class="innerContentContainer">生成三个线程：control、config、frame。</span></span><ul><li><span class="name"><span class="innerContentContainer">这个明显是和driver的三个内核设备对应。</span></span></li><li><span class="name"><span class="innerContentContainer">容易出问题的是config线程，它负责配置3A。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">预览流程</span></span><ul><li><span class="name"><span class="innerContentContainer">注册pmem；</span></span></li><li><span class="name"><span class="innerContentContainer">创建frame线程；</span></span></li><li><span class="name"><span class="innerContentContainer">下发 start_preview命令；</span></span></li><li><span class="name"><span class="innerContentContainer">唤醒config线程；</span></span></li><li><span class="name"><span class="innerContentContainer">从frame线程获取数据，显示在overlay中。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Camera driver</span></span><ul><li><span class="name"><span class="innerContentContainer">代码在kernel/drivers/media/video/msm。</span></span></li><li><span class="name"><span class="innerContentContainer">文件按camera型号和总线类型排列，比如 ov5647_sunny.c等。接口在 msm_camera.h。</span></span></li><li><span class="name"><span class="innerContentContainer">driver 代码包括如下3部分：</span></span></li><li><span class="name"><span class="innerContentContainer">vfe driver</span></span></li><li><span class="name"><span class="innerContentContainer">flash driver（闪光灯）</span></span></li><li><span class="name"><span class="innerContentContainer">sensor driver（重点）</span></span><ul><li><span class="name"><span class="innerContentContainer">camera驱动采用平台设备模型。初始化流程如下：</span></span></li><li><span class="name"><span class="innerContentContainer">首先是platform_device结构，包括 name、data 等字段，然后放在devices[]数组中。</span></span><ul><li><span class="name"><span class="innerContentContainer">可以通过adb cat /dev/platform/msm_camera_s5k4 看到其中的一些参数。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">其次是 platform_driver结构，包括 name、open、probe等字段。camera_start()调用时，会将device和driver通过name字段对应上。</span></span></li><li><span class="name"><span class="innerContentContainer">识别camera类型，加载对应driver过程。</span></span></li><li><span class="name"><span class="innerContentContainer">初始化的重点是probe()函数，主要完成如下工作：</span></span><ul><li><span class="name"><span class="innerContentContainer">alloc_chrdev_region：分配字符设备号，一次性分配15个；</span></span></li><li><span class="name"><span class="innerContentContainer">置gpio、时钟；</span></span></li><li><span class="name"><span class="innerContentContainer">驱动I2C；</span></span></li><li><span class="name"><span class="innerContentContainer">上电、配置mclk；</span></span></li><li><span class="name"><span class="innerContentContainer">通过I2C读取camera id；</span></span></li><li><span class="name"><span class="innerContentContainer">申请三个内核设备节点：</span></span><ul><li><span class="name"><span class="innerContentContainer">/dev/msm_camera/control、config、frame。如果有前后camera，则有6个，即control0和control1，config0和config1，frame0和frame1。</span></span></li><li><span class="name"><span class="innerContentContainer">control节点负责提供命令接口，比如打开设备/关闭设备/拍照/预览。通过I2C发给vfe芯片，然后vfe芯片再按定义的方式转给sensor。</span></span></li><li><span class="name"><span class="innerContentContainer">config节点负责提供配置camera的接口，主要是处理3A：AF（自动对焦）、AES（自动曝光）、AWB（自动白平衡）。</span></span></li><li><span class="name"><span class="innerContentContainer">frame节点负责提供数据通道。注意这个点得到的数据是vfe输出的，格式为yuv。raw data数据软件是得不到的。</span></span></li></ul></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">拍照相关的内存使用</span></span><ul><li><span class="name"><span class="innerContentContainer">预览使用的是preview buffer；</span></span></li><li><span class="name"><span class="innerContentContainer">拍照过程用两块</span></span><ul><li><span class="name"><span class="innerContentContainer">缩略图用thumbail buffer</span></span></li><li><span class="name"><span class="innerContentContainer">照片用 spark shot buffer</span></span></li><li><span class="name"><span class="innerContentContainer">这两块都来自pmem。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Camera测试环境</span></span><ul><li><span class="name"><span class="innerContentContainer">标准灯箱</span></span></li><li><span class="name"><span class="innerContentContainer">色卡</span></span></li><li><span class="name"><span class="innerContentContainer">测试分辨率的chart（可破插值算法）</span></span></li><li><span class="name"><span class="innerContentContainer">软件photoshop</span></span></li><li><span class="name"><span class="innerContentContainer">照度计</span></span></li></ul></li></ul>
  </body>
</html>