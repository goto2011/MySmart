<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">35-音频</span></span><ul><li><span class="name"><span class="innerContentContainer">手机音频硬件</span></span><ul><li><span class="name"><span class="innerContentContainer">mic：话筒，手机下部小孔，为输入设备。</span></span></li><li><span class="name"><span class="innerContentContainer">receiver：听筒，手机上部小孔，为输出设备。</span></span></li><li><span class="name"><span class="innerContentContainer">耳机：手机耳机有mic和receiver功能，一般还有线控功能。</span></span></li><li><span class="name"><span class="innerContentContainer">speaker：手机外放，一般在背面，有明显的音腔。输出设备。</span></span><ul><li><span class="name"><span class="innerContentContainer">speaker音频通道的输出是通过pm放大后接到外部的speaker器件的，以满足speaker设备对大电流的需要。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">pm芯片</span></span><ul><li><span class="name"><span class="innerContentContainer">pm音效开关；</span></span></li><li><span class="name"><span class="innerContentContainer">pm功率增益设置，具体增益从-16db到120db；</span></span></li><li><span class="name"><span class="innerContentContainer">增益设置延时，目的是给功率设置一个冷却时间，有10ms和100ms两种。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">硬件设计要处理两类问题</span></span><ul><li><span class="name"><span class="innerContentContainer">网络相关，即保证自己听得到对方，对方听得到自己。</span></span></li><li><span class="name"><span class="innerContentContainer">本机回环，即保证自己能听到自己的，即听筒/speaker到耳机或mic。</span></span><ul><li><span class="name"><span class="innerContentContainer">这个特性是基于人的本能诉求。</span></span></li><li><span class="name"><span class="innerContentContainer">这类问题更难搞定。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">声音的好坏主要取决于结构和硬件  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">结构是第一位的，主要是音腔大小和结构。音腔不行，靠其它方面去弥补效果有限。</span></span></li><li><span class="name"><span class="innerContentContainer">其次是音频器件的输出功率和稳定度；</span></span></li><li><span class="name"><span class="innerContentContainer">第三是其它信号源的干扰。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">音频驱动的关键元素</span></span><ul><li><span class="name"><span class="innerContentContainer">一个表（寄存器配置表）</span></span></li><li><span class="name"><span class="innerContentContainer">两张图（音频电路原理图和寄存器配置说明图）</span></span></li><li><span class="name"><span class="innerContentContainer">4个元素</span></span><ul><li><span class="name"><span class="innerContentContainer">声音设备（device）</span></span><ul><li><span class="name"><span class="innerContentContainer">snd_device_type，用于描述声音所使用的具体硬件设备。</span></span></li><li><span class="name"><span class="innerContentContainer">包括耳机、speaker、BT、usb等多种。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">声音方法（method）</span></span><ul><li><span class="name"><span class="innerContentContainer">snd_method_type，用于描述声音的具体类型。</span></span></li><li><span class="name"><span class="innerContentContainer">包括 ring, key_beep, midi 等。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">声音产生器（generator）</span></span><ul><li><span class="name"><span class="innerContentContainer">定义具体的硬件声音产生器。我们用了两种：</span></span></li><li><span class="name"><span class="innerContentContainer">vocoder设备，产生tone音和voice音；</span></span></li><li><span class="name"><span class="innerContentContainer">midi设备，产生midi音。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">codec</span></span><ul><li><span class="name"><span class="innerContentContainer">pcm编码通道，voc_codec_type，包括voc_codec_on_chip_o，包括headset、handset、speaker、bt等。</span></span></li><li><span class="name"><span class="innerContentContainer">codec config：voc_cal_codec_cfg</span></span></li><li><span class="name"><span class="innerContentContainer">audio path config：音频路径设置，用于区分语音通话用的是cdma还是gsm。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">在这4个元素之间的3组映射关系</span></span><ul><li><span class="name"><span class="innerContentContainer">snd_cal_control_data[][]</span></span><ul><li><span class="name"><span class="innerContentContainer">device + method -&gt; codec</span></span></li><li><span class="name"><span class="innerContentContainer">数组中，声音设备和声音方法的组合，来确定所使用的音量设置，以及所使用的codec。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">voc_cal_audio_path_config[][]（模拟信号）</span></span><ul><li><span class="name"><span class="innerContentContainer">codec + codec config -&gt; 寄存器配置。</span></span></li><li><span class="name"><span class="innerContentContainer">数组中每个值对应一个寄存器配置。</span></span></li><li><span class="name"><span class="innerContentContainer">寄存器配置值保存在文件 msmand.h中，数组定义在 voccal.c 中。</span></span></li><li><span class="name"><span class="innerContentContainer">比如，要使用speaker播放mp3，则当codec config取值为voc_cal_codec_cfg_synth，而codec取值为 voc_codec_sperker时，使用mp3的播放寄存器。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">voc_pcm_cal_aptr[][]（数字信号）</span></span><ul><li><span class="name"><span class="innerContentContainer">PCM path + codec -&gt; pcm参数配置。</span></span></li><li><span class="name"><span class="innerContentContainer">pcm参数包括滤波器系数、回声消除设置、降噪设置。</span></span></li><li><span class="name"><span class="innerContentContainer">变量在voccal.c 中定义。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">音频参数从哪里来？</span></span><ul><li><span class="name"><span class="innerContentContainer">音频参数由硬件声学组给我们，我们再用qact工具转成.h/.c文件，入库。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">PCM码流</span></span><ul><li><span class="name"><span class="innerContentContainer">PCM 脉冲编码调制是Pulse Code Modulation的缩写。</span></span></li><li><span class="name"><span class="innerContentContainer">模拟信号数字化必须经过三个过程，即采样、量化和编码。</span></span></li><li><span class="name"><span class="innerContentContainer">一次声波振动中，至少要有2个点的采样。当然越多音质越好。</span></span></li><li><span class="name"><span class="innerContentContainer">PCM码流是cd上用的音乐格式，即所谓的cd音质。</span></span></li><li><span class="name"><span class="innerContentContainer">非压缩，所以比较大。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">语音PCM的采样率</span></span><ul><li><span class="name"><span class="innerContentContainer">话音PCM的采样率为8kHz，每个量化样值对应一个8位二进制码，故话音数字编码信号的速率为8bits×8kHz=64kb/s。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">CD音质的采样率</span></span><ul><li><span class="name"><span class="innerContentContainer">人耳能够感觉到的最高频率为20kHz，所以40kHz以上的我们可以认为是原声。</span></span></li><li><span class="name"><span class="innerContentContainer">CD的采样率为44.1kHz，采样带宽为16bit。基本达到人听觉的极限，所以被认为是无损的原始声音格式。</span></span></li><li><span class="name"><span class="innerContentContainer">音乐无损压缩； 较流行的是ape和FCAC两种。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">DTMF编码音</span></span><ul><li><span class="name"><span class="innerContentContainer">拨号时使用的一种声音编码，是电话系统中电话机与交换机之间的信令，用于发送被叫号码。</span></span></li><li><span class="name"><span class="innerContentContainer">比较古老的编码方式，一直沿用到现在。</span></span></li><li><span class="name"><span class="innerContentContainer">传统电话拨号键盘是4×4的矩阵，每一行代表一个低频，每一列代表一个高频。每按一个键就发送一个高频和低频的正弦信号组合，比如'1'相当于697和1209赫兹(Hz)。</span></span></li><li><span class="name"><span class="innerContentContainer">交换机可以解码这些频率组合并确定所对应的按键。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">录音buffer的计算方法</span></span><ul><li><span class="name"><span class="innerContentContainer">对于录音，其获取音频数据的时间间隔应为：缓冲区大小/采样率/声道/采样精度，即录音buffer大小为2048，采样率为16K，单声道，采样精度2字节，那么时间间隔应该是2048/16000/1/2=64ms.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">高通音频硬件处理流程</span></span><ul><li><span class="name"><span class="innerContentContainer">音频数字信号（PCM码流）输入DSP，进行音量、音效等的处理。DSP输出的是PCM。</span></span></li><li><span class="name"><span class="innerContentContainer">PCM输入到codec_spa，进行D/A转换，变成模拟信号，根据音频通道发给各种设备。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">蓝牙耳机的数据流</span></span><ul><li><span class="name"><span class="innerContentContainer">mp3 -》 pcm码流 -》蓝牙耳机</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">语音通话的数据流</span></span><ul><li><span class="name"><span class="innerContentContainer">语音通话 -》 pcm码流 -》amr格式 -》 网络信号</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">IP电话场景</span></span><ul><li><span class="name"><span class="innerContentContainer">wifi call</span></span></li><li><span class="name"><span class="innerContentContainer">skype call</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">耳机插入检测</span></span><ul><li><span class="name"><span class="innerContentContainer">耳机插拔侦听</span></span><ul><li><span class="name"><span class="innerContentContainer">当前产品统一用GPIO中断方式。</span></span></li><li><span class="name"><span class="innerContentContainer">耳机按键则是用ADC读写。</span></span></li><li><span class="name"><span class="innerContentContainer">涉及卡槽插拔的器件，都要做防抖处理。</span></span></li><li><span class="name"><span class="innerContentContainer">耳机检测的防抖方案是将前3次读到的状态丢弃。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">四段式耳机的线序</span></span><ul><li><span class="name"><span class="innerContentContainer">反线序（手机基本都是用这种）：Mic、G（地）、Right（右声道）、Left（左声道）。</span></span></li><li><span class="name"><span class="innerContentContainer">标准线序是G、M、R、L，即M和G交换。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">三段式耳机的线序</span></span><ul><li><span class="name"><span class="innerContentContainer">三段式耳机没有mic。所以其线序即G、R、L。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">如何区分三段还是四段？</span></span><ul><li><span class="name"><span class="innerContentContainer">看Mic触点的状态。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">耳机按键</span></span><ul><li><span class="name"><span class="innerContentContainer">使用adc来读耳按键类型，其中2280mv为7健线控耳机，2550mv为单键线控耳机。</span></span></li><li><span class="name"><span class="innerContentContainer">信号从Mic触点走。当按键按下时，Mic触点会产生一个小于100mV的电流，通过adc能监测到。</span></span></li><li><span class="name"><span class="innerContentContainer">不按的时候，Mic触点维持在5V。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">耳机mic</span></span><ul><li><span class="name"><span class="innerContentContainer">mic触点还会连接到mic bias上。需要用mic时打开mic bias。</span></span></li><li><span class="name"><span class="innerContentContainer">mic的种类：手机mic分驻级式mic和硅mic两种。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">自动应答功能</span></span><ul><li><span class="name"><span class="innerContentContainer">高通代码不支持自动应答。我们自己实现的方案。</span></span></li><li><span class="name"><span class="innerContentContainer">这个功能的难点是高通dsp可实现pcm与amr等格式的互转，但没有开放给我们用。</span></span></li><li><span class="name"><span class="innerContentContainer">如果录制为amr等压缩格式，那么由于网络侧需要的声音格式很多种，如果格式不匹配，就会无声。比如如果录制为amr格式，则只有W电话才可以用。</span></span></li><li><span class="name"><span class="innerContentContainer">解决方案是录制pcm声音，自动应答时将pcm码流输入到声音通路上，由协议栈进行压缩和编码。其缺点是pcm非压缩，文件大，所以录音长度受限。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">声音环回延迟功能</span></span><ul><li><span class="name"><span class="innerContentContainer">高通支持声音换回，但无延迟，在生产现场，由于声音嘈杂，导致无法识别。</span></span></li><li><span class="name"><span class="innerContentContainer">解决方案和自动应答方案类似，将mic中传入的声音用pcm格式进行录音，过一定时间，在传入听筒输出通道中输出。延迟时间可灵活控制。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">音效</span></span><ul><li><span class="name"><span class="innerContentContainer">杜比</span></span></li><li><span class="name"><span class="innerContentContainer">DTS</span></span></li><li><span class="name"><span class="innerContentContainer">SRS</span></span></li><li><span class="name"><span class="innerContentContainer">2012年，DTS收购了SRS后，最新定价是：DTS：$0.16；SRS：$0.20。</span></span></li><li><span class="name"><span class="innerContentContainer">DTS和SRS比较</span></span><ul><li><span class="name"><span class="innerContentContainer">DTS在HAL层集成的，且稳定性较差，和高通LPA方案有冲突；</span></span></li><li><span class="name"><span class="innerContentContainer">SRS在framework层集成，稳定性较好。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">高通LPA方案</span></span><ul><li><span class="name"><span class="innerContentContainer">高通提供的在音乐播放时降低功耗的方案，在HAL层集成。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">分贝，DB的概念</span></span><ul><li><span class="name"><span class="innerContentContainer">分贝，表示两个量的比值的对数，没有单位。</span></span><ul><li><span class="name"><span class="innerContentContainer">用于功率的场景较多，此时其公式是：db=10*lg(A/B)。</span></span></li><li><span class="name"><span class="innerContentContainer">对于电流、电压、声强等信号强度，db=20*lg(A/B)。</span></span></li><li><span class="name"><span class="innerContentContainer">分贝也参见于衡量一个系统的输出和输入的比率，即增益。</span></span></li><li><span class="name"><span class="innerContentContainer">db可以做减法，减法即功率相除，比如信噪比就是db减法。DB一般不做加法，也没有乘除。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">使用db单位的好处</span></span><ul><li><span class="name"><span class="innerContentContainer">数据变小；</span></span></li><li><span class="name"><span class="innerContentContainer">运算方便，由乘除变加减。</span></span></li><li><span class="name"><span class="innerContentContainer">符合和人体生物学特征。人对声音响度的感受和功率的相对增长正相关。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">几个常见的db值</span></span><ul><li><span class="name"><span class="innerContentContainer">0db表示增益0。</span></span></li><li><span class="name"><span class="innerContentContainer">-3db表示减半功率。</span></span></li><li><span class="name"><span class="innerContentContainer">+3db表示功率大一倍。</span></span></li><li><span class="name"><span class="innerContentContainer">在电声系统中，正负3db被认为不影响声音特征。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">无线功率mW和dbm</span></span><ul><li><span class="name"><span class="innerContentContainer">dbm定义为相对于1毫瓦（mW）的比例的指数的10倍。</span></span></li><li><span class="name"><span class="innerContentContainer">根据每10db，增益加10倍的原则，很显然，30dbm=1000mw=1w；10db=10mw。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">声学中db的概念</span></span><ul><li><span class="name"><span class="innerContentContainer">声音强度的单位是巴斯卡，即牛顿/平方米。</span></span></li><li><span class="name"><span class="innerContentContainer">人耳的感应范围很大，从20微巴到2000巴之间。一般用db来计算声音强度。基准是20微巴。</span></span></li><li><span class="name"><span class="innerContentContainer">计算公式是：db=20*lg（当前身压值/20微巴).</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">几种常见声音的db值</span></span><ul><li><span class="name"><span class="innerContentContainer">0分贝：3米外的一只蚊子在飞；</span></span></li><li><span class="name"><span class="innerContentContainer">10db：极安静的房间；</span></span></li><li><span class="name"><span class="innerContentContainer">40-60，正常谈话；</span></span></li><li><span class="name"><span class="innerContentContainer">60-80：10米外经过的汽车；</span></span></li><li><span class="name"><span class="innerContentContainer">90：嘈杂的酒吧；</span></span></li><li><span class="name"><span class="innerContentContainer">120-130：摇滚演唱会的最前排；</span></span></li><li><span class="name"><span class="innerContentContainer">160：航天飞机引擎声；</span></span></li><li><span class="name"><span class="innerContentContainer">175：75米外1吨炸药爆炸。</span></span></li><li><span class="name"><span class="innerContentContainer">一般85分贝以上的声音就会导致听觉细胞开始死亡。</span></span></li></ul></li></ul></li></ul>
  </body>
</html>