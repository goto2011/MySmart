<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">37-Power&amp;USB</span></span><ul><li><span class="name"><span class="innerContentContainer">充电芯片</span></span><ul><li><span class="name"><span class="innerContentContainer">双回路机制</span></span><ul><li><span class="name"><span class="innerContentContainer">充电时，充电芯片有两个回路，一路给电池充电，一路给手机供电。</span></span></li><li><span class="name"><span class="innerContentContainer">一般充电过程中, 电池不给手机供电。</span></span></li><li><span class="name"><span class="innerContentContainer">如果手机有大电流需求，则用充电器和电池一起供电。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">充电器</span></span><ul><li><span class="name"><span class="innerContentContainer">智能手机电池一般都在3000毫安以上. </span></span></li><li><span class="name"><span class="innerContentContainer">为适应大电池，充电器都切换为1A/5V, 或者2A/5V的大功率充电器。</span></span></li><li><span class="name"><span class="innerContentContainer">第三方PD充电器更高, 达到18W、30W甚至65W。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">电池指标</span></span><ul><li><span class="name"><span class="innerContentContainer">循环放电400次后，满充容量不少于标称的80%。</span></span></li><li><span class="name"><span class="innerContentContainer">倍率放电测试，要求放电电流和放电时间满足倍率关系。</span></span></li><li><span class="name"><span class="innerContentContainer">高温测试，要求在-30到130度测试下，电池不燃烧。</span></span></li><li><span class="name"><span class="innerContentContainer">60度存放7天，剩余电量大于90%；70度存放一天，剩余电量大于90%。</span></span></li><li><span class="name"><span class="innerContentContainer">过充测试，要求4.6V充电保持7小时电池不燃烧。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">电池校准</span></span><ul><li><span class="name"><span class="innerContentContainer">电量表、温度曲线。一个产品一套.</span></span></li><li><span class="name"><span class="innerContentContainer">如果使用多种电芯，就需要多种电量表（同时需要提供识别它们的方法）。</span></span></li><li><span class="name"><span class="innerContentContainer">校准方法: </span></span><ul><li><span class="name"><span class="innerContentContainer">电池校准发生在产线步骤CT中.</span></span></li><li><span class="name"><span class="innerContentContainer">程控电源设定n个电压（3.4v、3.7v、4.2v），分别读取ADC值5次，取平均值，保持到nv中。</span></span></li><li><span class="name"><span class="innerContentContainer">测试: 在BT和MT中，对电压校准值进行测试，如果差距大于0.03V（一个ADC raw值的偏差），则认为电池校准失败。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">充电类型</span></span><ul><li><span class="name"><span class="innerContentContainer">标充</span></span><ul><li><span class="name"><span class="innerContentContainer">5V2A, 2.5-3小时充满.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">快速充电</span></span><ul><li><span class="name"><span class="innerContentContainer">9V2A, 1.5小时充满.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">超级快充</span></span><ul><li><span class="name"><span class="innerContentContainer">低压: 5V 4.5A, 1.5小时充满.</span></span></li><li><span class="name"><span class="innerContentContainer">高压: 10V 4A, 1小时充满.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">无线充电</span></span><ul><li><span class="name"><span class="innerContentContainer">无线充电芯片, 负责从电磁波中获取能量.</span></span></li><li><span class="name"><span class="innerContentContainer">功率一般7.5瓦.</span></span></li><li><span class="name"><span class="innerContentContainer">2020-01-14, 功率最高27瓦.</span></span></li><li><span class="name"><span class="innerContentContainer">90%以上是有效能量.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">反向无线充电</span></span><ul><li><span class="name"><span class="innerContentContainer">5V 1A, 可支持非华为手机</span></span></li><li><span class="name"><span class="innerContentContainer">15瓦. 最大40瓦(2020-01-14). </span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>充电方案(充电步骤)</b></span></span><ul><li><span class="name"><span class="innerContentContainer">设计充电方案的主要考虑点  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">确保绝对安全. 锂电池是存在安全风险的, 所以必须留够buffer.</span></span></li><li><span class="name"><span class="innerContentContainer">在安全的前提下，最大限度充满电，物尽其用;</span></span></li><li><span class="name"><span class="innerContentContainer">在1和2都满足的前提下，充电时间尽可能短。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">充电过程中，充电电压不变，保持5v;</span></span></li><li><span class="name"><span class="innerContentContainer">充电电流一直在变化。</span></span></li><li><span class="name"><span class="innerContentContainer">电池电压一直在升高, 通过电压估计电池电量。电池电压作为充电流程控制的主变量。</span></span></li><li><span class="name"><span class="innerContentContainer">充电基本步骤</span></span><ul><li><span class="name"><span class="innerContentContainer">1. 涓流充电</span></span><ul><li><span class="name"><span class="innerContentContainer">开始充电时，如果电池电压低，必须用小电流充电，即涓流充电。</span></span></li><li><span class="name"><span class="innerContentContainer">因为电池电压低的情况下，大电流充电，电池内阻会急剧升高，结果一是充不进去，二是发热伤害电池。</span></span></li><li><span class="name"><span class="innerContentContainer">涓流充电门限</span></span><ul><li><span class="name"><span class="innerContentContainer">充电电压5V，电流100mA；</span></span></li><li><span class="name"><span class="innerContentContainer">电池电压2.8v-3.2v（3，2v相当于电池电量0%）。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">涓流充电时间一般为10分钟。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">2. 恒流充电</span></span><ul><li><span class="name"><span class="innerContentContainer">电池电压在3.2v以上，开始用大电流充电，即采用允许的最大电流充，以节省时间。</span></span></li><li><span class="name"><span class="innerContentContainer">恒流是充电的主要区间。</span></span></li><li><span class="name"><span class="innerContentContainer">充电电压5v，恒流充电电流门限：</span></span><ul><li><span class="name"><span class="innerContentContainer">标准充电器800mA-1A;</span></span></li><li><span class="name"><span class="innerContentContainer">usb充电器450mA；</span></span></li><li><span class="name"><span class="innerContentContainer">非标充电器450-500mA。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">恒流充电在1-3个小时左右。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">3. 恒压充电</span></span><ul><li><span class="name"><span class="innerContentContainer">电池电压到了4.2v时，电池接近充满，此时转入恒压充电，保持电池电压基本不变，逐步减小充电电流，以避免过充。</span></span></li><li><span class="name"><span class="innerContentContainer">恒压充电门限: 充电电压5v，充电电流逐步减小。电池电压由4.2v-》4.25v。</span></span></li><li><span class="name"><span class="innerContentContainer">恒压充电时间一般在1个小时左右。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">限流处理</span></span><ul><li><span class="name"><span class="innerContentContainer">华为标配充电器限流1A或800mA，标配的条件是D+、D-短接；</span></span></li><li><span class="name"><span class="innerContentContainer">非标充电器限流400-500mA。</span></span></li><li><span class="name"><span class="innerContentContainer">USB充电限流: 按spec规定，USB充电必须限流。其中USB插入协商阶段，限流100mA，正常充电时限流400-450mA。</span></span></li><li><span class="name"><span class="innerContentContainer">USB充电时，不能进入tx_wait状态. 原因是防止电流倒灌，在usb睡眠时可能发生。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">LDO充电模式（传统）</span></span><ul><li><span class="name"><span class="innerContentContainer">充电器变大后，传统LDO充电的问题就暴露了：电流容易过载、发热量大、充电时间过长。</span></span></li><li><span class="name"><span class="innerContentContainer">取而代之的是DCDC方式。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">DCDC充电模式</span></span><ul><li><span class="name"><span class="innerContentContainer">DCDC充电管理芯片；</span></span></li><li><span class="name"><span class="innerContentContainer">通过I2C总线进行参数设置和状态输出。</span></span></li><li><span class="name"><span class="innerContentContainer">支持涓流、恒流、恒压三种模式;</span></span></li><li><span class="name"><span class="innerContentContainer">当输入电压过高或过低时自动进入保护模式，停止充电。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>放电过程和电量显示</b></span></span><ul><li><span class="name"><span class="innerContentContainer">容量为3200毫安时（简称毫安）的电池，满电情况下以160mA的电流放电，可持续工作20小时。</span></span></li><li><span class="name"><span class="innerContentContainer">另一个电量单位是瓦时（wH）。</span></span><ul><li><span class="name"><span class="innerContentContainer">由于手机锂电池的标准发电电压是3.7v，所以瓦时和毫安时等价。</span></span></li><li><span class="name"><span class="innerContentContainer">换算公式为：1wH = 3.6AH。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">电池的放电区间</span></span><ul><li><span class="name"><span class="innerContentContainer">区间在 3.4v-4.2v，其中大部分电流分布在 3.5v-3.6v 之间。</span></span></li><li><span class="name"><span class="innerContentContainer">低于3.4v，电量极少。</span></span></li><li><span class="name"><span class="innerContentContainer">低于3.2v，手机会自动关机。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">当前充电流程控制中，通过<b>电池电压</b>估计电量。</span></span><ul><li><span class="name"><span class="innerContentContainer">电池电压从哪里来？ 通过ADC采样获得。</span></span></li><li><span class="name"><span class="innerContentContainer">更优的方法是使用库仑计（电量计），直接测量电池电荷量，精度高，没有增压问题。但是电量计贵，只有iPhone用得起。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">在非充电状态下，这种方案精度有保障。</span></span></li><li><span class="name"><span class="innerContentContainer">但在充电模式下，则有增压问题。</span></span><ul><li><span class="name"><span class="innerContentContainer">在充电时，由于电池内阻，电压上升得比较快，电压和电量的关系变得非线性，精度偏差较大。</span></span></li><li><span class="name"><span class="innerContentContainer">一般会采用经验值做一定的平滑，即<b>电量表</b>。</span></span></li><li><span class="name"><span class="innerContentContainer">电量表是一个数组，第一个数据是1%电量对应的电压值，第二个是2%电量的电压值，如此类推。</span></span></li><li><span class="name"><span class="innerContentContainer">一般有四张电量表，分别对应放电、充电器充电、usb充电、非标充电器充电。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">电池电压读取周期</span></span><ul><li><span class="name"><span class="innerContentContainer">当电量为0、1、2格时，15秒读一次；</span></span></li><li><span class="name"><span class="innerContentContainer">3、4、5格时，30秒读一次；</span></span></li><li><span class="name"><span class="innerContentContainer">开机时，第5秒读第一次。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">0格电压门限： 3.46V</span></span></li><li><span class="name"><span class="innerContentContainer">电池放电平滑算法： 本次结果 = 0.875 *上次结果 + 0.125 * 本次ADC采样值</span></span></li><li><span class="name"><span class="innerContentContainer">开机时特殊处理： 电池电压读数不准，所以把前两次都丢弃掉。只使用第65秒的值。</span></span></li><li><span class="name"><span class="innerContentContainer">电量显示：满格占40%电量，1格占的极少。其它基本均分。</span></span></li><li><span class="name"><span class="innerContentContainer">电量显示存在学习过程. 因为电池容量是变化的, 要根据充放电的数据进行学习.</span></span></li><li><span class="name"><span class="innerContentContainer">启动学习的条件:</span></span><ul><li><span class="name"><span class="innerContentContainer">电量在20%以下;</span></span></li><li><span class="name"><span class="innerContentContainer">充电时间在半小时以上;</span></span></li><li><span class="name"><span class="innerContentContainer">电池温度在10-45度之间.</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">关机充电</span></span><ul><li><span class="name"><span class="innerContentContainer">关机充电时，手机启动到recovery（即kernel），但不进Android。</span></span></li><li><span class="name"><span class="innerContentContainer">而modem侧都启动了。所以不做处理的话，是可以被打通电话的，只是无法接。</span></span></li><li><span class="name"><span class="innerContentContainer">进关机充电条件的判断是在oemsbl中。什么条件:</span></span><ul><li><span class="name"><span class="innerContentContainer">电池和充电器是否都在位；</span></span></li><li><span class="name"><span class="innerContentContainer">是否为正常开机，包括闹钟开机、按power键开机、用户重启开机；</span></span></li><li><span class="name"><span class="innerContentContainer">是否为异常开机，包括watchdog reset开机和瞬间掉电开机；</span></span></li><li><span class="name"><span class="innerContentContainer">misc分区中的充电使能标志的值。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">关机充电动画处理</span></span><ul><li><span class="name"><span class="innerContentContainer">recovery中有一套基于framebuffer的图形接口，在 bootable/recovery/miniui/graphices 中。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">misc分区中的充电使能标志的功能: </span></span><ul><li><span class="name"><span class="innerContentContainer">给app使用. </span></span></li><li><span class="name"><span class="innerContentContainer">当他们想重启，而不是关机时，去使能这个标志，以避免不开机而进关机充电界面。</span></span></li><li><span class="name"><span class="innerContentContainer">可通过 cat /proc/app_info/charge_flag 来查看。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">按键处理: 进入充电前，recovery启动一个叫 charge_input_thread 的线程处理按键，其中音量上下键只起唤醒作用，power键起关机作用。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">充电过程的常见异常  <span class="contentTag" title="Filter #问题功耗">#<span class="contentTagText">问题功耗</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">涓流无法转恒流;</span></span></li><li><span class="name"><span class="innerContentContainer">恒流无法转恒压；</span></span></li><li><span class="name"><span class="innerContentContainer">充电不截止；</span></span></li><li><span class="name"><span class="innerContentContainer">零星脉冲充电；</span></span></li><li><span class="name"><span class="innerContentContainer">二次充电（已经充满停止充电后, 再自动开始充电. 和增压问题有关）.</span></span></li></ul></li><li><span class="name"></span></li><li><span class="name"><span class="innerContentContainer">USB Type-C</span></span><ul><li><span class="name"><span class="innerContentContainer">和Type-C早出现的usb client 接口叫 USB-A.</span></span></li><li><span class="name"><span class="innerContentContainer">Type-C的新特性:</span></span><ul><li><span class="name"><span class="innerContentContainer">支持正反插入</span></span></li><li><span class="name"><span class="innerContentContainer">支持更强的电力传输（最大功率 100W, 即USB-PD）</span></span></li><li><span class="name"><span class="innerContentContainer">更快的传输速度（最高 10Gbps ）</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">从 2017年开始, Apple 的 Macbook 仅支持type-c接口.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">PD 快充</span></span><ul><li><span class="name"><span class="innerContentContainer">USB Power Delivery. USB-PD 将快充技术标准进行了统一化.</span></span></li><li><span class="name"><span class="innerContentContainer">PD快充的充电头即Type-C规范的. 不过有的 Type-C不一定支持 PD协议.</span></span></li><li><span class="name"><span class="innerContentContainer">PD 快充协议，最大的优势是最大功率 100W输出. </span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">其它快充技术</span></span><ul><li><span class="name"><span class="innerContentContainer">MTK 的 PE+ (Pump Express)</span></span></li><li><span class="name"><span class="innerContentContainer">高通的 QC 4+</span></span><ul><li><span class="name"><span class="innerContentContainer">在QC1．0时代，5V的充电电压没有改变，将电流增大到了2A，这也使得充电效率提升了40％。</span></span></li><li><span class="name"><span class="innerContentContainer">QC2．0在原来5V的基础上新增了9V和12V的电压，增加了电压，也就增大了功率，QC2．0的最大充电功率可达18W。</span></span></li><li><span class="name"><span class="innerContentContainer">QC3．0中引入了INOV（Intelligent negotiation optimal voltage智能协商最佳电压）技术，可以动态地调节输出的电压，可根据终端的功率需求输出最佳的功率，电压调节范围3．6V～20V，步进200mV，充电效率比QC2．0提升38％，速度提升27％，发热降低45％。</span></span></li><li><span class="name"><span class="innerContentContainer">QC4．0中，高通加入了对 USB－PD的支持，并且最大充电功率也提升至了27W。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">OPPO 的 VOOC（DASH）</span></span><ul><li><span class="name"><span class="innerContentContainer">VOOC作为OPPO独立研发的快充技术，另辟蹊径采用大电流的充电方案，并且将充电电路转移到适配器中，来减少手机的发热，在国内可以说是一项非常有新意的创新了，VOOC的充电功率为20W（5V4A）.</span></span></li><li><span class="name"><span class="innerContentContainer">升级版SuperVOOC，最高充电功率可达55W。</span></span></li><li><span class="name"><span class="innerContentContainer">“充电两分钟，通话两小时”便出自OPPO的广告。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">华为的 FCP （穿着马甲的 QC 2.0 ）</span></span></li><li><span class="name"><span class="innerContentContainer">华为的 SCP</span></span><ul><li><span class="name"><span class="innerContentContainer">SCP（SuperCharge）输出达到了4.5V 5A和5V 4.5A，功率22.5W，业内也叫低压直充。</span></span></li><li><span class="name"><span class="innerContentContainer">2018年10月，推出了10V 4A的40W超级快充.</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">功耗管理</span></span><ul><li><span class="name"><span class="innerContentContainer">android的功耗管理只要通过锁和定时器来切换系统状态，使功耗降低到最低。</span></span></li><li><span class="name"><span class="innerContentContainer">应用层的两种 wakelock.</span></span><ul><li><span class="name"><span class="innerContentContainer">一种是 partial wakeup，申请了这种，即使按power键，系统也不进sleep，比如music player。</span></span></li><li><span class="name"><span class="innerContentContainer">其它类型的 wakeup，按power键，系统进sleep。</span></span></li><li><span class="name"><span class="innerContentContainer">各自锁的定义常见 newWakeLock.c。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">fwk client端代码在：frameworks/base/core/java/android/os/PowerManager.java</span></span><ul><li><span class="name"><span class="innerContentContainer">它定义了一个wakelock基类，有两个成员，acquire 和 release。</span></span></li><li><span class="name"><span class="innerContentContainer">需要进行睡眠控制的类，会定义 wakelock成员. </span></span><ul><li><span class="name"><span class="innerContentContainer">通过qcquire接口来禁止睡眠，</span></span></li><li><span class="name"><span class="innerContentContainer">通过release接口来允许睡眠。</span></span></li><li><span class="name"><span class="innerContentContainer">要成对使用，否则导致系统无法进睡眠。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">fwk service端的代码在 powermanager_service.java, 是核心。</span></span><ul><li><span class="name"><span class="innerContentContainer">power.java 为接口io层，访问jni层。</span></span></li><li><span class="name"><span class="innerContentContainer">jni层代码主要是 android_os_power.cpp。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">hal层代码是 power.c，通过sys文件系统，syscall， 调用driver。</span></span></li><li><span class="name"><span class="innerContentContainer">driver层代码在 kernel/kernel/power</span></span><ul><li><span class="name"><span class="innerContentContainer">wakelock模块主要维护两个链表。应用申请lock，在调用wakelock()中插入active_wake_locks链表。</span></span></li><li><span class="name"><span class="innerContentContainer">被释放的 lock ，调用 wakeunlock(),会将其移动到 inactive_locks 队列中去。</span></span></li><li><span class="name"><span class="innerContentContainer">在调用 wakeunlock() 中，以及定时器到时间时，会调用 has_wake_lock_locked()来看是否有active的lock，如果没有，则启动 suspend_unlock 工作队列，执行睡眠流程。</span></span></li><li><span class="name"><span class="innerContentContainer">有3个suspend_work_queue队列</span></span><ul><li><span class="name"><span class="innerContentContainer">睡眠准备：early_suspend_work</span></span><ul><li><span class="name"><span class="innerContentContainer">通常会把LCD和背光驱动注册为early_suspend_work，以便第一阶段被关闭。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">睡眠：suspend_work</span></span></li><li><span class="name"><span class="innerContentContainer">睡眠恢复：late_resume_work</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">kernel会去查看 wakelock是否全部释放，如果是，则启动suspend_work队列，让所有设备进入suspend状态，并停止时钟。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">应用如果要保持屏幕亮， 调用链是：</span></span><ul><li><span class="name"><span class="innerContentContainer">TimerOutTask(screen) </span></span></li><li><span class="name"><span class="innerContentContainer">setPowerState() </span></span></li><li><span class="name"><span class="innerContentContainer">Power.setScreenState()</span></span></li><li><span class="name"><span class="innerContentContainer">set_screen_state() // jni</span></span></li><li><span class="name"><span class="innerContentContainer">write("/sys/power/state") </span></span></li><li><span class="name"><span class="innerContentContainer">state_store()   // driver</span></span></li><li><span class="name"><span class="innerContentContainer">state_store()；后面分为两支，MEM 则进入 early_syspend(), ON 则进入 late_resueme().</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">应用如果要禁止进待机，调用链是：</span></span><ul><li><span class="name"><span class="innerContentContainer">PowerManagerService.java</span></span></li><li><span class="name"><span class="innerContentContainer">Power.java</span></span></li><li><span class="name"><span class="innerContentContainer">acquire_wake_lock()</span></span></li><li><span class="name"><span class="innerContentContainer">write "/sys/power/wake_lock"</span></span></li><li><span class="name"><span class="innerContentContainer">wake_lock_store()</span></span></li><li><span class="name"><span class="innerContentContainer">wake_lock() </span></span></li><li><span class="name"><span class="innerContentContainer">wake_lock_time_out()</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">待机：DRX周期</span></span><ul><li><span class="name"><span class="innerContentContainer">非连续接收周期。进入睡眠后，大约每2.56秒，手机会醒来查看是否有呼入。此时也会检查是否有用户输入。</span></span></li><li><span class="name"><span class="innerContentContainer">手机用这个机制来省电。</span></span></li><li><span class="name"><span class="innerContentContainer">比如 GSM drx周期为1.18秒，WCDMA为2.56秒。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">手机器件的典型功耗（不是太准确） <span class="contentTag" title="Filter #问题功耗">#<span class="contentTagText">问题功耗</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">SDRAM读写刷新：60-65mA（＊2，有两块）；静态电流：200uA（＊2）</span></span></li><li><span class="name"><span class="innerContentContainer">Nand flash工作：10-20mA；静态：&lt;1mA</span></span></li><li><span class="name"><span class="innerContentContainer">camera工作：100mA；静态：uA级</span></span></li><li><span class="name"><span class="innerContentContainer">LCD工作：50mA；静态：30uA</span></span></li><li><span class="name"><span class="innerContentContainer">LCD背灯工作：75mA；静态：uA级</span></span></li><li><span class="name"><span class="innerContentContainer">EL灯片工作：70mA；静态：uA级</span></span></li><li><span class="name"><span class="innerContentContainer">RF+PA发射（高通套片）工作（GSM）2.35mA；静态：nil</span></span></li><li><span class="name"><span class="innerContentContainer">RF+PA接受（高通套片）工作（GSM）2.15mA；静态：nil</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">驱动整机功耗优化的思路  <span class="contentTag" title="Filter #问题功耗">#<span class="contentTagText">问题功耗</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">临区测量对待机的影响；</span></span></li><li><span class="name"><span class="innerContentContainer">搜网时间间隔；小区切换频繁的定位方案、优化方案；</span></span></li><li><span class="name"><span class="innerContentContainer">通话和待机时CPU主频的优化；</span></span></li><li><span class="name"><span class="innerContentContainer">周期位置更新周期和每次时长的记录，及优化方案；</span></span></li><li><span class="name"><span class="innerContentContainer">背光、马达等的设置，功耗和业界方案对比。</span></span></li><li><span class="name"><span class="innerContentContainer">声音播放过程中的优化。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">驱动整机功耗调试经验  <span class="contentTag" title="Filter #问题功耗">#<span class="contentTagText">问题功耗</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">BT电源是功耗大户，拔器件看功耗有没有改善。</span></span></li><li><span class="name"><span class="innerContentContainer">board id相关的gpio要细调，有时候会有四五mA的漏电。</span></span></li><li><span class="name"><span class="innerContentContainer">常见问题包括：PA开关、TF卡电源、mac bias电源。</span></span></li><li><span class="name"><span class="innerContentContainer">rf电源如果有问题，功耗会差很多。包括rftx、rfrx1、rfrx2、s2、s3、wlan等。先看能不能关，不能关看有没有省电模式。</span></span></li><li><span class="name"><span class="innerContentContainer">调整好软件流程。系统有中断马上会启动tcxo，电流起码40mA。</span></span></li><li><span class="name"><span class="innerContentContainer">上拉电阻的阻值要尽量大一些，保证静态电流尽量小。</span></span></li><li><span class="name"><span class="innerContentContainer">慎用三极管做开关，因为管子本身电流大。</span></span></li><li><span class="name"><span class="innerContentContainer">外围芯片中，对于提供shutdown状态的芯片要尽量提供控制电路，软件要确保待机前使之进入shutdown。</span></span></li><li><span class="name"><span class="innerContentContainer">射频发射功耗大，尽量做到高效率，减少不必要的延迟和重传，当然要懂这块之后再调。</span></span></li><li><span class="name"><span class="innerContentContainer">I2C关闭时，要作为GPIO来关，否则关不彻底。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">应用功耗管理  <span class="contentTag" title="Filter #问题功耗">#<span class="contentTagText">问题功耗</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">功耗精灵之类.</span></span></li><li><span class="name"><span class="innerContentContainer">考虑要素:</span></span><ul><li><span class="name"><span class="innerContentContainer">系统状态: 开屏, 锁屏3分钟, 锁屏10分钟, 锁屏1小时.</span></span></li><li><span class="name"><span class="innerContentContainer">应用状态: 前台, 后台.</span></span></li><li><span class="name"><span class="innerContentContainer">应用优先级: 超级应用, 比如 微信. QQ.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">对应用的处理措施</span></span><ul><li><span class="name"><span class="innerContentContainer">冻结. </span></span></li><li><span class="name"><span class="innerContentContainer">kill, 进程杀掉, 但是资源还在.</span></span></li><li><span class="name"><span class="innerContentContainer">stop</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">应用功耗排行</span></span><ul><li><span class="name"><span class="innerContentContainer">实时统计 CPU, 基带, WiFi, GPS 等设备的功耗, 然后按应用对器件的使用占比来计算功耗排行.</span></span></li></ul></li></ul></li><li><span class="name"></span></li><li><span class="name"><span class="innerContentContainer">热方案</span></span><ul><li><span class="name"><span class="innerContentContainer">充电时用电池的热敏电阻，放电时用cpu的热敏电阻。</span></span></li><li><span class="name"><span class="innerContentContainer">放电时，通过CPU旁边的热敏电阻监控CPU温度，超过门限（43℃左右）就降频。</span></span></li><li><span class="name"><span class="innerContentContainer">充电时，通过充电芯片旁边的热敏电阻监控充电芯片的温度，超过门限（48℃左右）就限流。</span></span></li><li><span class="name"><span class="innerContentContainer">充电时，如果用户玩大型游戏，或者长时间通话，CPU温升可能超过充电芯片，导致方案（2）失效。所以在充电时需要监控两个数据。</span></span></li><li><span class="name"><span class="innerContentContainer">CPU有过热保护，高通平台是85℃手机就自动关机。</span></span></li><li><span class="name"><span class="innerContentContainer">从业界看环境温度25度下，要求不超过43度是一个业界基本采用的标准（刚好温升18度）。</span></span></li><li><span class="name"><span class="innerContentContainer">从人体接触体验来说，40度以上温度刺激明显，45度以上可能受伤。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Power键处理</span></span><ul><li><span class="name"><span class="innerContentContainer">power键直接接到PMIC的KPDPWR_IN脚上。</span></span></li><li><span class="name"><span class="innerContentContainer">当它被拉低后，PM将启动，并给CPU供电，启动CPU。</span></span></li></ul></li></ul>
  </body>
</html>