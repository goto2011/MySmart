<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">25-升级&amp;音频&amp;射频协议</span></span><ul><li><span class="name"><span class="innerContentContainer">升级</span></span><ul><li><span class="name"><span class="innerContentContainer">FTM模式</span></span><ul><li><span class="name"><span class="innerContentContainer">开机进入recovery机器人界面，且屏幕中间显示“factory”。</span></span></li><li><span class="name"><span class="innerContentContainer">是否进FTM在misc分区中设置。</span></span></li><li><span class="name"><span class="innerContentContainer">FTM子模式有哪几种？</span></span><ul><li><span class="name"><span class="innerContentContainer">NV 453=1，进纯FTM模式；</span></span></li><li><span class="name"><span class="innerContentContainer">如果再加上NV 60003的值，进 FTM各子模式。</span></span><ul><li><span class="name"><span class="innerContentContainer">=1，wifi 校准；</span></span></li><li><span class="name"><span class="innerContentContainer">=2，wifi 环回测试；</span></span></li><li><span class="name"><span class="innerContentContainer">=3，BT 校准。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">recovery</span></span><ul><li><span class="name"><span class="innerContentContainer">recovery是一种启动模式、一个分区、一个独立的运行单元，也是一个有main()入口的linux程序。</span></span></li><li><span class="name"><span class="innerContentContainer">recovery有自己的kernel，以及运行其上的完成recovery各子功能的linux应用。</span></span></li><li><span class="name"><span class="innerContentContainer">如何进入recovery？</span></span><ul><li><span class="name"><span class="innerContentContainer">按音量上键开机, 进recovery菜单；</span></span></li><li><span class="name"><span class="innerContentContainer">NV 453=1，进FTM模式；</span></span></li><li><span class="name"><span class="innerContentContainer">NV 60002=1（UMTS），或NV 60009=1（CDMA），进快速注册模式；</span></span></li><li><span class="name"><span class="innerContentContainer">NV 60004=1，settings菜单恢复出厂设置即是设置这个值后重启。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">recovery的主要功能</span></span><ul><li><span class="name"><span class="innerContentContainer">格式化data分区</span></span><ul><li><span class="name"><span class="innerContentContainer">格式化前将 /data/dataapp 中的文件备份到cache分区，格式化后再恢复回来。</span></span></li><li><span class="name"><span class="innerContentContainer">这个目录是放运营商定制apk, 不能删除了.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">格式化内置SD卡</span></span></li><li><span class="name"><span class="innerContentContainer">格式化cache分区</span></span></li><li><span class="name"><span class="innerContentContainer">格式化cache分区</span></span></li><li><span class="name"><span class="innerContentContainer">备份数据恢复</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">misc分区作为模块间传递命令的载体</span></span><ul><li><span class="name"><span class="innerContentContainer">好处是重启前后都在。大小一般为2M。</span></span></li><li><span class="name"><span class="innerContentContainer">misc分区可以升级, 升级大包中有，以便初始化该分区。</span></span></li><li><span class="name"><span class="innerContentContainer">misc分区中的数据</span></span><ul><li><span class="name"><span class="innerContentContainer">第1个字段, 关机充电</span></span></li><li><span class="name"><span class="innerContentContainer">第2个字段, recovery信息</span></span></li><li><span class="name"><span class="innerContentContainer">第3个字段, recovery掉电保护</span></span></li><li><span class="name"><span class="innerContentContainer">第4个字段, ota升级标志</span></span></li><li><span class="name"><span class="innerContentContainer">第5个字段, kernel panic信息</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">cust升级</span></span><ul><li><span class="name"><span class="innerContentContainer">cust 升级即定制升级. 定制需求一般来自运营商.</span></span></li><li><span class="name"><span class="innerContentContainer">方案设计原则</span></span><ul><li><span class="name"><span class="innerContentContainer">cust分区是个全集, 包括全球所有定制的配置文件.</span></span></li><li><span class="name"><span class="innerContentContainer">系统运行时, 通过软链接方式将自己需要的子集载入系统, 并mount 到 /data/cust. </span></span></li><li><span class="name"><span class="innerContentContainer">应用访问 /data/cust 来读取自己的配置信息, 完全透明访问. </span></span></li><li><span class="name"><span class="innerContentContainer">从 /data/custom.bin 可读取当前使用的是哪个运营商.</span></span></li><li><span class="name"><span class="innerContentContainer">由此可做到代码和定制归一化。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">cust包的内容</span></span><ul><li><span class="name"><span class="innerContentContainer">cust分区</span></span><ul><li><span class="name"><span class="innerContentContainer">所有定制信息，以“运营商信息/国家“为路径组织起来。</span></span></li><li><span class="name"><span class="innerContentContainer">包括ap侧到的定制配置文件（主要是xml文件）、modem侧的logo和定制nv。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">vendor_id包</span></span><ul><li><span class="name"><span class="innerContentContainer">很小, 一般十几个字节.</span></span></li><li><span class="name"><span class="innerContentContainer">就是文本文件. 内容是 运营商信息 + 国家信息，比如vodafone/German。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">cust包升级方式</span></span><ul><li><span class="name"><span class="innerContentContainer">大包升级的最后一步, 自动升级cust包;</span></span></li><li><span class="name"><span class="innerContentContainer">生产工位打背贴时，通过后台写入vendor_id. 会激活cust升级.</span></span></li><li><span class="name"><span class="innerContentContainer">在研发环境下, 通过diag命令, 切换运营商, 也会触发cust升级.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">升级流程</span></span><ul><li><span class="name"><span class="innerContentContainer">aboot 从oeminfo中读vendor id, 写到 cmdline中。</span></span><ul><li><span class="name"><span class="innerContentContainer">以通过如下命令查看： cat /proc/cmdline</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">init进程会对比 /proc/cmdline（A） 和 /data/custom.bin（B） 的值。会有几种场景:</span></span><ul><li><span class="name"><span class="innerContentContainer">第一次开机，A与B都是空的。</span></span><ul><li><span class="name"><span class="innerContentContainer">init 的做法是：写 hw/default 到B，然后激活 init.rc中的on cust，按默认值激活cust升级, 完成后然后重启。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">第二次开机，A空B不空，则正常启动。</span></span></li><li><span class="name"><span class="innerContentContainer">如果A&lt;&gt;B(原因是升级vendor信息后开机). 则:</span></span><ul><li><span class="name"><span class="innerContentContainer">重启，先进行恢复出厂设置.</span></span><ul><li><span class="name"><span class="innerContentContainer">cust升级前为什么要recovery?</span></span></li><li><span class="name"><span class="innerContentContainer">因为要把data分区中的软链接都删除，如果删除失败则cust升级会失败。</span></span></li><li><span class="name"><span class="innerContentContainer">以防万一，就把data分区格式化一遍。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">然后做on cust操作</span></span><ul><li><span class="name"><span class="innerContentContainer">on cust升级之init.rc中定义，完成三种功能：</span></span></li><li><span class="name"><span class="innerContentContainer">custcopy：copy一个文件；</span></span></li><li><span class="name"><span class="innerContentContainer">custsymlink：copy一个目录；</span></span></li><li><span class="name"><span class="innerContentContainer">load_oemlogo：copy logo。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">最后停在recovery界面下。</span></span></li><li><span class="name"><span class="innerContentContainer">以上就是所谓的cust升级流程.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">如果A=B（非首次开机），不做任何事。</span></span></li><li><span class="name"><span class="innerContentContainer">如果是B不存在，说明刚升过级，且没有走cust升级流程, 则把A写入B，然后进入cust升级流程。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">预置apk的安装位置</span></span><ul><li><span class="name"><span class="innerContentContainer">系统apk 放在 /system/app下，不可删除，恢复出厂设置不会删除。</span></span></li><li><span class="name"><span class="innerContentContainer">厂商预制apk 放在 /system/delapp，可删除，但是恢复出厂设置又会回来。</span></span></li><li><span class="name"><span class="innerContentContainer">用户安装apk 放在 /data/app下，可删除，恢复出厂设置会删除。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">hota升级</span></span><ul><li><span class="name"><span class="innerContentContainer">ota升级: fireware over the air，无线补丁升级。</span></span></li><li><span class="name"><span class="innerContentContainer">有三种方案：</span></span><ul><li><span class="name"><span class="innerContentContainer">redband的fota方案</span></span><ul><li><span class="name"><span class="innerContentContainer">该方案每台手机收费0.2美金。所以现在基本不用.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">google提供的ota方案</span></span><ul><li><span class="name"><span class="innerContentContainer">部分运营商明确要使用google方案.</span></span></li><li><span class="name"><span class="innerContentContainer">升级包需要放在google的服务器上。</span></span></li><li><span class="name"><span class="innerContentContainer">gota升级有如下规则：原始版本与目标版本的平台编译时间戳必须不同，如果相同则google服务器上无法检测到。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">华为实现的hota方案. 常用.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">hota包下载到手机的方式</span></span><ul><li><span class="name"><span class="innerContentContainer">通过settings下载hota升级包</span></span><ul><li><span class="name"><span class="innerContentContainer">根据手机当前版本号或IMEI号找下载包.</span></span></li><li><span class="name"><span class="innerContentContainer">菜单中只能搜索到一个差分包。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">自动下载</span></span><ul><li><span class="name"><span class="innerContentContainer">默认自动下载周期是10天，周期可通过cust定制。</span></span></li><li><span class="name"><span class="innerContentContainer">用户可在菜单中定制周期，也可以将自动检测关闭。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">下载方式</span></span><ul><li><span class="name"><span class="innerContentContainer">用android原生的DownloadProvider，支持断点续传。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">差分包的保存位置</span></span><ul><li><span class="name"><span class="innerContentContainer">升级包展开后，有sd卡的放在sd卡上，</span></span></li><li><span class="name"><span class="innerContentContainer">无sd卡的放在内置卡，</span></span></li><li><span class="name"><span class="innerContentContainer">内置卡空间不足，放在 /cache/fotapkg下。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">data分区的问题</span></span><ul><li><span class="name"><span class="innerContentContainer">hoto升级不会擦除/data分区，所以用户数据保留。</span></span></li><li><span class="name"><span class="innerContentContainer">但升级过程中可以往 data分区添加文件。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">升级过程</span></span><ul><li><span class="name"><span class="innerContentContainer">ap侧下载升级包</span></span></li><li><span class="name"><span class="innerContentContainer">调用hota_start_update()</span></span></li><li><span class="name"><span class="innerContentContainer">设置misc信息</span></span><ul><li><span class="name"><span class="innerContentContainer">写入misc的信息如下：update_package=SDCARD:文件名.zip </span></span></li><li><span class="name"><span class="innerContentContainer">或者 CACHE:文件名.zip</span></span></li><li><span class="name"><span class="innerContentContainer">取决于差分包的保存位置。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">系统重启进入recovery模式</span></span></li><li><span class="name"><span class="innerContentContainer">hota在recovery中完成</span></span><ul><li><span class="name"><span class="innerContentContainer">recovery中，get_args()函数从misc分区或command文件中获取升级包位置。</span></span></li><li><span class="name"><span class="innerContentContainer">调用ota_status_check()，读misc信息，确定是hota，还是fota。如果都不是，则清空misc和cache，然后重启。</span></span></li><li><span class="name"><span class="innerContentContainer">调用do_hota_update()，完成第一阶段升级，即差分升级。</span></span></li><li><span class="name"><span class="innerContentContainer">调用maybe_install_fireware_update()，将modem侧升级的update.app写入cache分区，设置misc信息为：hota_update_radio。</span></span></li><li><span class="name"><span class="innerContentContainer">手机再次重启，oemsbl_dload_check()中读取misc信息，然后调用dload_sd()完成对aboot、boot、recovery和modem侧诸模块升级。</span></span></li><li><span class="name"><span class="innerContentContainer">升级完成后，重启进入recovery，清除cache和misc对应字段，然后重启。</span></span></li><li><span class="name"><span class="innerContentContainer">升级log放在 data/last.log中，注意进入recovery会被覆盖。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">root过的手机不能进行hota升级。</span></span></li><li><span class="name"><span class="innerContentContainer">hota升级可删除文件</span></span><ul><li><span class="name"><span class="innerContentContainer">hota升级脚本为 /META-INF/com/google/android/updater-script, </span></span></li><li><span class="name"><span class="innerContentContainer">在其中的delete字段中加一行：delete("/data/misc/wifi/load/ar6000.ko");</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">差分算法</span></span><ul><li><span class="name"><span class="innerContentContainer">如果不一致, 拷贝a文件，生成备份文件，叫a.backup。</span></span></li><li><span class="name"><span class="innerContentContainer">差分升级只支持 system、cust等ext4分区。</span></span></li><li><span class="name"><span class="innerContentContainer">具体过程如下：</span></span></li><li><span class="name"><span class="innerContentContainer">先检查新旧文件是否一致，一致就跳过；</span></span></li><li><span class="name"><span class="innerContentContainer">如果system剩余空间小于a文件的1.5倍，则放到/cache分区，如果cache空间也不够，则报错。</span></span></li><li><span class="name"><span class="innerContentContainer">对a.backup进行差分，升级完成后命名为a，拷贝到原处。这样做的目的是掉电保护。</span></span></li><li><span class="name"><span class="innerContentContainer">其实是用google ota的算法。对ext4的文件系统来说，有专门的命令对比两个ext4文件系统的差异，因此极大的降低了方案的复杂程度。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">升级安全方案</span></span><ul><li><span class="name"><span class="innerContentContainer">升级包结构如下:</span></span></li><li><span class="name"><span class="innerContentContainer">MD5-RSA</span></span><ul><li><span class="name"><span class="innerContentContainer">存放: CRC模块经过MD5加密后，再经过私钥A加密后的数据，128B。</span></span></li><li><span class="name"><span class="innerContentContainer">它的检验方式: oeminfo分区有公钥A，将密文解密为MD5数据，然后将明文进行MD5加密，两个对比，如一致则ok。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">CRC</span></span><ul><li><span class="name"><span class="innerContentContainer">升级包以下各模块的CRC值表。</span></span></li><li><span class="name"><span class="innerContentContainer">按模块顺序，每32K数据算一个16位的CRC值，不足32K的也算一个CRC。</span></span></li><li><span class="name"><span class="innerContentContainer">最大长度为128KB，对应升级包为1GB大小。(现在肯定改了)</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">AMSS_ECC</span></span><ul><li><span class="name"><span class="innerContentContainer">目的是给amss加密。</span></span></li><li><span class="name"><span class="innerContentContainer">它分为密文和明文两部分，明文为amss模块的ecc列表，每512B字节算16位的ecc数据；</span></span></li><li><span class="name"><span class="innerContentContainer">密文为明文做md5，然后再rsa加密后的1024位数据。</span></span></li><li><span class="name"><span class="innerContentContainer">amss的ecc检验方案在智能机上没有使用。原因是没有必要去保护。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">音频</span></span><ul><li><span class="name"><span class="innerContentContainer">手机音频硬件</span></span><ul><li><span class="name"><span class="innerContentContainer">mic：话筒，手机下部小孔，为输入设备。</span></span></li><li><span class="name"><span class="innerContentContainer">receiver：听筒，手机上部小孔，为输出设备。</span></span></li><li><span class="name"><span class="innerContentContainer">耳机：手机耳机有mic和receiver功能，一般还有线控功能。</span></span></li><li><span class="name"><span class="innerContentContainer">speaker：手机外放，一般在背面，有明显的音腔。输出设备。</span></span><ul><li><span class="name"><span class="innerContentContainer">speaker音频通道的输出是通过pm放大后接到外部的speaker器件的，以满足speaker设备对大电流的需要。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">pm芯片</span></span><ul><li><span class="name"><span class="innerContentContainer">pm音效开关；</span></span></li><li><span class="name"><span class="innerContentContainer">pm功率增益设置，具体增益从-16db到120db；</span></span></li><li><span class="name"><span class="innerContentContainer">增益设置延时，目的是给功率设置一个冷却时间，有10ms和100ms两种。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">硬件设计要处理两类问题</span></span><ul><li><span class="name"><span class="innerContentContainer">网络相关，即保证自己听得到对方，对方听得到自己。</span></span></li><li><span class="name"><span class="innerContentContainer">本机回环，即保证自己能听到自己的，即听筒/speaker到耳机或mic。</span></span><ul><li><span class="name"><span class="innerContentContainer">这个特性是基于人的本能诉求。</span></span></li><li><span class="name"><span class="innerContentContainer">这类问题更难搞定。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">声音的好坏主要取决于结构和硬件  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">结构是第一位的，主要是音腔大小和结构。音腔不行，靠其它方面去弥补效果有限。</span></span></li><li><span class="name"><span class="innerContentContainer">其次是音频器件的输出功率和稳定度；</span></span></li><li><span class="name"><span class="innerContentContainer">第三是其它信号源的干扰。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">音频驱动的关键元素</span></span><ul><li><span class="name"><span class="innerContentContainer">一个表（寄存器配置表）</span></span></li><li><span class="name"><span class="innerContentContainer">两张图（音频电路原理图和寄存器配置说明图）</span></span></li><li><span class="name"><span class="innerContentContainer">4个元素</span></span><ul><li><span class="name"><span class="innerContentContainer">声音设备（device）</span></span><ul><li><span class="name"><span class="innerContentContainer">snd_device_type，用于描述声音所使用的具体硬件设备。</span></span></li><li><span class="name"><span class="innerContentContainer">包括耳机、speaker、BT、usb等多种。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">声音方法（method）</span></span><ul><li><span class="name"><span class="innerContentContainer">snd_method_type，用于描述声音的具体类型。</span></span></li><li><span class="name"><span class="innerContentContainer">包括 ring, key_beep, midi 等。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">声音产生器（generator）</span></span><ul><li><span class="name"><span class="innerContentContainer">定义具体的硬件声音产生器。我们用了两种：</span></span></li><li><span class="name"><span class="innerContentContainer">vocoder设备，产生tone音和voice音；</span></span></li><li><span class="name"><span class="innerContentContainer">midi设备，产生midi音。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">codec</span></span><ul><li><span class="name"><span class="innerContentContainer">pcm编码通道，voc_codec_type，包括voc_codec_on_chip_o，包括headset、handset、speaker、bt等。</span></span></li><li><span class="name"><span class="innerContentContainer">codec config：voc_cal_codec_cfg</span></span></li><li><span class="name"><span class="innerContentContainer">audio path config：音频路径设置，用于区分语音通话用的是cdma还是gsm。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">在这4个元素之间的3组映射关系</span></span><ul><li><span class="name"><span class="innerContentContainer">snd_cal_control_data[][]</span></span><ul><li><span class="name"><span class="innerContentContainer">device + method -&gt; codec</span></span></li><li><span class="name"><span class="innerContentContainer">数组中，声音设备和声音方法的组合，来确定所使用的音量设置，以及所使用的codec。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">voc_cal_audio_path_config[][]（模拟信号）</span></span><ul><li><span class="name"><span class="innerContentContainer">codec + codec config -&gt; 寄存器配置。</span></span></li><li><span class="name"><span class="innerContentContainer">数组中每个值对应一个寄存器配置。</span></span></li><li><span class="name"><span class="innerContentContainer">寄存器配置值保存在文件 msmand.h中，数组定义在 voccal.c 中。</span></span></li><li><span class="name"><span class="innerContentContainer">比如，要使用speaker播放mp3，则当codec config取值为voc_cal_codec_cfg_synth，而codec取值为 voc_codec_sperker时，使用mp3的播放寄存器。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">voc_pcm_cal_aptr[][]（数字信号）</span></span><ul><li><span class="name"><span class="innerContentContainer">PCM path + codec -&gt; pcm参数配置。</span></span></li><li><span class="name"><span class="innerContentContainer">pcm参数包括滤波器系数、回声消除设置、降噪设置。</span></span></li><li><span class="name"><span class="innerContentContainer">变量在voccal.c 中定义。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">音频参数从哪里来？</span></span><ul><li><span class="name"><span class="innerContentContainer">音频参数由硬件声学组给我们，我们再用qact工具转成.h/.c文件，入库。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">PCM码流</span></span><ul><li><span class="name"><span class="innerContentContainer">PCM 脉冲编码调制是Pulse Code Modulation的缩写。</span></span></li><li><span class="name"><span class="innerContentContainer">模拟信号数字化必须经过三个过程，即采样、量化和编码。</span></span></li><li><span class="name"><span class="innerContentContainer">一次声波振动中，至少要有2个点的采样。当然越多音质越好。</span></span></li><li><span class="name"><span class="innerContentContainer">PCM码流是cd上用的音乐格式，即所谓的cd音质。</span></span></li><li><span class="name"><span class="innerContentContainer">非压缩，所以比较大。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">语音PCM的采样率</span></span><ul><li><span class="name"><span class="innerContentContainer">话音PCM的采样率为8kHz，每个量化样值对应一个8位二进制码，故话音数字编码信号的速率为8bits×8kHz=64kb/s。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">CD音质的采样率</span></span><ul><li><span class="name"><span class="innerContentContainer">人耳能够感觉到的最高频率为20kHz，所以40kHz以上的我们可以认为是原声。</span></span></li><li><span class="name"><span class="innerContentContainer">CD的采样率为44.1kHz，采样带宽为16bit。基本达到人听觉的极限，所以被认为是无损的原始声音格式。</span></span></li><li><span class="name"><span class="innerContentContainer">音乐无损压缩； 较流行的是ape和FCAC两种。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">DTMF编码音</span></span><ul><li><span class="name"><span class="innerContentContainer">拨号时使用的一种声音编码，是电话系统中电话机与交换机之间的信令，用于发送被叫号码。</span></span></li><li><span class="name"><span class="innerContentContainer">比较古老的编码方式，一直沿用到现在。</span></span></li><li><span class="name"><span class="innerContentContainer">传统电话拨号键盘是4×4的矩阵，每一行代表一个低频，每一列代表一个高频。每按一个键就发送一个高频和低频的正弦信号组合，比如'1'相当于697和1209赫兹(Hz)。</span></span></li><li><span class="name"><span class="innerContentContainer">交换机可以解码这些频率组合并确定所对应的按键。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">录音buffer的计算方法</span></span><ul><li><span class="name"><span class="innerContentContainer">对于录音，其获取音频数据的时间间隔应为：缓冲区大小/采样率/声道/采样精度，即录音buffer大小为2048，采样率为16K，单声道，采样精度2字节，那么时间间隔应该是2048/16000/1/2=64ms.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">高通音频硬件处理流程</span></span><ul><li><span class="name"><span class="innerContentContainer">音频数字信号（PCM码流）输入DSP，进行音量、音效等的处理。DSP输出的是PCM。</span></span></li><li><span class="name"><span class="innerContentContainer">PCM输入到codec_spa，进行D/A转换，变成模拟信号，根据音频通道发给各种设备。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">蓝牙耳机的数据流</span></span><ul><li><span class="name"><span class="innerContentContainer">mp3 -》 pcm码流 -》蓝牙耳机</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">语音通话的数据流</span></span><ul><li><span class="name"><span class="innerContentContainer">语音通话 -》 pcm码流 -》amr格式 -》 网络信号</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">IP电话场景</span></span><ul><li><span class="name"><span class="innerContentContainer">wifi call</span></span></li><li><span class="name"><span class="innerContentContainer">skype call</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">耳机插入检测</span></span><ul><li><span class="name"><span class="innerContentContainer">耳机插拔侦听</span></span><ul><li><span class="name"><span class="innerContentContainer">当前产品统一用GPIO中断方式。</span></span></li><li><span class="name"><span class="innerContentContainer">耳机按键则是用ADC读写。</span></span></li><li><span class="name"><span class="innerContentContainer">涉及卡槽插拔的器件，都要做防抖处理。</span></span></li><li><span class="name"><span class="innerContentContainer">耳机检测的防抖方案是将前3次读到的状态丢弃。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">四段式耳机的线序</span></span><ul><li><span class="name"><span class="innerContentContainer">反线序（手机基本都是用这种）：Mic、G（地）、Right（右声道）、Left（左声道）。</span></span></li><li><span class="name"><span class="innerContentContainer">标准线序是G、M、R、L，即M和G交换。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">三段式耳机的线序</span></span><ul><li><span class="name"><span class="innerContentContainer">三段式耳机没有mic。所以其线序即G、R、L。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">如何区分三段还是四段？</span></span><ul><li><span class="name"><span class="innerContentContainer">看Mic触点的状态。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">耳机按键</span></span><ul><li><span class="name"><span class="innerContentContainer">使用adc来读耳按键类型，其中2280mv为7健线控耳机，2550mv为单键线控耳机。</span></span></li><li><span class="name"><span class="innerContentContainer">信号从Mic触点走。当按键按下时，Mic触点会产生一个小于100mV的电流，通过adc能监测到。</span></span></li><li><span class="name"><span class="innerContentContainer">不按的时候，Mic触点维持在5V。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">耳机mic</span></span><ul><li><span class="name"><span class="innerContentContainer">mic触点还会连接到mic bias上。需要用mic时打开mic bias。</span></span></li><li><span class="name"><span class="innerContentContainer">mic的种类：手机mic分驻级式mic和硅mic两种。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">自动应答功能</span></span><ul><li><span class="name"><span class="innerContentContainer">高通代码不支持自动应答。我们自己实现的方案。</span></span></li><li><span class="name"><span class="innerContentContainer">这个功能的难点是高通dsp可实现pcm与amr等格式的互转，但没有开放给我们用。</span></span></li><li><span class="name"><span class="innerContentContainer">如果录制为amr等压缩格式，那么由于网络侧需要的声音格式很多种，如果格式不匹配，就会无声。比如如果录制为amr格式，则只有W电话才可以用。</span></span></li><li><span class="name"><span class="innerContentContainer">解决方案是录制pcm声音，自动应答时将pcm码流输入到声音通路上，由协议栈进行压缩和编码。其缺点是pcm非压缩，文件大，所以录音长度受限。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">声音环回延迟功能</span></span><ul><li><span class="name"><span class="innerContentContainer">高通支持声音换回，但无延迟，在生产现场，由于声音嘈杂，导致无法识别。</span></span></li><li><span class="name"><span class="innerContentContainer">解决方案和自动应答方案类似，将mic中传入的声音用pcm格式进行录音，过一定时间，在传入听筒输出通道中输出。延迟时间可灵活控制。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">音效</span></span><ul><li><span class="name"><span class="innerContentContainer">杜比</span></span></li><li><span class="name"><span class="innerContentContainer">DTS</span></span></li><li><span class="name"><span class="innerContentContainer">SRS</span></span></li><li><span class="name"><span class="innerContentContainer">2012年，DTS收购了SRS后，最新定价是：DTS：$0.16；SRS：$0.20。</span></span></li><li><span class="name"><span class="innerContentContainer">DTS和SRS比较</span></span><ul><li><span class="name"><span class="innerContentContainer">DTS在HAL层集成的，且稳定性较差，和高通LPA方案有冲突；</span></span></li><li><span class="name"><span class="innerContentContainer">SRS在framework层集成，稳定性较好。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">高通LPA方案</span></span><ul><li><span class="name"><span class="innerContentContainer">高通提供的在音乐播放时降低功耗的方案，在HAL层集成。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">分贝，DB的概念</span></span><ul><li><span class="name"><span class="innerContentContainer">分贝，表示两个量的比值的对数，没有单位。</span></span><ul><li><span class="name"><span class="innerContentContainer">用于功率的场景较多，此时其公式是：db=10*lg(A/B)。</span></span></li><li><span class="name"><span class="innerContentContainer">对于电流、电压、声强等信号强度，db=20*lg(A/B)。</span></span></li><li><span class="name"><span class="innerContentContainer">分贝也参见于衡量一个系统的输出和输入的比率，即增益。</span></span></li><li><span class="name"><span class="innerContentContainer">db可以做减法，减法即功率相除，比如信噪比就是db减法。DB一般不做加法，也没有乘除。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">使用db单位的好处</span></span><ul><li><span class="name"><span class="innerContentContainer">数据变小；</span></span></li><li><span class="name"><span class="innerContentContainer">运算方便，由乘除变加减。</span></span></li><li><span class="name"><span class="innerContentContainer">符合和人体生物学特征。人对声音响度的感受和功率的相对增长正相关。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">几个常见的db值</span></span><ul><li><span class="name"><span class="innerContentContainer">0db表示增益0。</span></span></li><li><span class="name"><span class="innerContentContainer">-3db表示减半功率。</span></span></li><li><span class="name"><span class="innerContentContainer">+3db表示功率大一倍。</span></span></li><li><span class="name"><span class="innerContentContainer">在电声系统中，正负3db被认为不影响声音特征。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">无线功率mW和dbm</span></span><ul><li><span class="name"><span class="innerContentContainer">dbm定义为相对于1毫瓦（mW）的比例的指数的10倍。</span></span></li><li><span class="name"><span class="innerContentContainer">根据每10db，增益加10倍的原则，很显然，30dbm=1000mw=1w；10db=10mw。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">声学中db的概念</span></span><ul><li><span class="name"><span class="innerContentContainer">声音强度的单位是巴斯卡，即牛顿/平方米。</span></span></li><li><span class="name"><span class="innerContentContainer">人耳的感应范围很大，从20微巴到2000巴之间。一般用db来计算声音强度。基准是20微巴。</span></span></li><li><span class="name"><span class="innerContentContainer">计算公式是：db=20*lg（当前身压值/20微巴).</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">几种常见声音的db值</span></span><ul><li><span class="name"><span class="innerContentContainer">0分贝：3米外的一只蚊子在飞；</span></span></li><li><span class="name"><span class="innerContentContainer">10db：极安静的房间；</span></span></li><li><span class="name"><span class="innerContentContainer">40-60，正常谈话；</span></span></li><li><span class="name"><span class="innerContentContainer">60-80：10米外经过的汽车；</span></span></li><li><span class="name"><span class="innerContentContainer">90：嘈杂的酒吧；</span></span></li><li><span class="name"><span class="innerContentContainer">120-130：摇滚演唱会的最前排；</span></span></li><li><span class="name"><span class="innerContentContainer">160：航天飞机引擎声；</span></span></li><li><span class="name"><span class="innerContentContainer">175：75米外1吨炸药爆炸。</span></span></li><li><span class="name"><span class="innerContentContainer">一般85分贝以上的声音就会导致听觉细胞开始死亡。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">射频协议</span></span><ul><li><span class="name"><span class="innerContentContainer">通讯基础知识 <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">地球表面只有8%的地区覆盖有手机信号。而卫星信号则覆盖98%。</span></span></li><li><span class="name"><span class="innerContentContainer">地球表面只有8%的地区覆盖有手机信号。</span></span></li><li><span class="name"><span class="innerContentContainer">方波是一种非正弦曲线的波形（类似长城墙），通常在信号处理时出现.</span></span><ul><li><span class="name"><span class="innerContentContainer">理想方波只有高和低两个值。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">谐波</span></span><ul><li><span class="name"><span class="innerContentContainer">谐波是点播中所含有的频率为基波的整数倍的电波。</span></span></li><li><span class="name"><span class="innerContentContainer">广义上，所有与基波频率不同的成分都可以称之为谐波。</span></span></li><li><span class="name"><span class="innerContentContainer">音乐上的泛音就是谐波。</span></span></li><li><span class="name"><span class="innerContentContainer">在信号处理上，广义的谐波通常是噪音的来源。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">带宽</span></span><ul><li><span class="name"><span class="innerContentContainer">信道可以不失真的传输信号的频率范围。</span></span></li><li><span class="name"><span class="innerContentContainer">对数字系统而言，它即波特率。</span></span></li><li><span class="name"><span class="innerContentContainer">几种网络协议的速率:</span></span></li><li><span class="name"><span class="innerContentContainer">GSM : 9K</span></span></li><li><span class="name"><span class="innerContentContainer">GPRS : 42K</span></span></li><li><span class="name"><span class="innerContentContainer">EDGE : 172K-384K</span></span></li><li><span class="name"><span class="innerContentContainer">WCDMA : 364K</span></span></li><li><span class="name"><span class="innerContentContainer">HSD/UPA : 14.4M</span></span></li><li><span class="name"><span class="innerContentContainer">HSD/UPA+ : 42M</span></span></li><li><span class="name"><span class="innerContentContainer">LTE : 150-300M</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">频率和带宽的关系</span></span><ul><li><span class="name"><span class="innerContentContainer">带宽 = 频率 ＊ 信道数（频点数）。</span></span></li><li><span class="name"><span class="innerContentContainer">举个例子，一个32条独立信道的66MHz，其带宽为66M＊32=2.1G。</span></span><ul><li><span class="name"><span class="innerContentContainer">如果是有线的话，这32个信道可以是32根线.</span></span></li><li><span class="name"><span class="innerContentContainer">无线系统下，可以是32个频点。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">从物理意义上讲，由于频率是连续的，所以可能的信道数是无限的，限制因素是收发两方的测量精度。</span></span></li><li><span class="name"><span class="innerContentContainer">两个频点其实可以无限接近，只要收发的精度足够高。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">通讯解决的最根本的问题</span></span><ul><li><span class="name"><span class="innerContentContainer">根本问题是，通讯永远是多对多的.</span></span></li><li><span class="name"><span class="innerContentContainer">理论上必须每两个人之间接一根线。</span></span></li><li><span class="name"><span class="innerContentContainer">但是实际上不可能，所以通讯渠道必须共享。</span></span></li><li><span class="name"><span class="innerContentContainer">共享的前提是不能在同一时刻，所有人都打电话。这个前提很容易满足.</span></span></li><li><span class="name"><span class="innerContentContainer">完成线路共享，要解决两个问题：</span></span><ul><li><span class="name"><span class="innerContentContainer">第一，如何区别不同的人. 有3种方式:</span></span><ul><li><span class="name"><span class="innerContentContainer">频分</span></span><ul><li><span class="name"><span class="innerContentContainer">频分就是不同的人用不同的信道。这是最直观的方法（分车道，每人用一条）。</span></span></li><li><span class="name"><span class="innerContentContainer">相关的概念即频段、载波、频点（=信道）</span></span><ul><li><span class="name"><span class="innerContentContainer">以联通WCDMA为例，上行1940M-1955M，下行2130M-2145M。上下行间隔190M。</span></span></li><li><span class="name"><span class="innerContentContainer">而W规范要求每个载波的带宽是5M，故可用载波为3个，即载波1、2、3。</span></span></li><li><span class="name"><span class="innerContentContainer">频点间隔200KHz，即每个载波25个频点。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">频分多址即FDMA。GSM就是频分多址。</span></span></li><li><span class="name"><span class="innerContentContainer">频分即把整个可分配的频谱划分为许多个无线信道，每个信道可以传输一路语音或控制信息。</span></span></li><li><span class="name"><span class="innerContentContainer">频分如何解决频谱资源不够的问题?</span></span><ul><li><span class="name"><span class="innerContentContainer">频分从感觉上肯定很不够用，其实不然。因为可以<b>频率复用</b>。</span></span><ul><li><span class="name"><span class="innerContentContainer">指处在不同地址位置（不同小区）上的用户可以同时使用相同频率的信道。</span></span></li><li><span class="name"><span class="innerContentContainer">复用可以极大的提高频谱效率。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">手机用的频率是如何分配的?</span></span><ul><li><span class="name"><span class="innerContentContainer">手机用的频点是搜网过程中由基站分配的。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">时分</span></span><ul><li><span class="name"><span class="innerContentContainer">时分就是不同的人用不同的时段。</span></span></li><li><span class="name"><span class="innerContentContainer">将一个完整的通讯响应过程分为几个时隙，多个通讯就可以交叉进行。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">码分</span></span><ul><li><span class="name"><span class="innerContentContainer">码分就是每个人分一个不同的名字，放在数据包的头上，然后就可以再同一个信道中同时的互不干扰的通讯了。</span></span></li><li><span class="name"><span class="innerContentContainer">相当于轨道交通, 每个货分一个号码进车厢。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">结论: 码分真牛，高通真牛。码分才是王道。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">第二，如何评估剩下的资源总是够分配。(属于网规和网优，不再展开)</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">LTE简介</span></span><ul><li><span class="name"><span class="innerContentContainer">LTE即4G技术，采用DFDM和MIMO作为其核心技术.</span></span></li><li><span class="name"><span class="innerContentContainer">LTE在20mHz频谱下能提供326Mb下行和86Mb上行的带宽。</span></span></li><li><span class="name"><span class="innerContentContainer">LTE有两种：</span></span><ul><li><span class="name"><span class="innerContentContainer">FDD: 频分双工. FDD占上风，产业链已经成形。</span></span></li><li><span class="name"><span class="innerContentContainer">TDD: 时分双工. TDD落后好几年。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">这两套方案，都利用 OFDM 绕开高通公司的 CDMA 核心技术专利，4G时代高通的地位将下降。</span></span></li><li><span class="name"><span class="innerContentContainer">LTE不再支持电路交换技术, 只能进行全IP网络下的包交换。那么如何支持语言业务呢？有三种方案：</span></span><ul><li><span class="name"><span class="innerContentContainer">VOLTE</span></span></li><li><span class="name"><span class="innerContentContainer">CSFB: 当有语言电话时，手机使用原有2G/3G网络。</span></span></li><li><span class="name"><span class="innerContentContainer">SVLTE: 同CSFB。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">LTE支持的语音编码</span></span><ul><li><span class="name"><span class="innerContentContainer">AMR-NB编码</span></span><ul><li><span class="name"><span class="innerContentContainer">采样率是 3.5KHz.</span></span></li><li><span class="name"><span class="innerContentContainer">适用于窄带.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">AMR-WB编码</span></span><ul><li><span class="name"><span class="innerContentContainer">采样率是 16KHz.</span></span></li><li><span class="name"><span class="innerContentContainer">适用于宽带. 推荐使用.</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">3G如何升级到4G？</span></span><ul><li><span class="name"><span class="innerContentContainer">WCDMA 由HSPA 升级到 HSPA+，再升级到LTE-FDD，是最顺的。</span></span></li><li><span class="name"><span class="innerContentContainer">TD-SCDMA 由 HSDPA 升级到 LTE-TDD，会非常痛苦。</span></span></li><li><span class="name"><span class="innerContentContainer">CDMA由 EV-DO 升级到 LTE-FDD，非常痛苦。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">LTE-TDD不是TD-SCDMA的后一代演进</span></span><ul><li><span class="name"><span class="innerContentContainer">两者仅10%的物理层协议、以及帧结构能共用.</span></span></li><li><span class="name"><span class="innerContentContainer">而且演进较困难。</span></span></li><li><span class="name"><span class="innerContentContainer">国内故意叫LTE-TDD为TD-LTE，心态奇怪。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">中国移动的基站数</span></span><ul><li><span class="name"><span class="innerContentContainer">近30万TD-SCDMA个基站，以及60万个GSM基站。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">手机接收性能</span></span><ul><li><span class="name"><span class="innerContentContainer">手机信号特点: 手机发射功率大，接收功率小. </span></span></li><li><span class="name"><span class="innerContentContainer">接收性能是瓶颈. 影响因素有:</span></span></li><li><span class="name"><span class="innerContentContainer">灵敏度</span></span><ul><li><span class="name"><span class="innerContentContainer">手机灵敏度是手机全向接受灵敏度的简称，即TIS，用于度量手机接收性能。</span></span></li><li><span class="name"><span class="innerContentContainer">灵敏度受制于如下因素:</span></span></li><li><span class="name"><span class="innerContentContainer">天线质量</span></span></li><li><span class="name"><span class="innerContentContainer">天线方向性</span></span></li><li><span class="name"><span class="innerContentContainer">结构（金属结构件的分布）</span></span></li><li><span class="name"><span class="innerContentContainer">高频信号干扰</span></span><ul><li><span class="name"><span class="innerContentContainer">高频信号指3MHz以上的信号，手机中一般重点关注30MHz以上的。</span></span></li><li><span class="name"><span class="innerContentContainer">高频信号具有如下特点:</span></span><ul><li><span class="name"><span class="innerContentContainer">波长短、功率大;</span></span></li><li><span class="name"><span class="innerContentContainer">对周围信号干扰大;</span></span></li><li><span class="name"><span class="innerContentContainer">易被周围信号干扰等。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">手机中有哪些高频信号?</span></span><ul><li><span class="name"><span class="innerContentContainer">晶振信号不算特别高频，影响不大。</span></span></li><li><span class="name"><span class="innerContentContainer">camera、音频、wifi、sd卡等时钟在50M左右，对灵敏度一般影响都很大。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">发射功率, 受制于天线性能和手机rf模块。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">基带芯片</span></span><ul><li><span class="name"><span class="innerContentContainer">用来合成即将发射的基带信号，或对接受到的基带信号进行解码的芯片。</span></span></li><li><span class="name"><span class="innerContentContainer">基带芯片的组成部分</span></span><ul><li><span class="name"><span class="innerContentContainer">CPU处理器</span></span></li><li><span class="name"><span class="innerContentContainer">信道编码器</span></span></li><li><span class="name"><span class="innerContentContainer">数字信号处理器</span></span></li><li><span class="name"><span class="innerContentContainer">调制解调器</span></span></li><li><span class="name"><span class="innerContentContainer">接口模块</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">长连接慢心跳</span></span><ul><li><span class="name"><span class="innerContentContainer">一般当基带空闲超过一定时间后，运营商的IP网关会自动释放（关闭）连接。</span></span></li><li><span class="name"><span class="innerContentContainer">前各家所使用PUSH通道的实现原理虽然同为『长连接慢心跳』，但这个『慢』字却有很大的文章。</span></span></li><li><span class="name"><span class="innerContentContainer">Google在Android系统中使用无线网络连接GSM的PUSH通道时，默认采用的心跳周期是28分钟，这才是所谓“慢”的含义 —— 尽可能降低心跳的频度，以达到省电的目的。</span></span></li><li><span class="name"><span class="innerContentContainer">但这个全球绝大部分地区都行得通的规则，到了中国大陆就出现了问题。</span></span></li><li><span class="name"><span class="innerContentContainer">以中移动的2.5G网络为例，经过粗略测试，大约5分钟左右的基带空闲，连接就会被释放，这就是为什么微信选择以『5分钟』为周期发送连接心跳。</span></span></li><li><span class="name"><span class="innerContentContainer">这也是为什么Google的PUSH通道经常『迟到』的原因。</span></span></li><li><span class="name"><span class="innerContentContainer">当我们活跃使用手机时，由于基带往往并不会闲置，所以部分掩盖了问题的本质。</span></span></li><li><span class="name"><span class="innerContentContainer">当连接到Wi-Fi时，宽带的网关一般没有空闲释放机制，所以长连接会得到保持，这也进一步减少了我们平时遭遇的PUSH迟到。</span></span></li><li><span class="name"><span class="innerContentContainer">『5分钟』的心跳周期到底是什么概念？可以理解为，每部安装了微信的Android设备每天发送近300条短信（其实占用的信令资源还远超这个数量）。</span></span></li><li><span class="name"><span class="innerContentContainer">还意味着每天你的手机将被从待机省电状态唤醒近300次，每次相当于打一个几秒钟的电话。</span></span></li><li><span class="name"><span class="innerContentContainer">粗略测算，一般的Android手机每天有超过15-20%的电量被消耗在发送过度频繁的心跳上。</span></span></li><li><span class="name"><span class="innerContentContainer">大陆行货渠道发售的Android手机都无法使用Google的PUSH通道，原本每个手机中只需要建立的唯一共享的PUSH通道，被人为分裂，以至于每一个声称为用户提供实时通知的国内App，基本都在重复上面微信所做的行为。</span></span></li><li><span class="name"><span class="innerContentContainer">当你的手机中同时安装了多个这类App时，无论手机的耗电，还是运营商的信令负担，都要数倍于上述情形。</span></span></li><li><span class="name"><span class="innerContentContainer">2G网络的基础结构和协议并未针对IP传输优化，其服务IP链路的信令承载能力相对较弱，而TD-SCDMA又长期得不到真正的发展，导致中移动的2.5G网络承受了超龄超载的负荷。</span></span></li><li><span class="name"><span class="innerContentContainer">现在各个ROM厂商尝试自建PUSH通道, 统一心跳.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">高通双卡双待方案</span></span><ul><li><span class="name"><span class="innerContentContainer">高通双卡双待方案的文档</span></span><ul><li><span class="name"><span class="innerContentContainer">BB: 80-vm151-41</span></span></li><li><span class="name"><span class="innerContentContainer">RF:80-vc467-47</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">双卡双待的两种方案</span></span><ul><li><span class="name"><span class="innerContentContainer">双通，要求必须有两个基带芯片</span></span></li><li><span class="name"><span class="innerContentContainer">单通，可以共享射频芯片、天线和协议栈</span></span></li><li><span class="name"><span class="innerContentContainer">高通w+g方案, 只支持单通。</span></span></li><li><span class="name"><span class="innerContentContainer">c+w双卡双待, 则不能共用RTR芯片，但可共用天线。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">两个号码如何共享基带？</span></span><ul><li><span class="name"><span class="innerContentContainer">主要是利用分时执行的方式，特定时间只给一个号码用.</span></span></li><li><span class="name"><span class="innerContentContainer">只要独占的时间片足够小，能确保两个卡的接通率。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">天线使用情况: 高通方案只需要一个天线。</span></span></li><li><span class="name"><span class="innerContentContainer">两个网络page侦听时隙的冲突处理方案</span></span><ul><li><span class="name"><span class="innerContentContainer">假定A优先：</span></span></li><li><span class="name"><span class="innerContentContainer">AB不同时，无影响；</span></span></li><li><span class="name"><span class="innerContentContainer">A先B后，B的时隙cancel；</span></span></li><li><span class="name"><span class="innerContentContainer">A后B先，B可得到时隙，但在A发生时cancel。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">HyBird模式</span></span><ul><li><span class="name"><span class="innerContentContainer">高通的双卡双待方案基于HyBird模式，可分时隙监听网络。</span></span></li><li><span class="name"><span class="innerContentContainer">有明确的冲突处理流程。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">双卡双待方案的关注点   <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">是两个modem芯片，还是一个;</span></span></li><li><span class="name"><span class="innerContentContainer">支持哪两种网络；</span></span></li><li><span class="name"><span class="innerContentContainer">内存如何管理，是各用各的，还是同用一个；</span></span></li><li><span class="name"><span class="innerContentContainer">启动流程，谁启动谁； </span></span></li><li><span class="name"><span class="innerContentContainer">射频参数如何管理，如何校准； </span></span></li><li><span class="name"><span class="innerContentContainer">音频参数如何管理，如何校准；</span></span></li><li><span class="name"><span class="innerContentContainer">关机流程，谁发起，如何互通状态，谁负责下电； </span></span></li><li><span class="name"><span class="innerContentContainer">异常管理，异常等级，如何通知对方，谁负责复位系统；</span></span></li><li><span class="name"><span class="innerContentContainer">快速进待机，快速注册；</span></span></li><li><span class="name"><span class="innerContentContainer">音频codec如何用； </span></span></li><li><span class="name"><span class="innerContentContainer">蓝牙耳机打电话如何用；</span></span></li><li><span class="name"><span class="innerContentContainer">AT命令，如何识别目标modem； </span></span></li><li><span class="name"><span class="innerContentContainer">DTMF音频管理；</span></span></li><li><span class="name"><span class="innerContentContainer">USB口管理，和调试有关。</span></span></li><li><span class="name"><span class="innerContentContainer">功耗数据。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">频段调试步骤   <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">PA开关有没有电压，通路可不可以用；</span></span></li><li><span class="name"><span class="innerContentContainer">能不能搜网注册；</span></span></li><li><span class="name"><span class="innerContentContainer">搜网异常时的两个提示：（1）emergency only： 搜到其它网络；（2）no service： 没有搜到任何网络</span></span></li><li><span class="name"><span class="innerContentContainer">能不能打电话。</span></span></li><li><span class="name"><span class="innerContentContainer">使用屏蔽盒可以解决G1900的注册问题。（这个是已知问题，是高通的bug，如果现网中有1800，手机永远会先注册这个网，而不会注册1900）。</span></span></li><li><span class="name"><span class="innerContentContainer">确认qcn是否ok。搞不定找高通人过来。</span></span></li><li><span class="name"><span class="innerContentContainer">界定仪器无问题，做一下交换测试。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">数据业务</span></span><ul><li><span class="name"><span class="innerContentContainer">PS, packet switch（数据业务）, 指数据业务</span></span></li><li><span class="name"><span class="innerContentContainer">CS, circuit switch（电路交换）, 指语音业务</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">手机上互联网的原理</span></span><ul><li><span class="name"><span class="innerContentContainer">分别由如下几层完成：</span></span></li><li><span class="name"><span class="innerContentContainer">PDP</span></span><ul><li><span class="name"><span class="innerContentContainer">就是手机协议栈的data call的封装. </span></span></li><li><span class="name"><span class="innerContentContainer">其中profile为配置信息，包括:</span></span><ul><li><span class="name"><span class="innerContentContainer">接入点APN（网关）</span></span></li><li><span class="name"><span class="innerContentContainer">连接类型（IP/PPP）</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络侧也可以激活PDP.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">PPP</span></span><ul><li><span class="name"><span class="innerContentContainer">这一层负责完成IP地址，IP由网络侧负责分配，具体网元是GGSN，后者是GPRS网到互联网的网关。</span></span></li><li><span class="name"><span class="innerContentContainer">PPP相当于数据链路层。</span></span></li><li><span class="name"><span class="innerContentContainer">手机在移动过程, 为什么IP不会变? </span></span><ul><li><span class="name"><span class="innerContentContainer">只要不是长时间不掉线，就不会改变。</span></span></li><li><span class="name"><span class="innerContentContainer">PPP就是处理这个事的。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">TCP/IP</span></span><ul><li><span class="name"><span class="innerContentContainer">就是互联网。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">CTNET</span></span><ul><li><span class="name"><span class="innerContentContainer">手机直接裸露在互联网当中，互联网中的服务器能够直接与手机进行数据传递.</span></span></li><li><span class="name"><span class="innerContentContainer">有些服务器会按照ip段逐一扫描发送数据请求，休眠的手机收到这种请求就会出现唤醒进行处理，导致功耗较高。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">CTWAP</span></span><ul><li><span class="name"><span class="innerContentContainer">手机通过代理进行数据业务，代理会为手机过滤掉互联网中服务器主动发送的数据请求，所以手机对于互联网中的服务器是透明的，服务器只看得到代理，因此手机端的数据处理会少一些。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">中国电信需求</span></span><ul><li><span class="name"><span class="innerContentContainer">电信要求，使用双模卡时，在海外如果没有cdma网络，手动/自动切为gsm网络，号码不变。只支持和电信签约的运营商，都是海外的，不包括移动联通。</span></span></li><li><span class="name"><span class="innerContentContainer">全球漫游卡</span></span><ul><li><span class="name"><span class="innerContentContainer">支持全球漫游功能的sim卡。</span></span></li><li><span class="name"><span class="innerContentContainer">可支持cdma/gsm双模，又叫双模卡。</span></span></li><li><span class="name"><span class="innerContentContainer">双卡手机中，两个卡槽都要能支持双模卡，但sim2上只支持gsm。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">二次选网</span></span><ul><li><span class="name"><span class="innerContentContainer">这个是中国电信的要求，只在海外能用。</span></span></li><li><span class="name"><span class="innerContentContainer">指对于双模卡，在初次选网（手机开机后自主的搜网动作）的基础上，根据不同地区要求，重新进行第二次搜网。</span></span></li><li><span class="name"><span class="innerContentContainer">初次选网相当于确定当前所在地区，知道所在地区后，如果发现初次选错网了，重新选网。</span></span></li><li><span class="name"><span class="innerContentContainer">快速启动功会影响二次选网</span></span><ul><li><span class="name"><span class="innerContentContainer">原因是快速启动时，手机并没有真正重启，就的协议相关的参数还是维持上次的，因此影响二次选网用例的测试。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">电信对单卡和双卡手机的定位不一样</span></span><ul><li><span class="name"><span class="innerContentContainer">单卡用户是电信固有客户，已经习惯电信的业务和要求，电信给的补贴多，要求也多；</span></span></li><li><span class="name"><span class="innerContentContainer">双卡用户主要定位在争取其他运营商用户，所以很多要求要松一些。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">卡和搜网</span></span><ul><li><span class="name"><span class="innerContentContainer">ESN: CDMA手机的唯一序号，存在手机上。32位长。</span></span></li><li><span class="name"><span class="innerContentContainer">MEID: cdma手机越来越多，ESN不够用，衍生MEID。它有56位长。</span></span></li><li><span class="name"><span class="innerContentContainer">pESN: 但是很多网元还是使用ESN，所以通过SHA-1算法讲MEID压缩为24位，并加80为前缀，即为pESN。这叫pESN/MEID兼容性。</span></span></li><li><span class="name"><span class="innerContentContainer">1x下上网无法接到来电? </span></span><ul><li><span class="name"><span class="innerContentContainer">cdma网络的固有问题。注意，来电没有任何提示。</span></span></li><li><span class="name"><span class="innerContentContainer">原因是1x的是数据语音双通道的网络模式，在该模式下只能使用一种或者是上网或者是语音。</span></span></li><li><span class="name"><span class="innerContentContainer">而3g的话是语音数据向分开的，通话不受影响。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">1x下上网无法接到来电的解决办法</span></span><ul><li><span class="name"><span class="innerContentContainer">号码开通呼叫等待。</span></span></li><li><span class="name"><span class="innerContentContainer">操作办法：*74听到提示音确认后挂断即可，取消呼叫等待*740。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">CDMA Ev-Do</span></span><ul><li><span class="name"><span class="innerContentContainer">Do的意思是Data Only.也就是说电信的3G只能传输数据，不能传输语音。用户在打电话时会跳转到CDMA 1x网络，只能传输语音。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">获取sim卡状态的命令行</span></span><ul><li><span class="name"><span class="innerContentContainer">adb下输入命令： getprop gsm.sim.state 可获取sim卡状态，没有则为 ABSENT。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">携号转网</span></span><ul><li><span class="name"><span class="innerContentContainer">sim卡存的是imsi，手机号即msisdn，是保存在HLR中的。所以携号转网无技术难度。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">随卡方案</span></span><ul><li><span class="name"><span class="innerContentContainer">开机过程中根据sim卡的信息来确定国家和语言。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">频点切换</span></span><ul><li><span class="name"><span class="innerContentContainer">对于EVDO来说，只依据与信道的信号强度而不会去考虑信道的负载，当候选集里面的频点信号强度在一定时间内优于切换门限功率时，便会发生频点的切换。</span></span></li><li><span class="name"><span class="innerContentContainer">同一个基站下的数据业务容量是有个上限的</span></span><ul><li><span class="name"><span class="innerContentContainer">手机接入成功后，就会占据一定的容量。</span></span></li><li><span class="name"><span class="innerContentContainer">同一个基站下，一般20-30左右同时在线，用户体验还可以，超过了30用户体验速度就会比较慢。</span></span></li><li><span class="name"><span class="innerContentContainer">基站侧可以设定最多允许多少个用户接入，有的设置为90，根据运营商要求设置。超过的接入不进去了。</span></span></li></ul></li></ul></li></ul></li></ul>
  </body>
</html>