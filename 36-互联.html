<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">36-互联</span></span><ul><li><span class="name"><span class="innerContentContainer">多种无线接入方式的简单对比数据 <span class="contentTag" title="Filter @iFile">@<span class="contentTagText">iFile</span><span class="contentTagNub"></span></span></span></span></li><li><span class="name"><span class="innerContentContainer">WiFi</span></span><ul><li><span class="name"><span class="innerContentContainer">WiFi的全称是Wireless Fidelity，无线保真技术。属于在办公室和家庭中使用的短距离无线技术。</span></span></li><li><span class="name"><span class="innerContentContainer">WiFi覆盖范围可达90米左右，且可穿墙。</span></span></li><li><span class="name"><span class="innerContentContainer">wifi和wlan是不是同一个概念？</span></span><ul><li><span class="name"><span class="innerContentContainer">应该这么讲，在国外，这个是同一个概念，因为wifi是wlan的唯一实例。</span></span></li><li><span class="name"><span class="innerContentContainer">但在中国，还有个WAPI标准。</span></span></li><li><span class="name"><span class="innerContentContainer">不过WAPI其实就是wifi, 在WiFi协议栈上加了一层安全机制, 但是这个安全层也不甚可靠.</span></span></li><li><span class="name"><span class="innerContentContainer">WAPI每台收费6人民币，wifi标准目前免费。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wifi和wimax有什么区别?</span></span><ul><li><span class="name"><span class="innerContentContainer">项目           WiFi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WiMax</span></span></li><li><span class="name"><span class="innerContentContainer">标准IEEE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;802.11a/b/g &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IEEE&nbsp;802.16a/d/e</span></span></li><li><span class="name"><span class="innerContentContainer">多址方式 &nbsp; &nbsp; &nbsp;CKK、OFDM &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OFDM/FDD、TDD</span></span></li><li><span class="name"><span class="innerContentContainer">频带 &nbsp; &nbsp; &nbsp; &nbsp; 2.4GHz，不要许可证 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2-11GHz，部分不要许可证</span></span></li><li><span class="name"><span class="innerContentContainer">最高速率 &nbsp; &nbsp; &nbsp;54Mb/s &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;＞70Mb/s</span></span></li><li><span class="name"><span class="innerContentContainer">业务 &nbsp; &nbsp; &nbsp; &nbsp; 话音与数据 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;话音、数据、视频图像</span></span></li><li><span class="name"><span class="innerContentContainer">覆盖 &nbsp; &nbsp; &nbsp; &nbsp; 微蜂窝 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 宏蜂窝（＜50km）</span></span></li><li><span class="name"><span class="innerContentContainer">移动性 &nbsp; &nbsp; &nbsp; 静止、步行 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;静止、步行</span></span></li><li><span class="name"><span class="innerContentContainer">频谱利用率 &nbsp; &nbsp;＜2.7bps/Hz &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3.75bps/Hz</span></span></li><li><span class="name"><span class="innerContentContainer">成熟度 &nbsp; &nbsp; &nbsp; 很好 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 不成熟</span></span></li><li><span class="name"><span class="innerContentContainer">终端 &nbsp; &nbsp; &nbsp; &nbsp; PC卡 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;智能信息设备、PC卡</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wifi使用的频段</span></span><ul><li><span class="name"><span class="innerContentContainer">2.4G. 也有5G频段的，较少.</span></span></li><li><span class="name"><span class="innerContentContainer">带宽是20M，一般分为14个信道（channel），编号为1-14。</span></span></li><li><span class="name"><span class="innerContentContainer">该频段为免费频段。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WiFi的功能</span></span><ul><li><span class="name"><span class="innerContentContainer">STA：wifi接入(核心)</span></span><ul><li><span class="name"><span class="innerContentContainer">有三个主流程:</span></span></li><li><span class="name"><span class="innerContentContainer">打开/关闭设备</span></span></li><li><span class="name"><span class="innerContentContainer">扫描/鉴权</span></span></li><li><span class="name"><span class="innerContentContainer">数据传输</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">AP：软件(虚拟)热点</span></span></li><li><span class="name"><span class="innerContentContainer">wifi direct：WiFi直连</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wifi芯片</span></span><ul><li><span class="name"><span class="innerContentContainer">博通芯片</span></span><ul><li><span class="name"><span class="innerContentContainer">4329（用于10年）</span></span></li><li><span class="name"><span class="innerContentContainer">4330（用于11-12年）</span></span></li><li><span class="name"><span class="innerContentContainer">优点是稳定、复合程度高，有三合一、四合一、五合一，目前主打，就是比较贵。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">高通wcn: 高通主打芯片，不稳定，但高通免费送，且强推。</span></span></li><li><span class="name"><span class="innerContentContainer">ath: 被高通收购. 便宜，不稳定。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">硬件管脚</span></span><ul><li><span class="name"><span class="innerContentContainer">REG_ON:上电</span></span></li><li><span class="name"><span class="innerContentContainer">WLAN_WAKEUP_MSM: 唤醒管脚</span></span></li><li><span class="name"><span class="innerContentContainer">CMD</span></span></li><li><span class="name"><span class="innerContentContainer">CLK</span></span></li><li><span class="name"><span class="innerContentContainer">DATA 1-4</span></span><ul><li><span class="name"><span class="innerContentContainer">我们手机上clk配置的是25M。</span></span></li><li><span class="name"><span class="innerContentContainer">BC的 wifi芯片，需要连接 37.4M的晶振。</span></span></li></ul></li></ul></li><li><span class="name"></span></li><li><span class="name"><span class="innerContentContainer">802.11协议族</span></span><ul><li><span class="name"><span class="innerContentContainer">只需要关注三个：</span></span></li><li><span class="name"><span class="innerContentContainer">802.11b，1999年，11Mbit/s；</span></span></li><li><span class="name"><span class="innerContentContainer">802.11g，2007年，54Mbit/s；</span></span></li><li><span class="name"><span class="innerContentContainer"><b>802.11n</b>，2009年，支持MIMO技术（多重输入输出），带宽最高达600Mb/s。</span></span></li><li><span class="name"><span class="innerContentContainer">另外, 802.11x, 即 winmax，目前已死。wifi和winmax都是inter在主力支持。</span></span></li><li><span class="name"><span class="innerContentContainer">一般WIFI设备仅支持到 11n的 65Mb/s。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">802.11协议栈的分层 （6层）</span></span><ul><li><span class="name"><span class="innerContentContainer">PHY：硬件</span></span></li><li><span class="name"><span class="innerContentContainer"> MAC：介质访问控制（以上这两层为硬件层）</span></span><ul><li><span class="name"><span class="innerContentContainer">把数据链路层分为两层: 偏硬件的介质访问控制层和偏软件的数据逻辑链路层。</span></span></li><li><span class="name"><span class="innerContentContainer">新出的通讯协议一般都是如此.</span></span></li><li><span class="name"><span class="innerContentContainer">因为介质访问控制一般作为 fireware放在硬件了。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">&nbsp;LLC（数据逻辑链路）</span></span></li><li><span class="name"><span class="innerContentContainer">IP</span></span></li><li><span class="name"><span class="innerContentContainer">TCP&nbsp;</span></span></li><li><span class="name"><span class="innerContentContainer">APP（应用）</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络拓扑结构</span></span><ul><li><span class="name"><span class="innerContentContainer">Station(STA)</span></span><ul><li><span class="name"><span class="innerContentContainer">STA, 工作站，即客户端设备。</span></span></li><li><span class="name"><span class="innerContentContainer">任何设备只要拥有 IEEE 802.11 的 MAC 层和 PHY 层的接口，就可称为一个工作站。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Station Services (SS)</span></span><ul><li><span class="name"><span class="innerContentContainer">在安全方面，还提供了身份确认服务(Authentication)和隐密性服务(Privacy).</span></span></li><li><span class="name"><span class="innerContentContainer">工作站服务，软件概念。提</span></span></li><li><span class="name"><span class="innerContentContainer">供工作站送收资料的服务.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Access Point (AP)</span></span><ul><li><span class="name"><span class="innerContentContainer">AP即热点，也叫接入点.</span></span></li><li><span class="name"><span class="innerContentContainer">通常在一个 BSA 内只会有一个AP。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Basic Service Area (BSA)</span></span><ul><li><span class="name"><span class="innerContentContainer">即一个wifi子网，最小的子网即一个热点和一个STA。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">BSS (Basic Service Set，基础服务集): BSA中所有STA的集合。</span></span></li><li><span class="name"><span class="innerContentContainer">Distribute System (DS)</span></span><ul><li><span class="name"><span class="innerContentContainer">分布式系统，通常是由有线网络所构成，可将数个 BSA 连结起来。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Extended Service Area (ESA)</span></span><ul><li><span class="name"><span class="innerContentContainer">数个 BSAs 经由 DS 连结在一起，所形成的区域，就叫作一个扩充服务区。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">ESS</span></span><ul><li><span class="name"><span class="innerContentContainer">ESA中上所有STA的集合.</span></span></li><li><span class="name"><span class="innerContentContainer">STA在ESS中的移动（即wifi漫游）对上层不可见，SSID不变，IP地址不变。（适合商业环境）</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">SSID: service set ID，服务集识别码</span></span><ul><li><span class="name"><span class="innerContentContainer">需要单独配置的参数：加密方式、SSID名、接入限制、隐藏SSID；</span></span></li><li><span class="name"><span class="innerContentContainer">多SSID可共用的参数：信道、功率、速率等。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>WiFi需求规格</b></span></span><ul><li><span class="name"><span class="innerContentContainer">开关WIFI</span></span><ul><li><span class="name"><span class="innerContentContainer">除了在WIFI设置界面可以开关WIFI，还有其他的入口可以开关，要查看这些开关状态是否一致。</span></span></li><li><span class="name"><span class="innerContentContainer">还有就是飞行模式对WIFI开关的影响，由于WIFI开和关都有一个时间过程，而飞行模式的开关瞬间完成，所以有时会出现冲突。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">开关新可用网络提醒</span></span><ul><li><span class="name"><span class="innerContentContainer">新可用网络的定义是自WIFI模块开启后，从未发现过的，为加密的网络。</span></span></li><li><span class="name"><span class="innerContentContainer">只有满足了新可用网络的定义，才会有提醒。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">手动添加网络</span></span><ul><li><span class="name"><span class="innerContentContainer">可手动输入SIID，网络加密类型，密码。</span></span></li><li><span class="name"><span class="innerContentContainer">需要路由器关闭SIID广播。</span></span></li><li><span class="name"><span class="innerContentContainer">如果路由器隐藏了SSID，手动添加的网络是无法连接的。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">设置静态IP</span></span><ul><li><span class="name"><span class="innerContentContainer">android对IP输入的限制是整数0到整数255之间，也就是说0000.000200.001.001这样一个IP都能合法输入。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">芯片自动扫描</span></span><ul><li><span class="name"><span class="innerContentContainer">wifi打开后，芯片会自动开始扫描。</span></span></li><li><span class="name"><span class="innerContentContainer">扫描方式分为:</span></span></li><li><span class="name"><span class="innerContentContainer">主动方式：主动发 prob req命令给周边设备。</span></span></li><li><span class="name"><span class="innerContentContainer">被动方式</span></span><ul><li><span class="name"><span class="innerContentContainer">被动就是接受 ap发的命令.</span></span></li><li><span class="name"><span class="innerContentContainer">我们只支持被动。</span></span></li><li><span class="name"><span class="innerContentContainer">扫描周期是7秒。</span></span></li><li><span class="name"><span class="innerContentContainer">如果有连接上的（即通过鉴权），就不再扫描。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">应用发起的扫描</span></span><ul><li><span class="name"><span class="innerContentContainer">进入settings wifi设置菜单后，MScanner类会周期性的发起扫描.</span></span></li><li><span class="name"><span class="innerContentContainer">G版本是6秒一次，I版本是10秒一次。</span></span></li><li><span class="name"><span class="innerContentContainer">无论是否连接上，都会持续扫描。</span></span></li><li><span class="name"><span class="innerContentContainer">退出界面就不扫了。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">休眠设置</span></span><ul><li><span class="name"><span class="innerContentContainer">WIFI模块是用电大户.</span></span></li><li><span class="name"><span class="innerContentContainer">WIFI开启后会更改电池状态等其他状态。关闭WIFI时，android的策略是卸载驱动来省电。如有缺失就是问题。</span></span></li><li><span class="name"><span class="innerContentContainer">为了省电，android提供了WiFi休眠策略，可以设置为: 永远不断开，充电时不断开和锁屏时断开这三种。</span></span></li><li><span class="name"><span class="innerContentContainer">要测试休眠设置是否有效，可以在路由器上PING手机的IP，PING通就是连接状态。</span></span></li><li><span class="name"><span class="innerContentContainer">部分手机会选择忽略该项设置, 无论选哪个都会一直保持连接，锁屏后15分钟再休眠。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">代码结构及初始化</span></span><ul><li><span class="name"><span class="innerContentContainer">app</span></span><ul><li><span class="name"><span class="innerContentContainer">WifiSettings类, 在系统设置中显示.</span></span></li><li><span class="name"><span class="innerContentContainer">WifiEnabler类，打开成功后，将 wifi_DB 写入 Settings_DB。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">framework</span></span><ul><li><span class="name"><span class="innerContentContainer">模块</span></span><ul><li><span class="name"><span class="innerContentContainer">netd（daemon）</span></span></li><li><span class="name"><span class="innerContentContainer">dnasmasq</span></span></li><li><span class="name"><span class="innerContentContainer"><b>wpa_suppliant</b>（wifi开源协议栈，目前为主流）</span></span><ul><li><span class="name"><span class="innerContentContainer"><b>wpa_suppliant</b>是一个安全中间件，为各种无线网卡提供统一的安全机制.</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">初始化流程</span></span><ul><li><span class="name"><span class="innerContentContainer">在 SystemServer 启动的时候,会生成一个 ConnectivityService的实例.</span></span></li><li><span class="name"><span class="innerContentContainer">ConnectivityService的构造函数会创建WifiService. <b>WifiService</b>负责启动关闭wpa_supplicant、启动关闭.</span></span><ul><li><span class="name"><span class="innerContentContainer">WifiService extends SystemService，它是运行在进程SystemService中的一个线程, 常驻内存。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WifiStateTracker 负责创建 WifiMonitor 接收来自底层的事件. <b>WifiMonitor </b>监视线程和把命令下发给wpa_supplicant, 然后从wpa_supplicant接收事件通知。</span></span></li><li><span class="name"><span class="innerContentContainer"><b>WifiService和WifiMonitor是整个模块的核心。</b></span></span></li><li><span class="name"><span class="innerContentContainer"><b>WifiManager</b>（接口层，状态刷新也是找它）提供api封装。WiFi应用继承它。</span></span><ul><li><span class="name"><span class="innerContentContainer">WifiManager 通过 Binder 调用 WifiService。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">HAL</span></span><ul><li><span class="name"><span class="innerContentContainer">frameworks/base/core/jni/android_net_wifi_Wifi.cpp， android_net_wifi_loadDriver()。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">driver</span></span><ul><li><span class="name"><span class="innerContentContainer">wifi driver</span></span></li><li><span class="name"><span class="innerContentContainer">SDIO driver</span></span><ul><li><span class="name"><span class="innerContentContainer">sdio_readsb ；sdio_writesb：高通SD模块的FIFO读写</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">初始化流程</span></span><ul><li><span class="name"><span class="innerContentContainer">wifi.c（hal）</span></span></li><li><span class="name"><span class="innerContentContainer">通过socket通讯</span></span></li><li><span class="name"><span class="innerContentContainer">kernel加载wifi.ko（动态加载）</span></span><ul><li><span class="name"><span class="innerContentContainer">hardware\libhardware_legacy\wifi\wifi.c，Wifi_load_driver()</span></span></li><li><span class="name"><span class="innerContentContainer">调用insmod()加载 /system/lib/modules/librasdioif.ko 和 /wifi/dhd.ko，</span></span></li><li><span class="name"><span class="innerContentContainer">安装librasdioif.ko。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">驱动层: module_init() </span></span><ul><li><span class="name"><span class="innerContentContainer">SD模块驱动安装成功的标志: /sys/devices/platform/msm_sdcc.2/polling</span></span></li><li><span class="name"><span class="innerContentContainer">调用bcm_wifi_load_driver()，加载博通芯片驱动</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">DHD_open() </span></span></li><li><span class="name"><span class="innerContentContainer">从 nvram中读出信道、国家码等信息</span></span></li><li><span class="name"><span class="innerContentContainer">php_init()，启动协议栈。</span></span></li><li><span class="name"><span class="innerContentContainer">至此，drv层的设备初始化完成。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">WiFi校准</span></span><ul><li><span class="name"><span class="innerContentContainer">nvram是什么？</span></span><ul><li><span class="name"><span class="innerContentContainer">/system/wlan/broadcom/nvram.txt 目录下，为txt文件，保存wifi的校准数据。</span></span></li><li><span class="name"><span class="innerContentContainer">为博通芯片用的。</span></span></li><li><span class="name"><span class="innerContentContainer">高通芯片也有类似的方案，但是叫 calcdata。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">自校准方案</span></span><ul><li><span class="name"><span class="innerContentContainer">博通芯片内置自校准，不用外界干预。</span></span></li><li><span class="name"><span class="innerContentContainer">高通芯片不支持，需要外部控制校准，所以产线上需要增设一个WT工位。</span></span></li><li><span class="name"><span class="innerContentContainer">目前高通正在做自校准方案，不成熟。</span></span></li><li><span class="name"><span class="innerContentContainer">每出一个产品都需要投递手机给高通重新调试，周期在一周以上。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>网络连接过程</b></span></span><ul><li><span class="name"><span class="innerContentContainer">打开WiFi</span></span><ul><li><span class="name"><span class="innerContentContainer">WirelessSettings在初始化的时候配置了由WifiEnabler来处理Wifi按钮.</span></span></li><li><span class="name"><span class="innerContentContainer">当用户按下Wifi按钮后, Android会调用 WifiEnabler的onPreferenceChange(), 再由WifiEnabler调用WifiManager的 setWifiEnabled().</span></span></li><li><span class="name"><span class="innerContentContainer">通过AIDL,实际调用的是 WifiService的setWifiEnabled(), WifiService接着向自身发送一条 MESSAGE_ENABLE_WIFI消息, 在处理该消息的代码中<b>做真正的使能工作.</b></span></span><ul><li><span class="name"><span class="innerContentContainer">首先装载WIFI内核模块 (该模块的位置硬编码为"/system/lib/modules/wlan.ko" ), </span></span></li><li><span class="name"><span class="innerContentContainer">然后启动 wpa_supplicant (配置文件硬编码为 "/data/misc/wifi/wpa_supplicant.conf"), </span></span></li><li><span class="name"><span class="innerContentContainer">再通过 WifiStateTracker来启动 WifiMonitor中的监视线程.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">当使能成功后,会广播发送 WIFI_STATE_CHANGED_ACTION 这个Intent通知外界WIFI已经成功使能了 。</span></span></li><li><span class="name"><span class="innerContentContainer">WifiEnabler创建的时候就会向 Android 注册接收 WIFI_STATE_CHANGED_ACTION, 因此它会收到该 Intent, 从而开始扫描. </span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">查找AP</span></span><ul><li><span class="name"><span class="innerContentContainer">扫描的入口函数是 WifiService的startScan(), 它其实也就是往 wpa_supplicant发送 SCAN命令。</span></span></li><li><span class="name"><span class="innerContentContainer">当wpa_supplicant处理完SCAN命令后,它会向控制通道发送事件通知扫描完成,从而 wifi_wait_for_event() 会接收到该事件, 然后WifiMonitor中的 MonitorThread()会被执行来出来这个事件。</span></span></li><li><span class="name"><span class="innerContentContainer">WifiStateTracker则接着广播发送 SCAN_RESULTS_AVAILABLE_ACTION 这个Intent。</span></span></li><li><span class="name"><span class="innerContentContainer">WifiLayer注册了接收 SCAN_RESULTS_AVAILABLE_ACTION 这个Intent, 所以它的相关处理函数 handleScanResultsAvailable()会被调用.</span></span></li><li><span class="name"><span class="innerContentContainer">在该函数中,先会去拿到SCAN的结果(最终是 往wpa_supplicant发送 SCAN_RESULT命令并读取返回值来实现的), </span></span><ul><li><span class="name"><span class="innerContentContainer">List&lt;ScanResult&gt; list = mWifiManager.getScanResults();</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">对每一个扫描返回的AP,WifiLayer会调用 WifiSettings的 onAccessPointSetChanged(), 从而最终把该AP加到GUI显示列表中。</span></span></li><li><span class="name"><span class="innerContentContainer">需要上报的数据包括ssid、bssid、proto等。</span></span></li><li><span class="name"><span class="innerContentContainer">每个扫描周期上报一次，即6秒或10秒。</span></span></li><li><span class="name"><span class="innerContentContainer">找到的AP都会上报; AP数量没有明确的上限。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">配置AP参数</span></span><ul><li><span class="name"><span class="innerContentContainer">当用户在WifiSettings界面上选择了一个AP后,会显示配置AP参数的一个对话框。</span></span></li><li><span class="name"><span class="innerContentContainer">showAccessPointDialog(state, AccessPointDialog.MODE_INFO);</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">连接AP</span></span><ul><li><span class="name"><span class="innerContentContainer">当用户在 AcessPointDialog 中选择好加密方式和输入密钥之后,再点击连接按钮, Android就会去连接这个AP。</span></span></li><li><span class="name"><span class="innerContentContainer">WifiLayer会先检测这个AP是不是之前被配置过,这个是通过向 wpa_supplicant发送 LIST_NETWORK 命令并且比较返回值来实现的.</span></span></li><li><span class="name"><span class="innerContentContainer">// Need WifiConfiguration for the AP</span></span></li><li><span class="name"><span class="innerContentContainer">WifiConfiguration config = findConfiguredNetwork(state);</span></span></li><li><span class="name"><span class="innerContentContainer">如果wpa_supplicant没有这个AP的配置信息,则会向 wpa_supplicant发送 ADD_NETWORK命令来添加该AP.</span></span></li><li><span class="name"><span class="innerContentContainer">ADD_NETWORK 命令会返回一个ID, WifiLayer再用这个返回的ID作为参数向 wpa_supplicant 发送ENABLE_NETWORK命令, 从而让 wpa_supplicant 去连接该AP。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">配置IP地址</span></span><ul><li><span class="name"><span class="innerContentContainer">当wpa_supplicant成功连接上AP之后,它会向控制通道发送事件通知连接上AP了,从而 wifi_wait_for_event()会接收到该事件, 由此WifiMonitor中的MonitorThread()会被执行来出来这个事件.</span></span></li><li><span class="name"><span class="innerContentContainer">WifiMonitor再调用WifiStateTracker的notifyStateChange(), WifiStateTracker则接着会往自身发送 EVENT_DHCP_START 消息来启动DHCP去获取IP地址.</span></span></li><li><span class="name"><span class="innerContentContainer">然后再广播发送 NETWORK_STATE_CHANGED_ACTION这个Intent</span></span></li><li><span class="name"><span class="innerContentContainer">WifiLayer注册了接收 NETWORK_STATE_CHANGED_ACTION 这个Intent,所以它的相关处理函数handleNetworkStateChanged() 会被调用.</span></span></li><li><span class="name"><span class="innerContentContainer">当DHCP拿到IP地址之后,会再发送E VENT_DHCP_SUCCEEDED消息.</span></span></li><li><span class="name"><span class="innerContentContainer">WifiLayer处理 EVENT_DHCP_SUCCEEDED消 息, 会再次广播发送.</span></span></li><li><span class="name"><span class="innerContentContainer">至此为止,整个连接过程完成.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">鉴权方案分为: </span></span><ul><li><span class="name"><span class="innerContentContainer">open（不需要鉴权）</span></span></li><li><span class="name"><span class="innerContentContainer">wep（密码）</span></span></li><li><span class="name"><span class="innerContentContainer">WPA/WPA2（密码）</span></span><ul><li><span class="name"><span class="innerContentContainer">最常见认证方案.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">EAP-SIM/EAPAKA鉴权（通过运营商鉴权，自动鉴权）</span></span></li><li><span class="name"><span class="innerContentContainer">WPS（一系列的简易鉴权方式）</span></span><ul><li><span class="name"><span class="innerContentContainer">WPS, 即Wi-Fi Protected Setup</span></span></li><li><span class="name"><span class="innerContentContainer">最常见的就是按下AP的wps键，自动鉴权，避免用户输入密码，即Push Button Config（PBC）</span></span></li><li><span class="name"><span class="innerContentContainer">Pin Input Config（PIN）</span></span></li><li><span class="name"><span class="innerContentContainer">USB Flash Drive Config（UFD）</span></span></li><li><span class="name"><span class="innerContentContainer">NFC Contactless Token Config（NFC）</span></span></li><li><span class="name"><span class="innerContentContainer">UDC（u盘）</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WPS的工作原理</span></span><ul><li><span class="name"><span class="innerContentContainer">对于STA来讲，还是需要密码，只是这个密码是AP传过来的，只是省了用户输入的步骤。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wifi密码缓存在哪里？</span></span><ul><li><span class="name"><span class="innerContentContainer">/data/misc/wifi/wpa_supplicant_conf 中，是明文保存。</span></span></li><li><span class="name"><span class="innerContentContainer">会记录所有连接过的ap信息。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">连接后，DHCP（分配IP）的过程</span></span><ul><li><span class="name"><span class="innerContentContainer">STA发出discover请求；</span></span></li><li><span class="name"><span class="innerContentContainer">AP回应effor包，其中包括IP、子网掩码、DNS、IP id这些信息；</span></span></li><li><span class="name"><span class="innerContentContainer">然后AP发出request指令，</span></span></li><li><span class="name"><span class="innerContentContainer">STA把IP配置完成后，刷新本地IP及网络配置; </span></span></li><li><span class="name"><span class="innerContentContainer">STA返回ack告知AP: 设备侧准备就绪。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">WiFi控制分为三大组件：</span></span><ul><li><span class="name"><span class="innerContentContainer">客户端程序，包括wpa_cli命令行或java图形界面程序，通过unix本地socket与wpa_supplicant daemon服务通信，发送命令并接收结果；</span></span></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant daemon服务，对应上述中间部分，功能是“上传下达”。</span></span><ul><li><span class="name"><span class="innerContentContainer">所有客户端通过它控制硬件网卡，通过发送字符串命令控制是否扫描AP，提取扫描结果和是否关联AP等操作，同时将驱动的执行状态发送给用户。</span></span></li><li><span class="name"><span class="innerContentContainer">该服务是设计支持多种无线网卡芯片，因此各个厂商共同提供了一个通用接口给wpa_supplicant调用.</span></span></li><li><span class="name"><span class="innerContentContainer">在手机内存的/etc/wpa_supplicant.conf中我们可以直接看到WIFI支持的网络类型，每种类型都有例子，比如：</span></span><ul><li><span class="name"><span class="innerContentContainer"><span class="contentTag" title="Filter #Both">#<span class="contentTagText">Both</span><span class="contentTagNub"></span></span> WPA-PSK and WPA-EAP is accepted. Only CCMP is accepted as pairwise and</span></span></li><li><span class="name"><span class="innerContentContainer"># group cipher.</span></span></li><li><span class="name"><span class="innerContentContainer">#network={</span></span></li><li><span class="name"><span class="innerContentContainer"># ssid="example"</span></span></li><li><span class="name"><span class="innerContentContainer"># bssid=00:11:22:33:44:55</span></span></li><li><span class="name"><span class="innerContentContainer"># proto=WPA RSN</span></span></li><li><span class="name"><span class="innerContentContainer"># key_mgmt=WPA-PSK WPA-EAP</span></span></li><li><span class="name"><span class="innerContentContainer"># pairwise=CCMP</span></span></li><li><span class="name"><span class="innerContentContainer"># group=CCMP</span></span></li><li><span class="name"><span class="innerContentContainer"># psk=06b4be19da289f475aa46a33cb793029d4ab3db7a23ee92382eb0106c72ac7bb</span></span></li><li><span class="name"><span class="innerContentContainer">#}</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">不同类型的网络，不同的参数等等，应有尽有。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网卡驱动</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">beacon包</span></span><ul><li><span class="name"><span class="innerContentContainer">手机和AP通过beacon包维持连接。</span></span></li><li><span class="name"><span class="innerContentContainer">AP每隔100ms发给一次beacon广播。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>WiFi log</b></span></span><ul><li><span class="name"><span class="innerContentContainer">wpa_supplicant|wifi monitor</span></span></li><li><span class="name"><span class="innerContentContainer">wifi打开状态: 通过 wlan.driver.status 来确认。包括ok、locked等。</span></span></li><li><span class="name"><span class="innerContentContainer">确认wifi硬件状态</span></span><ul><li><span class="name"><span class="innerContentContainer">fopen /proc/modules，文本文件.</span></span></li><li><span class="name"><span class="innerContentContainer">如果其中有ar6000，则表示wifi已启动。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">加载驱动: E/WifiHW ( 1201): ==JOHN DEBUG==: [WIFI] Load Driver</span></span></li><li><span class="name"><span class="innerContentContainer">收到广播，WIFI状态正在开启</span></span><ul><li><span class="name"><span class="innerContentContainer">D/SettingsWifiEnabler( 1321): Received wifi state changed from Disabled to Enabling</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">电池状态改变</span></span><ul><li><span class="name"><span class="innerContentContainer">WIFI正在开启: D/WifiService( 1201): ACTION_BATTERY_CHANGED pluggedType: 2</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI硬件：加载内核模块</span></span><ul><li><span class="name"><span class="innerContentContainer">E/WifiHW(1201):==JOHNDEBUG==:moduleaddress:4b938008 filename:/system/lib/modules/dhd.ko args:firmware_path=/system/wlan/broadcom/rtecdc.bin nvram_path=/system/wlan/broadcom/nvram.txt</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI硬件：返回装载模块报告：返回指令0，未知错误0</span></span><ul><li><span class="name"><span class="innerContentContainer">E/WifiHW ( 1201): ==JOHN DEBUG==: return of insmod : ret = 0, Unknown error: 0</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知</span></span><ul><li><span class="name"><span class="innerContentContainer">I/wpa_supplicant( 2490): CTRL-EVENT-STATE-CHANGE id=-1 state=2</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WifiMonitor从wpa_supplicant接收事件通知</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiMonitor( 1201): Event [CTRL-EVENT-STATE-CHANGE id=-1 state=2]</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：准备好开始搜索网络了</span></span><ul><li><span class="name"><span class="innerContentContainer">I/wpa_supplicant( 2490): CTRL-EVENT-SCAN-RESULTS Ready</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：驱动命令行.主动搜索.LEN</span></span><ul><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd SCAN-ACTIVE len = 4096</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：驱动命令行.主动搜索.LEN</span></span><ul><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd SCAN-ACTIVE len = 0, 11</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：驱动命令行.被动搜索.LEN</span></span><ul><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd SCAN-PASSIVE len = 4096</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：驱动命令行.被动搜索.LEN=0.12</span></span><ul><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd SCAN-PASSIVE len = 0, 12</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">接收到广播：WIFI已经开启</span></span><ul><li><span class="name"><span class="innerContentContainer">D/SettingsWifiEnabler( 1321): Received wifi state changed from Enabling to Enabled</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知</span></span><ul><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd RSSI len = 4096</span></span></li><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd RSSI len = 4, 4</span></span></li><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd LINKSPEED len = 4096</span></span></li><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd LinkSpeed 54 len = 12, 12</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：驱动命令行.MAC地址.LEN</span></span><ul><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd MACADDR len = 4096</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：驱动命令行.MAC地址</span></span><ul><li><span class="name"><span class="innerContentContainer">E/wpa_supplicant( 2490): wpa_driver_priv_driver_cmd Macaddr = 44:A4:2D:27:25:BE</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知:尝试连接，（SSID='LosAngeles'频段=2412 MHz）</span></span><ul><li><span class="name"><span class="innerContentContainer">I/wpa_supplicant( 2490): Trying to associate with 1c:bd:b9:f6:a7:9f (SSID='LosAngeles' freq=2412 MHz)</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WifiMonitor接收wpa_supplicant的事件</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiMonitor( 1201):Event[Trying to associate with 1c:bd:b9:f6:a7:9f (SSID='LosAngeles' freq=2412 MHz)]</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WifiMonitor接收事件</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiMonitor( 1201): Event [CTRL-EVENT-STATE-CHANGE id=-1 state=3]</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI状态跟踪：更改请求状态：搜索中-&gt;匹配中</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiStateTracker( 1201): Changing supplicant state: SCANNING ==&gt; ASSOCIATING</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络状态跟踪：更新显示为正在连接状态</span></span><ul><li><span class="name"><span class="innerContentContainer">D/NetworkStateTracker( 1201): setDetailed state, ld =SCANNING and new state=CONNECTING</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">连接管理服务：改变WIFI连接状态：正在连接/正在连接</span></span><ul><li><span class="name"><span class="innerContentContainer">D/ConnectivityService( 1201): ConnectivityChange for WIFI: CONNECTING/CONNECTING</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI状态跟踪：更改请求状态：匹配中-&gt;已匹配</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiStateTracker( 1201): Changing supplicant state: ASSOCIATING ==&gt; ASSOCIATED</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络状态跟踪：更新显示为正在连接状态</span></span><ul><li><span class="name"><span class="innerContentContainer">D/NetworkStateTracker( 1201): setDetailed state, ld =CONNECTING and new state=CONNECTING</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：已和1c:bd:b9:f6:a7:9f匹配</span></span><ul><li><span class="name"><span class="innerContentContainer">I/wpa_supplicant( 2490): Associated with 1c:bd:b9:f6:a7:9f</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WifiMonitor接收wpa_supplicant的事件</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiMonitor( 1201): Event [Associated with 1c:bd:b9:f6:a7:9f]</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI状态跟踪：更改请求状态：已匹配-&gt;TCP中断连接</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiStateTracker( 1201): Changing supplicant state: ASSOCIATED ==&gt; FOUR_WAY_HANDSHAKE</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络状态跟踪：更新显示为鉴定中</span></span><ul><li><span class="name"><span class="innerContentContainer">D/NetworkStateTracker( 1201): setDetailed state, ld =CONNECTING and new state=AUTHENTICATING</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">连接管理服务：抛出WIFI连接状态改变：已连接/鉴定中</span></span><ul><li><span class="name"><span class="innerContentContainer">D/ConnectivityService( 1201): Dropping ConnectivityChange for WIFI: CONNECTING/AUTHENTICATING</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI状态跟踪：更改请求状态：TCP中断连接-&gt;确认标志位</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiStateTracker( 1201): Changing supplicant state: FOUR_WAY_HANDSHAKE ==&gt; GROUP_HANDSHAKE</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络状态跟踪：更新显示为鉴定中</span></span><ul><li><span class="name"><span class="innerContentContainer">D/NetworkStateTracker( 1201): setDetailed state, ld =AUTHENTICATING and new state=AUTHENTICATING</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WiFi状态跟踪：更新显示为搜索状态</span></span><ul><li><span class="name"><span class="innerContentContainer">D/NetworkStateTracker( 1201): setDetailed state, ld =IDLE and new state=SCANNING</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI状态跟踪：更改请求状态：搜索中-&gt;不活动</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiStateTracker( 1201): Changing supplicant state: SCANNING ==&gt; INACTIVE</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：WPA:与1c:bd:b9:f6:a7:9f确定标志位</span></span><ul><li><span class="name"><span class="innerContentContainer">I/wpa_supplicant( 2490): WPA: Key negotiation completed with 1c:bd:b9:f6:a7:9f [PTK=CCMP GTK=TKIP]</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：</span></span><ul><li><span class="name"><span class="innerContentContainer">I/wpa_supplicant( 2490): CTRL-EVENT-STATE-CHANGE id=0 state=7</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wpa_supplicant发出事件通知：连接完成</span></span><ul><li><span class="name"><span class="innerContentContainer">I/wpa_supplicant( 2490): CTRL-EVENT-CONNECTED - Connection to 1c:bd:b9:f6:a7:9f completed (auth) [id=0 id_str=]</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WifiMonitor接收wpa_supplicant事件</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiMonitor( 1201): Event [WPA: Key negotiation completed with 1c:bd:b9:f6:a7:9f [PTK=CCMP GTK=TKIP]]</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WifiMonitor接收wpa_supplicant事件</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiMonitor( 1201): Event [CTRL-EVENT-STATE-CHANGE id=0 state=7]</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WifiMonitor接收wpa_supplicant事件</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiMonitor( 1201): Event [CTRL-EVENT-CONNECTED - Connection to 1c:bd:b9:f6:a7:9f completed (auth) [id=0 id_str=]]</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI状态跟踪：更改请求状态：确认标志位-&gt;完成</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiStateTracker( 1201): Changing supplicant state: GROUP_HANDSHAKE ==&gt; COMPLETED</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI状态跟踪：新网络状态为已连接</span></span><ul><li><span class="name"><span class="innerContentContainer">V/WifiStateTracker( 1201): New network state is CONNECTED</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络状态跟踪：更新显示为获取IP地址</span></span><ul><li><span class="name"><span class="innerContentContainer">D/NetworkStateTracker( 1201): setDetailed state, ld =AUTHENTICATING and new state=OBTAINING_IPADDR</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">连接管理服务：取消该WIFI连接</span></span><ul><li><span class="name"><span class="innerContentContainer">D/ConnectivityService( 1201): Dropping ConnectivityChange for WIFI: CONNECTING/OBTAINING_IPADDR</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">中国电信c+w功能</span></span><ul><li><span class="name"><span class="innerContentContainer">中国电信部署了3种热点，</span></span></li><li><span class="name"><span class="innerContentContainer">要求支持c+w功能的手机在搜ap时，按照 latest ssid &gt; customized ssid（电信热点）&gt; normal ssid 的优先级来连接。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">BT和wifi共用天线的问题</span></span><ul><li><span class="name"><span class="innerContentContainer">共用天线时，一旦芯片发现wifi beacon包有丢失，会调高优先级保证wifi数据.</span></span></li><li><span class="name"><span class="innerContentContainer">此时BT连接很容易失败。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">BT</span></span><ul><li><span class="name"><span class="innerContentContainer">蓝牙芯片一般使用博通的。</span></span></li><li><span class="name"><span class="innerContentContainer">频段</span></span><ul><li><span class="name"><span class="innerContentContainer">使用2.4G的频段。</span></span></li><li><span class="name"><span class="innerContentContainer">这个频段在全球都是免费的，包括 wifi/微波炉也用它。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络结构</span></span><ul><li><span class="name"><span class="innerContentContainer">蓝牙设备分主从，拓扑结构为树状，即一个从设备只有一个主设备，但一个主设备可以有多个从设备。</span></span></li><li><span class="name"><span class="innerContentContainer">从设备只能和主设备通讯, 而不能和同一个主设备的其它从设备通讯。</span></span></li><li><span class="name"><span class="innerContentContainer">一个主设备及其从设备构成一个“<b>微微网</b>”。</span></span></li><li><span class="name"><span class="innerContentContainer">一个设备可以同时是主设备和另一个微微网的从设备。</span></span></li><li><span class="name"><span class="innerContentContainer">主从可以变换关系。根据蓝牙协议，从设备可以发出“role switch”命令，并得到主设备同意，就可以完成关系切换。这个地方经常出问题。</span></span></li><li><span class="name"><span class="innerContentContainer">主从一体。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">代码结构</span></span><ul><li><span class="name"><span class="innerContentContainer">代码分为 core 和 profile 两部分。</span></span></li><li><span class="name"><span class="innerContentContainer">core 即协议部分，一般很少出问题。</span></span></li><li><span class="name"><span class="innerContentContainer">profile即业务逻辑部分。为新需求和bug的高发区。</span></span><ul><li><span class="name"><span class="innerContentContainer">profile非常多，常用的有如下3种：</span></span></li><li><span class="name"><span class="innerContentContainer">传文件</span></span><ul><li><span class="name"><span class="innerContentContainer">OPP是对外传输。</span></span></li><li><span class="name"><span class="innerContentContainer">FTP是主动索取（华为手机不支持）。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">打电话：即蓝牙耳机</span></span></li><li><span class="name"><span class="innerContentContainer">听音乐</span></span><ul><li><span class="name"><span class="innerContentContainer">有多种协议，包括AIDP、AVDTP（音频视频分发传输协议）。</span></span></li><li><span class="name"><span class="innerContentContainer">蓝牙听音乐的一个特殊地方是对音频的解码是放在蓝牙芯片上的。</span></span></li><li><span class="name"><span class="innerContentContainer">耳机上的音频控制经常会失效。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">低功耗蓝牙</span></span><ul><li><span class="name"><span class="innerContentContainer">工作状态: </span></span></li><li><span class="name"><span class="innerContentContainer">待机状态: </span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">蓝牙拉距测试的指标：10米。</span></span></li><li><span class="name"><span class="innerContentContainer">问题定位:</span></span><ul><li><span class="name"><span class="innerContentContainer">先抓包. 看两边的指令序列是否是按规范来, 时间间隔是否OK.</span></span></li><li><span class="name"><span class="innerContentContainer">有专门的软件看日志.</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">NFC</span></span><ul><li><span class="name"><span class="innerContentContainer">功能</span></span><ul><li><span class="name"><span class="innerContentContainer">读卡：做pos机用，卡刷手机。简称别人刷它。</span></span></li><li><span class="name"><span class="innerContentContainer">卡模拟：做nfc卡用，刷别的pos机。简称它刷别人。</span></span></li><li><span class="name"><span class="innerContentContainer">P2P：两个手机互传文件或电话本。简称互刷。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">NFC芯片的管脚</span></span><ul><li><span class="name"><span class="innerContentContainer">VEnable（使能）</span></span></li><li><span class="name"><span class="innerContentContainer">INT（中断）</span></span></li><li><span class="name"><span class="innerContentContainer">DATA（数据）接到CPU上。</span></span></li><li><span class="name"><span class="innerContentContainer">clk_req（时钟请求）</span></span></li><li><span class="name"><span class="innerContentContainer">clk（时钟）接到PMU上。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">NFC电源</span></span><ul><li><span class="name"><span class="innerContentContainer">VBAT（电源）接到电池引脚上，所以没有电池nfc就无法使用。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">clk模式</span></span><ul><li><span class="name"><span class="innerContentContainer">分动态模式和静态模式，根据clk_req来调整。这部分稳定性比较差。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">代码</span></span><ul><li><span class="name"><span class="innerContentContainer">java应用层：nfc Service。</span></span></li><li><span class="name"><span class="innerContentContainer">JNI和fw层：核心是libnfc.so，为nxp协议的实现。代码在 extern/libnfc_hxp/ 下。</span></span></li><li><span class="name"><span class="innerContentContainer">nfc模块没有hal层。fw之下直接就是drv了，代码在 /kernel/../nxp544.c。</span></span></li><li><span class="name"><span class="innerContentContainer">nfc参数表放在 /data/misc/nfc/eedata.cfg。nfc模块启动后将其写入寄存器。</span></span><ul><li><span class="name"><span class="innerContentContainer">参数格式：一行一字段，字段前三行为地址，第4项为值。</span></span></li></ul></li></ul></li></ul></li></ul>
  </body>
</html>