<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">36-互联_USB</span></span><ul><li><span class="name"><span class="innerContentContainer">多种无线接入方式的简单对比数据 <span class="contentTag" title="Filter @iFile">@<span class="contentTagText">iFile</span><span class="contentTagNub"></span></span></span></span></li><li><span class="name"><span class="innerContentContainer">USB传输速率的优化经验（MTP）  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">没有并行的使用usb，而是采用传输--处理--传输的方式。改为改为并行方式，最佳情况下速率可提高一倍。</span></span></li><li><span class="name"><span class="innerContentContainer">sd卡写操作是一个瓶颈，可以绕开vfs接口，直接用驱动接口（要先从vfs上unmount sd卡）。</span></span></li><li><span class="name"><span class="innerContentContainer">更新sql，要和其它逻辑并行，因为这些sql数据，都是被动收到的信息，不影响后续逻辑，缓存起来慢慢写没有问题。</span></span></li><li><span class="name"><span class="innerContentContainer">各层buffer都使用乒乓buffer，两个满了再等待。或者用buffer队列。</span></span></li><li><span class="name"><span class="innerContentContainer">buffer放大到64K。</span></span></li><li><span class="name"><span class="innerContentContainer">上层直接用底层buffer，可减少若干次memcpy。要注意，上层要及时读走数据。</span></span></li><li><span class="name"><span class="innerContentContainer">收到的文件放在底层写。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">通讯问题必须先分清是链路层问题还是应用层问题  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">链路层不问数据内容，主要收到正确即返回ACK；这个响应很快。</span></span></li><li><span class="name"><span class="innerContentContainer">应用层要解析数据内容后，再根据内容是否正确做适当响应；这个响应很慢。</span></span></li><li><span class="name"><span class="innerContentContainer">Response 是链路层，还是应用层? 如果是链路层，则只要收到就会ACK；如果是应用层，则必须识别后才能response.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">设计通讯协议的关注项  <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">字节序。x86和arm正好相反，需要注意。</span></span></li><li><span class="name"><span class="innerContentContainer">4字节对齐；非常容易出问题。</span></span></li><li><span class="name"><span class="innerContentContainer">常见错误是字段类型的预期不一致。length字段的宽度要统一，4字节还是2字节；</span></span></li><li><span class="name"><span class="innerContentContainer">字符串编码，是utf8还是ascii/GBT。</span></span></li><li><span class="name"><span class="innerContentContainer">字符串是用C字符串，还是Pascal字符串；</span></span></li><li><span class="name"><span class="innerContentContainer">数组的实现，比如MTP数组在开始有4字节的长度。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI</span></span><ul><li><span class="name"><span class="innerContentContainer">WiFi的全称是Wireless Fidelity，无线保真技术。属于在办公室和家庭中使用的短距离无线技术。</span></span></li><li><span class="name"><span class="innerContentContainer">WiFi覆盖范围可达90米左右，且可穿墙。</span></span></li><li><span class="name"><span class="innerContentContainer">wifi和wlan是不是同一个概念？</span></span><ul><li><span class="name"><span class="innerContentContainer">应该这么讲，在国外，这个是同一个概念，因为wifi是wlan的唯一实例。</span></span></li><li><span class="name"><span class="innerContentContainer">但在中国，还有个WAPI标准。</span></span></li><li><span class="name"><span class="innerContentContainer">不过WAPI其实就是wifi, 在WiFi协议栈上加了一层安全机制, 但是这个安全层也不甚可靠.</span></span></li><li><span class="name"><span class="innerContentContainer">WAPI每台收费6人民币，wifi标准目前免费。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">802.11协议族</span></span><ul><li><span class="name"><span class="innerContentContainer">只需要关注三个：</span></span></li><li><span class="name"><span class="innerContentContainer">802.11b，1999年，11Mbit/s；</span></span></li><li><span class="name"><span class="innerContentContainer">802.11g，2007年，54Mbit/s；</span></span></li><li><span class="name"><span class="innerContentContainer"><b>802.11n</b>，2009年，支持MIMO技术（多重输入输出），带宽最高达600Mb/s。</span></span></li><li><span class="name"><span class="innerContentContainer">另外, 802.11x, 即 winmax，目前已死。wifi和winmax都是inter在主力支持。</span></span></li><li><span class="name"><span class="innerContentContainer">一般WIFI设备仅支持到 11n的 65Mb/s。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">802.11协议栈的分层 （6层）</span></span><ul><li><span class="name"><span class="innerContentContainer">PHY：硬件</span></span></li><li><span class="name"><span class="innerContentContainer"> MAC：介质访问控制（以上这两层为硬件层）</span></span><ul><li><span class="name"><span class="innerContentContainer">把数据链路层分为两层: 偏硬件的介质访问控制层和偏软件的数据逻辑链路层。</span></span></li><li><span class="name"><span class="innerContentContainer">新出的通讯协议一般都是如此.</span></span></li><li><span class="name"><span class="innerContentContainer">因为介质访问控制一般作为 fireware放在硬件了。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">&nbsp;LLC（数据逻辑链路）</span></span></li><li><span class="name"><span class="innerContentContainer">IP</span></span></li><li><span class="name"><span class="innerContentContainer">TCP&nbsp;</span></span></li><li><span class="name"><span class="innerContentContainer">APP（应用）</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wifi使用的频段</span></span><ul><li><span class="name"><span class="innerContentContainer">2.4G. 也有5G频段的，较少.</span></span></li><li><span class="name"><span class="innerContentContainer">带宽是20M，一般分为14个信道（channel），编号为1-14。</span></span></li><li><span class="name"><span class="innerContentContainer">该频段为免费频段。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络拓扑结构</span></span><ul><li><span class="name"><span class="innerContentContainer">Station(STA)</span></span><ul><li><span class="name"><span class="innerContentContainer">STA, 工作站，即客户端设备。</span></span></li><li><span class="name"><span class="innerContentContainer">任何设备只要拥有 IEEE 802.11 的 MAC 层和 PHY 层的接口，就可称为一个工作站。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Station Services (SS)</span></span><ul><li><span class="name"><span class="innerContentContainer">在安全方面，还提供了身份确认服务(Authentication)和隐密性服务(Privacy).</span></span></li><li><span class="name"><span class="innerContentContainer">工作站服务，软件概念。提</span></span></li><li><span class="name"><span class="innerContentContainer">供工作站送收资料的服务.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Access Point (AP)</span></span><ul><li><span class="name"><span class="innerContentContainer">AP即热点，也叫接入点.</span></span></li><li><span class="name"><span class="innerContentContainer">通常在一个 BSA 内只会有一个AP。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Basic Service Area (BSA)</span></span><ul><li><span class="name"><span class="innerContentContainer">即一个wifi子网，最小的子网即一个热点和一个STA。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">BSS (Basic Service Set，基础服务集): BSA中所有STA的集合。</span></span></li><li><span class="name"><span class="innerContentContainer">Distribute System (DS)</span></span><ul><li><span class="name"><span class="innerContentContainer">分布式系统，通常是由有线网络所构成，可将数个 BSA 连结起来。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Extended Service Area (ESA)</span></span><ul><li><span class="name"><span class="innerContentContainer">数个 BSAs 经由 DS 连结在一起，所形成的区域，就叫作一个扩充服务区。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">ESS</span></span><ul><li><span class="name"><span class="innerContentContainer">ESA中上所有STA的集合.</span></span></li><li><span class="name"><span class="innerContentContainer">STA在ESS中的移动（即wifi漫游）对上层不可见，SSID不变，IP地址不变。（适合商业环境）</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">SSID: service set ID，服务集识别码</span></span><ul><li><span class="name"><span class="innerContentContainer">需要单独配置的参数：加密方式、SSID名、接入限制、隐藏SSID；</span></span></li><li><span class="name"><span class="innerContentContainer">多SSID可共用的参数：信道、功率、速率等。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">WiFi的功能</span></span><ul><li><span class="name"><span class="innerContentContainer">STA：wifi接入(核心)</span></span><ul><li><span class="name"><span class="innerContentContainer">有三个主流程:</span></span></li><li><span class="name"><span class="innerContentContainer">打开/关闭设备</span></span></li><li><span class="name"><span class="innerContentContainer">扫描/鉴权</span></span></li><li><span class="name"><span class="innerContentContainer">数据传输</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">AP：软件(虚拟)热点</span></span></li><li><span class="name"><span class="innerContentContainer">wifi direct：WiFi直连</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wifi芯片</span></span><ul><li><span class="name"><span class="innerContentContainer">博通芯片</span></span><ul><li><span class="name"><span class="innerContentContainer">4329（用于10年）</span></span></li><li><span class="name"><span class="innerContentContainer">4330（用于11-12年）</span></span></li><li><span class="name"><span class="innerContentContainer">优点是稳定、复合程度高，有三合一、四合一、五合一，目前主打，就是比较贵。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">高通wcn: 高通主打芯片，不稳定，但高通免费送，且强推。</span></span></li><li><span class="name"><span class="innerContentContainer">ath: 被高通收购. 便宜，不稳定。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">硬件管脚</span></span><ul><li><span class="name"><span class="innerContentContainer">REG_ON:上电</span></span></li><li><span class="name"><span class="innerContentContainer">WLAN_WAKEUP_MSM: 唤醒管脚</span></span></li><li><span class="name"><span class="innerContentContainer">CMD</span></span></li><li><span class="name"><span class="innerContentContainer">CLK</span></span></li><li><span class="name"><span class="innerContentContainer">DATA 1-4</span></span><ul><li><span class="name"><span class="innerContentContainer">我们手机上clk配置的是25M。</span></span></li><li><span class="name"><span class="innerContentContainer">BC的 wifi芯片，需要连接 37.4M的晶振。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">代码结构</span></span><ul><li><span class="name"><span class="innerContentContainer">app</span></span><ul><li><span class="name"><span class="innerContentContainer">app层的设备初始化流程</span></span><ul><li><span class="name"><span class="innerContentContainer">WifiSettings类</span></span></li><li><span class="name"><span class="innerContentContainer">WifiEnabler类，打开成功后，将 wifi_DB 写入 Settings_DB。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">framework</span></span><ul><li><span class="name"><span class="innerContentContainer">模块</span></span><ul><li><span class="name"><span class="innerContentContainer">netd（daemon）</span></span></li><li><span class="name"><span class="innerContentContainer">dnasmasq</span></span></li><li><span class="name"><span class="innerContentContainer"><b>wpa_suppliant</b>（wifi开源协议栈，目前为主流）</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">初始化流程</span></span><ul><li><span class="name"><span class="innerContentContainer">WifiManager（接口层，状态刷新也是找它）。应用一般继承它。</span></span></li><li><span class="name"><span class="innerContentContainer">WifiManager 通过 Binder 调用 WifiService。</span></span></li><li><span class="name"><span class="innerContentContainer">WifiService， extends SystemService，service线程的壳子。</span></span></li><li><span class="name"><span class="innerContentContainer">WifiServiceImpl，WifiService的核心代码。</span></span></li><li><span class="name"><span class="innerContentContainer">WifiStateTracker </span></span></li><li><span class="name"><span class="innerContentContainer">WifiMonitor</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">HAL</span></span><ul><li><span class="name"><span class="innerContentContainer">frameworks/base/core/jni/android_net_wifi_Wifi.cpp， android_net_wifi_loadDriver()。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">driver</span></span><ul><li><span class="name"><span class="innerContentContainer">wifi driver</span></span></li><li><span class="name"><span class="innerContentContainer">SDIO driver</span></span><ul><li><span class="name"><span class="innerContentContainer">sdio_readsb ；sdio_writesb：高通SD模块的FIFO读写</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">初始化流程</span></span><ul><li><span class="name"><span class="innerContentContainer">wifi.c（hal）</span></span></li><li><span class="name"><span class="innerContentContainer">通过socket通讯</span></span></li><li><span class="name"><span class="innerContentContainer">kernel加载wifi.ko（动态加载）</span></span><ul><li><span class="name"><span class="innerContentContainer">hardware\libhardware_legacy\wifi\wifi.c，Wifi_load_driver()</span></span></li><li><span class="name"><span class="innerContentContainer">调用insmod()加载 /system/lib/modules/librasdioif.ko 和 /wifi/dhd.ko，</span></span></li><li><span class="name"><span class="innerContentContainer">安装librasdioif.ko。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">驱动层: module_init() </span></span><ul><li><span class="name"><span class="innerContentContainer">SD模块驱动安装成功的标志: /sys/devices/platform/msm_sdcc.2/polling</span></span></li><li><span class="name"><span class="innerContentContainer">调用bcm_wifi_load_driver()，加载博通芯片驱动</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">DHD_open() </span></span></li><li><span class="name"><span class="innerContentContainer">从 nvram中读出信道、国家码等信息</span></span></li><li><span class="name"><span class="innerContentContainer">php_init()，启动协议栈。</span></span></li><li><span class="name"><span class="innerContentContainer">至此，drv层的设备初始化完成。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">nvram是什么？</span></span><ul><li><span class="name"><span class="innerContentContainer">/system/wlan/broadcom/nvram.txt 目录下，为txt文件，保存wifi的校准数据。</span></span></li><li><span class="name"><span class="innerContentContainer">为博通芯片用的。</span></span></li><li><span class="name"><span class="innerContentContainer">高通芯片也有类似的方案，但是叫 calcdata。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">自校准方案</span></span><ul><li><span class="name"><span class="innerContentContainer">博通芯片内置自校准，不用外界干预。</span></span></li><li><span class="name"><span class="innerContentContainer">高通芯片不支持，需要外部控制校准，所以产线上需要增设一个WT工位。</span></span></li><li><span class="name"><span class="innerContentContainer">目前高通正在做自校准方案，不成熟。</span></span></li><li><span class="name"><span class="innerContentContainer">每出一个产品都需要投递手机给高通重新调试，周期在一周以上。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WiFi扫描过程</span></span><ul><li><span class="name"><span class="innerContentContainer">芯片自动扫描</span></span><ul><li><span class="name"><span class="innerContentContainer">wifi打开后，芯片会自动开始扫描。</span></span></li><li><span class="name"><span class="innerContentContainer">扫描方式分为:</span></span></li><li><span class="name"><span class="innerContentContainer">主动方式：主动发 prob req命令给周边设备。</span></span></li><li><span class="name"><span class="innerContentContainer">被动方式</span></span><ul><li><span class="name"><span class="innerContentContainer">被动就是接受 ap发的命令.</span></span></li><li><span class="name"><span class="innerContentContainer">我们只支持被动。</span></span></li><li><span class="name"><span class="innerContentContainer">扫描周期是7秒。</span></span></li><li><span class="name"><span class="innerContentContainer">如果有连接上的（即通过鉴权），就不再扫描。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">应用发起的扫描</span></span><ul><li><span class="name"><span class="innerContentContainer">进入settings wifi设置菜单后，MScanner类会周期性的发起扫描.</span></span></li><li><span class="name"><span class="innerContentContainer">G版本是6秒一次，I版本是10秒一次。</span></span></li><li><span class="name"><span class="innerContentContainer">无论是否连接上，都会持续扫描。</span></span></li><li><span class="name"><span class="innerContentContainer">退出界面就不扫了。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>网络连接过程</b></span></span><ul><li><span class="name"><span class="innerContentContainer">找到AP后上报的流程</span></span><ul><li><span class="name"><span class="innerContentContainer">需要上报的数据包括ssid、bssid、proto等。</span></span></li><li><span class="name"><span class="innerContentContainer">每个扫描周期上报一次，即6秒或10秒。</span></span></li><li><span class="name"><span class="innerContentContainer">找到多少AP都上报; AP数量没有明确的上限。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">鉴权方案</span></span><ul><li><span class="name"><span class="innerContentContainer">open（不需要鉴权）</span></span></li><li><span class="name"><span class="innerContentContainer">wep（密码）</span></span></li><li><span class="name"><span class="innerContentContainer">WPA/WPA2（密码）</span></span><ul><li><span class="name"><span class="innerContentContainer">最常见认证方案.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">EAP-SIM/EAPAKA鉴权（通过运营商鉴权，自动鉴权）</span></span></li><li><span class="name"><span class="innerContentContainer">WPS（一系列的简易鉴权方式）</span></span><ul><li><span class="name"><span class="innerContentContainer">WPS, 即Wi-Fi Protected Setup</span></span></li><li><span class="name"><span class="innerContentContainer">最常见的就是按下AP的wps键，自动鉴权，避免用户输入密码，即Push Button Config（PBC）</span></span></li><li><span class="name"><span class="innerContentContainer">Pin Input Config（PIN）</span></span></li><li><span class="name"><span class="innerContentContainer">USB Flash Drive Config（UFD）</span></span></li><li><span class="name"><span class="innerContentContainer">NFC Contactless Token Config（NFC）</span></span></li><li><span class="name"><span class="innerContentContainer">UDC（u盘）</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WPS的工作原理</span></span><ul><li><span class="name"><span class="innerContentContainer">对于STA来讲，还是需要密码，只是这个密码是AP传过来的，只是省了用户输入的步骤。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wifi密码缓存在哪里？</span></span><ul><li><span class="name"><span class="innerContentContainer">/data/misc/wifi/wpa_supplicant_conf 中，是明文保存。</span></span></li><li><span class="name"><span class="innerContentContainer">会记录所有连接过的ap信息。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">连接后，DHCP（分配IP）的过程</span></span><ul><li><span class="name"><span class="innerContentContainer">STA发出discover请求；</span></span></li><li><span class="name"><span class="innerContentContainer">AP回应effor包，其中包括IP、子网掩码、DNS、IP id这些信息；</span></span></li><li><span class="name"><span class="innerContentContainer">然后AP发出request指令，</span></span></li><li><span class="name"><span class="innerContentContainer">STA把IP配置完成后，刷新本地IP及网络配置; </span></span></li><li><span class="name"><span class="innerContentContainer">STA返回ack告知AP: 设备侧准备就绪。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">beacon包</span></span><ul><li><span class="name"><span class="innerContentContainer">手机和AP通过beacon包维持连接。</span></span></li><li><span class="name"><span class="innerContentContainer">AP每隔100ms发给一次beacon广播。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">wifi log</span></span><ul><li><span class="name"><span class="innerContentContainer">wpa_supplicant</span></span></li><li><span class="name"><span class="innerContentContainer">wifi monitor</span></span></li><li><span class="name"><span class="innerContentContainer">wifi打开状态: 通过 wlan.driver.status 来确认。包括ok、locked等。</span></span></li><li><span class="name"><span class="innerContentContainer">确认wifi硬件状态</span></span><ul><li><span class="name"><span class="innerContentContainer">fopen /proc/modules，文本文件.</span></span></li><li><span class="name"><span class="innerContentContainer">如果其中有ar6000，则表示wifi已启动。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">中国电信c+w功能</span></span><ul><li><span class="name"><span class="innerContentContainer">中国电信部署了3种热点，</span></span></li><li><span class="name"><span class="innerContentContainer">要求支持c+w功能的手机在搜ap时，按照 latest ssid &gt; customized ssid（电信热点）&gt; normal ssid 的优先级来连接。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">BT和wifi共用天线的问题</span></span><ul><li><span class="name"><span class="innerContentContainer">共用天线时，一旦芯片发现wifi beacon包有丢失，会调高优先级保证wifi数据.</span></span></li><li><span class="name"><span class="innerContentContainer">此时BT连接很容易失败。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">BT</span></span><ul><li><span class="name"><span class="innerContentContainer">蓝牙芯片一般使用博通的。</span></span></li><li><span class="name"><span class="innerContentContainer">频段</span></span><ul><li><span class="name"><span class="innerContentContainer">使用2.4G的频段。</span></span></li><li><span class="name"><span class="innerContentContainer">这个频段在全球都是免费的，包括 wifi/微波炉也用它。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">网络结构</span></span><ul><li><span class="name"><span class="innerContentContainer">蓝牙设备分主从，拓扑结构为树状，即一个从设备只有一个主设备，但一个主设备可以有多个从设备。</span></span></li><li><span class="name"><span class="innerContentContainer">从设备只能和主设备通讯, 而不能和同一个主设备的其它从设备通讯。</span></span></li><li><span class="name"><span class="innerContentContainer">一个主设备及其从设备构成一个“<b>微微网</b>”。</span></span></li><li><span class="name"><span class="innerContentContainer">一个设备可以同时是主设备和另一个微微网的从设备。</span></span></li><li><span class="name"><span class="innerContentContainer">主从可以变换关系。根据蓝牙协议，从设备可以发出“role switch”命令，并得到主设备同意，就可以完成关系切换。这个地方经常出问题。</span></span></li><li><span class="name"><span class="innerContentContainer">主从一体。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">代码结构</span></span><ul><li><span class="name"><span class="innerContentContainer">代码分为 core 和 profile 两部分。</span></span></li><li><span class="name"><span class="innerContentContainer">core 即协议部分，一般很少出问题。</span></span></li><li><span class="name"><span class="innerContentContainer">profile即业务逻辑部分。为新需求和bug的高发区。</span></span><ul><li><span class="name"><span class="innerContentContainer">profile非常多，常用的有如下3种：</span></span></li><li><span class="name"><span class="innerContentContainer">传文件</span></span><ul><li><span class="name"><span class="innerContentContainer">OPP是对外传输。</span></span></li><li><span class="name"><span class="innerContentContainer">FTP是主动索取（华为手机不支持）。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">打电话：即蓝牙耳机</span></span></li><li><span class="name"><span class="innerContentContainer">听音乐</span></span><ul><li><span class="name"><span class="innerContentContainer">有多种协议，包括AIDP、AVDTP（音频视频分发传输协议）。</span></span></li><li><span class="name"><span class="innerContentContainer">蓝牙听音乐的一个特殊地方是对音频的解码是放在蓝牙芯片上的。</span></span></li><li><span class="name"><span class="innerContentContainer">耳机上的音频控制经常会失效。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">低功耗蓝牙</span></span><ul><li><span class="name"><span class="innerContentContainer">工作状态: </span></span></li><li><span class="name"><span class="innerContentContainer">待机状态: </span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">蓝牙拉距测试的指标：10米。</span></span></li><li><span class="name"><span class="innerContentContainer">问题定位:</span></span><ul><li><span class="name"><span class="innerContentContainer">先抓包. 看两边的指令序列是否是按规范来, 时间间隔是否OK.</span></span></li><li><span class="name"><span class="innerContentContainer">有专门的软件看日志.</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">NFC</span></span><ul><li><span class="name"><span class="innerContentContainer">功能</span></span><ul><li><span class="name"><span class="innerContentContainer">读卡：做pos机用，卡刷手机。简称别人刷它。</span></span></li><li><span class="name"><span class="innerContentContainer">卡模拟：做nfc卡用，刷别的pos机。简称它刷别人。</span></span></li><li><span class="name"><span class="innerContentContainer">P2P：两个手机互传文件或电话本。简称互刷。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">NFC芯片的管脚</span></span><ul><li><span class="name"><span class="innerContentContainer">VEnable（使能）</span></span></li><li><span class="name"><span class="innerContentContainer">INT（中断）</span></span></li><li><span class="name"><span class="innerContentContainer">DATA（数据）接到CPU上。</span></span></li><li><span class="name"><span class="innerContentContainer">clk_req（时钟请求）</span></span></li><li><span class="name"><span class="innerContentContainer">clk（时钟）接到PMU上。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">NFC电源</span></span><ul><li><span class="name"><span class="innerContentContainer">VBAT（电源）接到电池引脚上，所以没有电池nfc就无法使用。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">clk模式</span></span><ul><li><span class="name"><span class="innerContentContainer">分动态模式和静态模式，根据clk_req来调整。这部分稳定性比较差。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">代码</span></span><ul><li><span class="name"><span class="innerContentContainer">java应用层：nfc Service。</span></span></li><li><span class="name"><span class="innerContentContainer">JNI和fw层：核心是libnfc.so，为nxp协议的实现。代码在 extern/libnfc_hxp/ 下。</span></span></li><li><span class="name"><span class="innerContentContainer">nfc模块没有hal层。fw之下直接就是drv了，代码在 /kernel/../nxp544.c。</span></span></li><li><span class="name"><span class="innerContentContainer">nfc参数表放在 /data/misc/nfc/eedata.cfg。nfc模块启动后将其写入寄存器。</span></span><ul><li><span class="name"><span class="innerContentContainer">参数格式：一行一字段，字段前三行为地址，第4项为值。</span></span></li></ul></li></ul></li></ul></li></ul>
  </body>
</html>