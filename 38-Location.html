<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">38-Location</span></span><ul><li><span class="name"><span class="innerContentContainer">谈谈室内定位技术  <span class="contentTag" title="Filter #TODO">#<span class="contentTagText">TODO</span><span class="contentTagNub"></span></span> </span></span></li><li><span class="name"><span class="innerContentContainer">定位方式的分类</span></span><ul><li><span class="name"><span class="innerContentContainer">纯GPS定位</span></span><ul><li><span class="name"><span class="innerContentContainer">定位数据来自GPS卫星。</span></span></li><li><span class="name"><span class="innerContentContainer">优势是准确, 没有移动网络也可以使用。缺点是:</span></span></li><li><span class="name"><span class="innerContentContainer">1. 比较耗电;</span></span></li><li><span class="name"><span class="innerContentContainer">2. 绝大部分用户默认不开启GPS模块;</span></span></li><li><span class="name"><span class="innerContentContainer">3. 首次定位, 一般需要较长时间, 甚至可能要几分钟.</span></span></li><li><span class="name"><span class="innerContentContainer">4. 室内基本无法使用.</span></span></li><li><span class="name"><span class="innerContentContainer">2和3比较致命.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">基站定位</span></span><ul><li><span class="name"><span class="innerContentContainer">大致思路是采集手机上的基站ID(cell ID) 和其它的一些信息(MNC, MCC, LAC等), 然后通过网络访问一些定位服务. 比如百度或高德。</span></span></li><li><span class="name"><span class="innerContentContainer">这些服务提供者有一些数据库, 提前做好了cell ID所在位置的经纬度等等信息, 通过查表以及简单算法(比如三点定位法), 获取设备位置. </span></span></li><li><span class="name"><span class="innerContentContainer">其精度不如GPS;</span></span></li><li><span class="name"><span class="innerContentContainer">但好处是比较快, 而且可以在室内用, 只要有网络即可使用.</span></span></li><li><span class="name"><span class="innerContentContainer">有两种：</span></span></li><li><span class="name"><span class="innerContentContainer">cell-id，获取一个基站的信息即可完成定位，定位块，精度较差。</span></span></li><li><span class="name"><span class="innerContentContainer">OTDOA定位。要求获取周围3个以上基站的信息，定位精度比cell-id高。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">WIFI定位</span></span><ul><li><span class="name"><span class="innerContentContainer">和基站定位类似, 通过收集设备周围的WIFI, 然后访问网络, 通过服务获取经纬度.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Network Location</span></span><ul><li><span class="name"><span class="innerContentContainer">基站定位和WIFI定位都需要网络, 所以在Android系统中统称为Network Location.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">AGPS</span></span><ul><li><span class="name"><span class="innerContentContainer">即辅助GPS。在传统GPS基础上，采用基站和WIFI等辅助信息对GPS信息进行修正，以加快定位速度。</span></span></li><li><span class="name"><span class="innerContentContainer">AGPS依赖数据业务，从数据业务中获取星历、频率、位码等信息，尽快确认当前位置可用的卫星。星历数据包括：</span></span><ul><li><span class="name"><span class="innerContentContainer">轨道信息（天体坐标系）、时间、卫星状态等很多信息的。</span></span></li><li><span class="name"><span class="innerContentContainer">这中间包括了天体坐标到空间坐标的转换。</span></span></li><li><span class="name"><span class="innerContentContainer">手机的星历可以从GPS卫星数据中解析，也可以从AGPS服务器上下载。</span></span></li><li><span class="name"><span class="innerContentContainer">星历也有很多种。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">优势是速度快, 能将首次定位的时间缩减为7-8秒，而不是几十秒。而且准确度也略高于GPS。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">其它</span></span><ul><li><span class="name"><span class="innerContentContainer">CDMA网络下基站下发的系统参数消息SPM里面的BASE_LAT、BASE_LONG 2个值为基站天线的经纬度，可利用该信息来加速定位。</span></span></li><li><span class="name"><span class="innerContentContainer">高通GPSone方案的多层次定位</span></span><ul><li><span class="name"><span class="innerContentContainer">mcc/mnc，可获得National code；</span></span></li><li><span class="name"><span class="innerContentContainer">Base lat/long broadcast；</span></span></li><li><span class="name"><span class="innerContentContainer">cell -db；</span></span></li><li><span class="name"><span class="innerContentContainer">A-gps server；</span></span></li><li><span class="name"><span class="innerContentContainer">ODP GPS；</span></span></li><li><span class="name"><span class="innerContentContainer">wifi ap</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">GPS卫星系统</span></span><ul><li><span class="name"><span class="innerContentContainer">美国GPS卫星</span></span><ul><li><span class="name"><span class="innerContentContainer">24颗</span></span></li><li><span class="name"><span class="innerContentContainer">无源定位</span></span></li><li><span class="name"><span class="innerContentContainer">定位精度：分米级</span></span></li><li><span class="name"><span class="innerContentContainer">GPS对普通用户的设计精度为10米，结果实际精度达到了3米。</span></span><ul><li><span class="name"><span class="innerContentContainer">从统计学角度，则意味着你的GPS位置，距离你的实际位置在30米内的概率是95%；对于高度读数，精度在45-100米的概率是95%。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">2000年，美国总统宣布，普通用户精度升级为1米。</span></span></li><li><span class="name"><span class="innerContentContainer">GPS地面监控部分（授时，必须；网维，非必须）</span></span><ul><li><span class="name"><span class="innerContentContainer">授时中心采用铯原子钟，保持24颗卫星的时间高精度一致。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">用户设备部分（GPS接收机）</span></span><ul><li><span class="name"><span class="innerContentContainer">包含天线，射频单元，基带处理单元，存储单元。</span></span></li><li><span class="name"><span class="innerContentContainer">主要目的是测量出GPS信号从卫星到接收机天线的传播时间，实时地计算出接收机的三维位置，三维速度和时间。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">俄罗斯GLONASS卫星</span></span><ul><li><span class="name"><span class="innerContentContainer">24颗</span></span></li><li><span class="name"><span class="innerContentContainer">无源定位</span></span></li><li><span class="name"><span class="innerContentContainer">定位精度：分米级</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">欧洲伽利略卫星</span></span><ul><li><span class="name"><span class="innerContentContainer">30颗</span></span></li><li><span class="name"><span class="innerContentContainer">无源定位</span></span></li><li><span class="name"><span class="innerContentContainer">定位精度：米级</span></span></li><li><span class="name"><span class="innerContentContainer">计划2020年完工。届时将向全球提供定位精度在1~2m的免费服务和1米以内的付费服务。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">中国的“北斗”系统</span></span><ul><li><span class="name"><span class="innerContentContainer">45颗</span></span></li><li><span class="name"><span class="innerContentContainer">属于有源定位</span></span></li><li><span class="name"><span class="innerContentContainer">定位精度：十米级</span></span></li><li><span class="name"><span class="innerContentContainer">2019年4月20日，第44颗北斗导航卫星发射成功。标志北斗系统覆盖全球。</span></span></li><li><span class="name"><span class="innerContentContainer">北斗系统属于静止卫星定位系统。</span></span></li><li><span class="name"><span class="innerContentContainer">有源定位，用户终端应具有收发能力和应答功能。因此移动用户的数量将受限于系统的设计容量；终端也比较大。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">定位原理</span></span><ul><li><span class="name"><span class="innerContentContainer">简而言之就是3颗星可定位平面坐标，即3个3元2次方程可确定一个三元组（平面坐标，以及接收机的钟差）；4颗星可确定三维坐标，即4个4元2次方程可确定一个四元组（三维坐标，以及接收机的钟差）。</span></span></li><li><span class="name"><span class="innerContentContainer">上述四个方程式中：</span></span><ul><li><span class="name"><span class="innerContentContainer">x、y、z为待测点坐标，</span></span></li><li><span class="name"><span class="innerContentContainer">Vto为接收机的钟差为未知参数，其中di=c△ti，(i=1、2、3、4)，</span></span></li><li><span class="name"><span class="innerContentContainer">di分别为卫星ｉ到接收机之间的距离，</span></span></li><li><span class="name"><span class="innerContentContainer">△ti 分别为卫星ｉ的信号到达接收机所经历的时间，</span></span></li><li><span class="name"><span class="innerContentContainer">xi 、yi 、zi为卫星ｉ在t时刻的空间直角坐标，</span></span></li><li><span class="name"><span class="innerContentContainer">Vti为卫星钟的钟差，</span></span></li><li><span class="name"><span class="innerContentContainer">c为光速。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">xi、yi（i=1-4）即卫星的三维位置，时间一定，这个值就是固定的。所谓星历的目的就是根据时间计算卫星位置三维坐标的。</span></span></li><li><span class="name"><span class="innerContentContainer">关键点是di如何确定。每个gps信号自身都带有一个时间戳，告知接收方我这个信号何时从卫星发出。</span></span></li><li><span class="name"><span class="innerContentContainer">因为接收方（比如手机）没有高精度时间，所以需要4颗卫星来定位，第四颗星负责校准钟差，即接收方和GPS时钟的时钟差异。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">冷启动和热启动</span></span><ul><li><span class="name"><span class="innerContentContainer">冷启动是指第一次定位。较慢，一般要几分钟。</span></span><ul><li><span class="name"><span class="innerContentContainer">高通平台首次定位的要求：冷启动CN0值必须在28db以上，必须保持30s以上。</span></span></li><li><span class="name"><span class="innerContentContainer">华为标准是50秒。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">其它启动均为热启动，因为此时手机已经记忆了上次定位的信息，可以作为参考。</span></span></li><li><span class="name"><span class="innerContentContainer">上次定位信息的参考价值随着时间的推移会逐步降低，因为人的活动的。</span></span><ul><li><span class="name"><span class="innerContentContainer">有效期是2个小时。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">华为“秒定”方案（HiGeo方案），可以缩短到2-3秒，但是精确度较差。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">GPS误差的几个原因   <span class="contentTag" title="Filter #经验总结">#<span class="contentTagText">经验总结</span><span class="contentTagNub"></span></span> </span></span><ul><li><span class="name"><span class="innerContentContainer">卫星星历误差</span></span><ul><li><span class="name"><span class="innerContentContainer">在进行GPS定位时，计算在某时刻GPS卫星位置所需的卫星轨道参数是通过星历提供的，单通过星历所计算出的卫星位置都会与其真实位置有所差异，这就是所谓的星历误差。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">卫星钟的时钟误差，是GPS卫星上所安装的原子钟的钟面时与GPS标准时间的误差。</span></span></li><li><span class="name"><span class="innerContentContainer">卫星信号发射天线相位中心偏差，是GPS卫星上信号发射天线的标称相位中心与其真实相位中心之间的差异。</span></span></li><li><span class="name"><span class="innerContentContainer">雾霾对卫星信号影响较大。</span></span></li><li><span class="name"><span class="innerContentContainer">城市高楼对卫星信号的遮挡、多径效应，影响较大。</span></span></li><li><span class="name"><span class="innerContentContainer">典型问题：CDMA下无法发起AGPS或者AGPS定位不成功。</span></span><ul><li><span class="name"><span class="innerContentContainer">CDMA网络信令会提供基站坐标，GPSone会使用这个数据。</span></span></li><li><span class="name"><span class="innerContentContainer">但是中国电信的大量使用假数据，导致用了比不用还差。</span></span></li><li><span class="name"><span class="innerContentContainer">解决方法：关闭AGPS可解决。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">地理围栏（Location Intelligence）的原理</span></span><ul><li><span class="name"><span class="innerContentContainer">地理围栏算法解析： https://www.cnblogs.com/LBSer/p/4471742.html</span></span></li><li><span class="name"><span class="innerContentContainer">用一个虚拟的栅栏围出一个虚拟地理边界。当手机进入、离开某个特定地理区域，或在该区域内活动时，手机可以接收自动通知和警告。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">紧急定位方案（E911）</span></span><ul><li><span class="name"><span class="innerContentContainer">由网络侧发起的强制定位。</span></span></li><li><span class="name"><span class="innerContentContainer">可通过信令发起，也可通过数据业务发起。</span></span></li><li><span class="name"><span class="innerContentContainer">反馈位置也可以通过信令，也可以通过数据业务。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">代码结构</span></span><ul><li><span class="name"><span class="innerContentContainer">app层有 location manager service 和 gps location provider，给应用提供gps相关api。</span></span></li><li><span class="name"><span class="innerContentContainer">framework层有 libgps.so，app层通过jni调用。</span></span></li><li><span class="name"><span class="innerContentContainer">kernel层就是kernel driver。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>应用层使用Location服务的例子（含优化思路）</b></span></span><ul><li><span class="name"><span class="innerContentContainer">Android提供的定位接口是异步调用的, 大致流程如下:</span></span><ul><li><span class="name"><span class="innerContentContainer">locManager = (LocationManager)&nbsp;this.getSystemService(Context.LOCATION_SERVICE);</span></span></li><li><span class="name"><span class="innerContentContainer">// LocationListener包涵了几个成员函数，它们都是回调函数。</span></span></li><li><span class="name"><span class="innerContentContainer">locListener =&nbsp;new&nbsp;LocationListener() {</span></span><ul><li><span class="name"><span class="innerContentContainer">public&nbsp;void&nbsp;onStatusChanged(String provider,&nbsp;int&nbsp;status, Bundle extras) {</span></span><ul><li><span class="name"><span class="innerContentContainer">// TODO Auto-generated method stub</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li><li><span class="name"><span class="innerContentContainer">public&nbsp;void&nbsp;onProviderEnabled(String provider) {</span></span><ul><li><span class="name"><span class="innerContentContainer">// TODO Auto-generated method stub</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li><li><span class="name"><span class="innerContentContainer">public&nbsp;void&nbsp;onProviderDisabled(String provider) {</span></span><ul><li><span class="name"><span class="innerContentContainer">// TODO Auto-generated method stub</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li><li><span class="name"><span class="innerContentContainer">// onLocationChanged是最重要的一个回调，这个函数是在Android获取了新的location信息之后调用的，你可以在这个函数内来实现自己想要的功能。</span></span></li><li><span class="name"><span class="innerContentContainer">public&nbsp;void&nbsp;onLocationChanged(Location location) {</span></span><ul><li><span class="name"><span class="innerContentContainer">// TODO Auto-generated method stub</span></span></li><li><span class="name"><span class="innerContentContainer">mobileLocation = location;</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">}</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">};</span></span></li><li><span class="name"><span class="innerContentContainer">// 将定义的locationListener注册到定位服务中去。</span></span></li><li><span class="name"><span class="innerContentContainer">locManager.requestLocationUpdates(LocationManager.GPS_PROVIDER,&nbsp;0,&nbsp;0, locListener);</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">当onLocationChanged()被调用时, 就可以获得设备的真正GPS位置。</span></span></li><li><span class="name"><span class="innerContentContainer">问题来, 它什么时候会被调用？没人知道。可以写个小程序测试下. 大部分情况下, 可以在几十毫秒内就返回了，但也有一些时候，时间间隔长达几十秒。</span></span></li><li><span class="name"><span class="innerContentContainer">这样的方案不应该直接提供给用户使用. 可以优化的几个点是:</span></span><ul><li><span class="name"><span class="innerContentContainer">不要一直等待 onLocationChanged被调用, 要设置一个timeout机制。</span></span></li><li><span class="name"><span class="innerContentContainer">如果timeout了，但onLocationChanged仍然没有返回，怎么办？难道只能提示用户无法定位吗？Android还提供了一个函数：getlastKnowLocation。这个函数会返回android平台最后一次获取到的位置信息。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">getlastKnowLocation()的用法</span></span><ul><li><span class="name"><span class="innerContentContainer">Location lastKnownLocation = locationManager.getLastKnownLocation(LocationManager.GPS_PROVIDER);</span></span></li><li><span class="name"><span class="innerContentContainer">那么 这个的返回值值得信赖吗？</span></span></li><li><span class="name"><span class="innerContentContainer">需要定义一个标准判断获取到的Location是否可信。Android的Location这个类除了包涵有latitude,longitude，还包含有很多其他的信息，比如何时获取到的，通过哪种方式获取到的，等等。程序员完全可以基于这些信息来判断获取到的Location是否过时或者是否可信。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">Android的官方文档给出了推荐的方案：</span></span><ul><li><span class="name"><span class="innerContentContainer">首先注册自己的LocationListener，让它同时监听GPS_PROVIDER和NETWORK_PROVIDER；</span></span></li><li><span class="name"><span class="innerContentContainer">然后可以调用getLastKnownLocation获得一个Location值，这个值可以作为一个备选值；</span></span></li><li><span class="name"><span class="innerContentContainer">然后在一段用户可接受的时间内，不断接收从onLocationChanged返回的位置，并同之前的值做比较，选取其中的最佳；</span></span></li><li><span class="name"><span class="innerContentContainer">最后，会剩下一个筛选后的最优结果，你需要判断这个结果是否可接受。如果可以接受，返回给用户，如果不行，告诉用户无法定位。</span></span></li><li><span class="name"><span class="innerContentContainer">整个过程你需要定义两个重要的函数：一个是比较两个Location信息，返回其中好的那个；另一个函数则用来判断Location信息是否可以被接受。</span></span></li></ul></li></ul></li></ul>
  </body>
</html>