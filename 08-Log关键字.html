<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer"><b>Input  <span class="contentTag" title="Filter #Input">#<span class="contentTagText">Input</span><span class="contentTagNub"></span></span></b></span></span><ul><li><span class="name"><span class="innerContentContainer"><a class="contentLink" target="_blank" rel="noreferrer" href="https://blog.csdn.net/DroidPhone/article/details/8432055">https://blog.csdn.net/DroidPhone/article/details/8432055</a></span></span></li><li><span class="name"><span class="innerContentContainer">常规： Inputreader|inputdispatcher|eventhub|inputmanager_dispatch|InputTransport|PhoneWindowManager|processMotionEvent</span></span></li><li><span class="name"><span class="innerContentContainer">View 处理触摸事件： processMotionEvent </span></span><ul><li><span class="name"><span class="innerContentContainer">Input log开关不打开时，这个打印也有，所以方便。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>input rawdata： Input event</b></span></span><ul><li><span class="name"><span class="innerContentContainer">其中，device 即设备ID</span></span></li><li><span class="name"><span class="innerContentContainer">Type, 事件类型.</span></span><ul><li><span class="name"><span class="innerContentContainer">0, EV_SYN，同步事件。因为一个事件要保上报多次，所以需要同步事件来确认整个事件上报完毕。</span></span></li><li><span class="name"><span class="innerContentContainer">1, EV_KEY，描述键盘，按键或者类似键盘设备的状态变化。</span></span></li><li><span class="name"><span class="innerContentContainer">2, EV_REL，用来描述相对坐标轴上数值的变化，例如：鼠标向左方移动了5个单位。</span></span></li><li><span class="name"><span class="innerContentContainer">3, EV_ABS, 用来描述坐标轴上数值的变化，例如：描述触摸屏上坐标的值。</span></span></li><li><span class="name"><span class="innerContentContainer">4, EV_MSC, 当不能匹配现有的类型时，使用该类型。</span></span></li><li><span class="name"><span class="innerContentContainer">5, EV_SW, 描述具备两种状态的输入开关。</span></span></li><li><span class="name"><span class="innerContentContainer">17, EV_LED, 控制设备上的LED灯的开和关。</span></span></li><li><span class="name"><span class="innerContentContainer">18, EV_SND, 用来给设备输出提示声音。</span></span></li><li><span class="name"><span class="innerContentContainer">20, EV_REP, 用于可以自动重复的设备（autorepeating）。</span></span></li><li><span class="name"><span class="innerContentContainer">21, EV_FF, 用来给输入设备发送强制回馈命令。</span></span></li><li><span class="name"><span class="innerContentContainer">22, EV_PWR, 用于电源开关的输入。</span></span></li><li><span class="name"><span class="innerContentContainer">23, EV_FF_STATUS, 用于接收设备的强制反馈状态。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">code，指键值，即键的ID. 包括: </span></span><ul><li><span class="name"><span class="innerContentContainer">code值依赖 type字段, 相当于type的进一步说明.</span></span></li><li><span class="name"><span class="innerContentContainer">EV_KEY</span></span><ul><li><span class="name"><span class="innerContentContainer">EV_KEY事件采取KEY_&lt;name&gt; 或BTN_&lt;name&gt;的形式，比如，KEY_A代表键盘上的A键.</span></span></li><li><span class="name"><span class="innerContentContainer">当一个按键被按下时，一个带有按键编码和value为1的事件被发出。</span></span></li><li><span class="name"><span class="innerContentContainer">当一个按键被释放时，一个value为0的事件被发出。</span></span></li><li><span class="name"><span class="innerContentContainer">有些硬件当按键重复时会发出事件，这些事件的value值为2。</span></span></li><li><span class="name"><span class="innerContentContainer">通常，KEY_&lt;name&gt;用作键盘上的按键，而BTN_&lt;name&gt;则用于开关按钮事件。</span></span></li><li><span class="name"><span class="innerContentContainer">几个特殊的codes:</span></span></li><li><span class="name"><span class="innerContentContainer">116, 0x74, power键</span></span></li><li><span class="name"><span class="innerContentContainer">115, 0x73, 音量上</span></span></li><li><span class="name"><span class="innerContentContainer">114, 0x72, 音量下</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_&lt;name&gt;</span></span><ul><li><span class="name"><span class="innerContentContainer">BTN_TOOL_PEN, 0x140</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_RUBBER, 0x141</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_BRUSH, 0x142</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_PENCIL, 0x143</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_AIRBRUSH, 0x144</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_FINGER, 0x145</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_MOUSE, 0x146</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_LENS, 0x147</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_QUINTTAP, 0x148</span></span></li><li><span class="name"><span class="innerContentContainer">这些codes用于配合触控板，平板和触摸屏这些设备的输入，这些设备可以使用手指，笔或者其它工具。</span></span></li><li><span class="name"><span class="innerContentContainer">当一个事件发生并且检测到某种工具在使用时，相应的BTN_TOOL_&lt;name&gt; code事件应该把value设为1，</span></span></li><li><span class="name"><span class="innerContentContainer">当该工具不再和输入设备进行交互时，value应该复位为0。</span></span></li><li><span class="name"><span class="innerContentContainer">所有的触控板，当事件发生时，平板和触摸屏映泰至少使用一种BTN_TOOL_&lt;name&gt; code。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">0x14a, BTN_TOUCH, 触摸屏</span></span><ul><li><span class="name"><span class="innerContentContainer">用于触摸事件。当一个输入工具被判定为有意义的物理接触时，这一特性的value值应该设为1。</span></span></li><li><span class="name"><span class="innerContentContainer">所谓有意义的物理接触可以是任何的接触，又或者是满足某种定义条件的接触。</span></span></li><li><span class="name"><span class="innerContentContainer">例如，触摸板可以当触摸的压力达到某一个值以上时才把value设为1，一个用笔的平板当笔划过但没有接触到平板的表面时，把BTN_TOOL_PEN的value设为1，而把BTN_TOUCH的value设为0.</span></span></li><li><span class="name"><span class="innerContentContainer">出于历史的原因，用户空间会把带有BTN_TOOL_FINGER和 BTN_TOUCH的触摸设备解释为触摸板，而类似的不带BTN_TOOL_FINGER的触摸设备则被解释为触摸屏。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">0x14b，BTN_STYLUS, 手写笔</span></span></li><li><span class="name"><span class="innerContentContainer">BTN_TOOL_FINGER, BTN_TOOL_DOUBLETAP,BTN_TOOL_TRIPLETAP, BTN_TOOL_QUADTAP</span></span><ul><li><span class="name"><span class="innerContentContainer">这些codes表明一个，两个，三个和四个手指参与触摸板和触摸屏的操作。</span></span></li><li><span class="name"><span class="innerContentContainer">如果用户使用两只手指在触摸板上试图滚动屏幕上的内容，在运动期间，应该发送value为1的BTN_TOOL_DOUBLETAP。</span></span></li><li><span class="name"><span class="innerContentContainer">在多手指触摸驱动中，应该使用input_mt_report_finger_count()函数来发出以上这些codes，详情请参看内核文档：multi-touch-protocol.txt。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">EV_REL</span></span><ul><li><span class="name"><span class="innerContentContainer">EV_REL事件描述了某种特性的相对变化量。例如，鼠标向左方移动了几个单位距离，但是他的绝对位置是未知的。</span></span></li><li><span class="name"><span class="innerContentContainer">如果我们可以知道绝对位置，那我们应该使用EV_ABS而不是EV_REL。</span></span></li><li><span class="name"><span class="innerContentContainer">下面这些属于EV_REL的codes有特别的意义：</span></span></li><li><span class="name"><span class="innerContentContainer">REL_WHEEL, REL_HWHEEL:</span></span><ul><li><span class="name"><span class="innerContentContainer">用于对应的垂直方向和水平方向的滚轮。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">EV_ABS</span></span><ul><li><span class="name"><span class="innerContentContainer">EV_ABS事件描述了某一特性的绝对变化值，例如，触摸板会用它发出当前位置的绝对坐标值。</span></span></li><li><span class="name"><span class="innerContentContainer">以下这些属于EV_ABS的 codes有特殊的意义：</span></span></li><li><span class="name"><span class="innerContentContainer">ABS_DISTANCE:</span></span></li><li><span class="name"><span class="innerContentContainer">用来描述触摸工具离触摸表面的距离。这一事件应该只有当触摸工具在表面悬空滑过时发出，也就是说，在靠经触摸表面，但是BTN_TOUCH的value是0的时候。如果输入设备可以工作在3维坐标时，应该考虑使用ABS_Z会更好。</span></span><ul><li><span class="name"><span class="innerContentContainer">ABS_MT_&lt;name&gt;:</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">用于描述多手指触摸输入设备。详情请参考内核文档：multi-touch-protocol.txt。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">value，指具体值</span></span><ul><li><span class="name"><span class="innerContentContainer">1 表示按下</span></span></li><li><span class="name"><span class="innerContentContainer">0 表示抬起</span></span></li><li><span class="name"><span class="innerContentContainer">触摸事件时，value表示坐标。x, y轴是分开上报的。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>事件上报： notifyMotion|notifyKey|dispatchMotion|dispatchKey</b></span></span><ul><li><span class="name"><span class="innerContentContainer">分为两组，前者在入队列前打印，后两者在分发前打印。两组内容基本一样，仅policyFlags可能会发生变化。</span></span></li><li><span class="name"><span class="innerContentContainer">各枚举字段的含义在 input.h 中定义。</span></span></li><li><span class="name"><span class="innerContentContainer">eventTime, 事件上报时间</span></span></li><li><span class="name"><span class="innerContentContainer">downTime, down事件时间。</span></span><ul><li><span class="name"><span class="innerContentContainer">注意，所有非down的事件，它的downTime不等于自己的eventTime，而是等于上一次的eventTime。</span></span></li><li><span class="name"><span class="innerContentContainer">凡是不满足这个条件的，都是非法事件，会被过滤掉。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">deviceId： 设备id。即hal层input设备id。</span></span><ul><li><span class="name"><span class="innerContentContainer">R版本上，注入的事件统一设置为-1。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">source，设备类型</span></span><ul><li><span class="name"><span class="innerContentContainer">触屏： 0x1002</span></span></li><li><span class="name"><span class="innerContentContainer">键盘： 0x101</span></span></li><li><span class="name"><span class="innerContentContainer">鼠标： 0x2002</span></span></li><li><span class="name"><span class="innerContentContainer">手写笔： 0x4002</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">policyFlags： 即wms窗口策略。 重要</span></span><ul><li><span class="name"><span class="innerContentContainer">1, 保持系统唤醒</span></span></li><li><span class="name"><span class="innerContentContainer">2, 是虚拟导航按键</span></span></li><li><span class="name"><span class="innerContentContainer">4, 是特殊功能修饰健（Ctrl、shift 之类）</span></span></li><li><span class="name"><span class="innerContentContainer">8, </span></span></li><li><span class="name"><span class="innerContentContainer">0x100 0000，注入的事件</span></span></li><li><span class="name"><span class="innerContentContainer">0x200 0000，可信的</span></span></li><li><span class="name"><span class="innerContentContainer">0x400 0000， 过滤的</span></span></li><li><span class="name"><span class="innerContentContainer">0x800 0000， 禁用自动重复事件。</span></span></li><li><span class="name"><span class="innerContentContainer">0x2000 0000，交互的事件。</span></span></li><li><span class="name"><span class="innerContentContainer">0x4000 0000，事件要传递到应用层，即 PASS_TO_USER.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">action: 事件类型。重要。</span></span><ul><li><span class="name"><span class="innerContentContainer">0： down</span></span></li><li><span class="name"><span class="innerContentContainer">1： up</span></span></li><li><span class="name"><span class="innerContentContainer">2： move</span></span></li><li><span class="name"><span class="innerContentContainer">3： cancel</span></span></li><li><span class="name"><span class="innerContentContainer">4： outside</span></span></li><li><span class="name"><span class="innerContentContainer">7： hover move</span></span></li><li><span class="name"><span class="innerContentContainer">9： hover enter</span></span></li><li><span class="name"><span class="innerContentContainer">10： hover exit</span></span></li><li><span class="name"><span class="innerContentContainer">11： button press</span></span></li><li><span class="name"><span class="innerContentContainer">12： button release</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">actionButton： 按键类型，比如左键、中键、右键之类。</span></span></li><li><span class="name"><span class="innerContentContainer">flags： </span></span><ul><li><span class="name"><span class="innerContentContainer">对于触摸事件，用于标记点位发生在屏幕边界，分上下左右。--不常用。</span></span></li><li><span class="name"><span class="innerContentContainer">对于按键事件，这个字段重要多了。</span></span><ul><li><span class="name"><span class="innerContentContainer">2，软键盘产生的事件。</span></span></li><li><span class="name"><span class="innerContentContainer">8, 事件来自系统，不可被应用屏蔽。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">Precision: 分x、y轴, 屏幕密度，一般是1。</span></span></li><li><span class="name"><span class="innerContentContainer"><b>keyCode: 按键键值(逻辑)</b></span></span><ul><li><span class="name"><span class="innerContentContainer">在 Keycodes.h 和 KeyEvent.java 中定义，两者保持一一对应。</span></span></li><li><span class="name"><span class="innerContentContainer">在 InputEventLabels.h 中引用。如果要修改，这三处要保持一致。</span></span></li><li><span class="name"><span class="innerContentContainer">fwk和应用使用keyCode。</span></span></li><li><span class="name"><span class="innerContentContainer">3, KeyCode_HOME</span></span></li><li><span class="name"><span class="innerContentContainer">4, KeyCode_BACK</span></span></li><li><span class="name"><span class="innerContentContainer">187，0xbb, KeyCode_APP_SWITCH</span></span></li><li><span class="name"><span class="innerContentContainer">24, 0x18, 音量上</span></span></li><li><span class="name"><span class="innerContentContainer">25, 0x19, 音量下</span></span></li><li><span class="name"><span class="innerContentContainer">26, 0x1a, power键</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>scanCode: 按键键值(硬件)</b></span></span><ul><li><span class="name"><span class="innerContentContainer">输入设备上报的值。在 framework/base/data/keyboards 目录下的各 *.kl 文件中定义。</span></span></li><li><span class="name"><span class="innerContentContainer">116, 0x74, power键</span></span></li><li><span class="name"><span class="innerContentContainer">115, 0x73, 音量上</span></span></li><li><span class="name"><span class="innerContentContainer">114, 0x72, 音量下</span></span></li><li><span class="name"><span class="innerContentContainer">158, 0x9e, back键</span></span></li><li><span class="name"><span class="innerContentContainer">102, 0x66, home键</span></span></li><li><span class="name"><span class="innerContentContainer">580, 0x244, app switch键</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">metaState: 键盘，标识 Ctrl、ALT等按键的状态。 参见 ameta_none</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer"><b>触摸屏报点： Pointer</b></span></span><ul><li><span class="name"><span class="innerContentContainer">id：点的序号，从0开始，一些input事件有多个点。</span></span></li><li><span class="name"><span class="innerContentContainer">toolType： 触摸工具类型。</span></span><ul><li><span class="name"><span class="innerContentContainer">1, 手指</span></span></li><li><span class="name"><span class="innerContentContainer">2, 手写笔</span></span></li><li><span class="name"><span class="innerContentContainer">3, 鼠标</span></span></li><li><span class="name"><span class="innerContentContainer">4, 橡皮擦 ？</span></span></li><li><span class="name"><span class="innerContentContainer">5, 手掌 ？</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">x, y： 点坐标</span></span></li><li><span class="name"><span class="innerContentContainer">pressure: 按下压力值。用于按压屏或者手写笔。</span></span></li><li><span class="name"><span class="innerContentContainer">size： 触摸区域的大小（近似值）。0到1之间。</span></span></li><li><span class="name"><span class="innerContentContainer">touchMajor, tohchMinor, 触摸区域的长轴和短轴（单位为像素）</span></span></li><li><span class="name"><span class="innerContentContainer">toolMajor, toolMinor, 触摸根工具的长轴和短轴 （单位为像素）</span></span></li><li><span class="name"><span class="innerContentContainer">这4个值一般一样。</span></span></li><li><span class="name"><span class="innerContentContainer">orientation: 屏幕方向，0表示竖屏。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">channel 发送事件的流程</span></span><ul><li><span class="name"><span class="innerContentContainer">enqueueDispatchCycle</span></span></li><li><span class="name"><span class="innerContentContainer">prepareDispatchCycle</span></span></li><li><span class="name"><span class="innerContentContainer">startDispatchCycle</span></span></li><li><span class="name"><span class="innerContentContainer">publishMotionEvent</span></span></li><li><span class="name"><span class="innerContentContainer">finishDispatchCycle</span></span></li><li><span class="name"><span class="innerContentContainer">sendFinishedSignal</span></span></li><li><span class="name"><span class="innerContentContainer">receiveFinishedSignal </span></span><ul><li><span class="name"><span class="innerContentContainer">注意，errno=11 并不是什么错误。意思是当前处理过程被其它进程打断，后续调度回来会继续处理，不会影响业务。这种错误id很常见。</span></span></li></ul></li></ul></li><li><span class="name"></span></li><li><span class="name"><span class="innerContentContainer">取得焦点窗口： Focus entered window</span></span></li><li><span class="name"><span class="innerContentContainer"><b>事件注入： injectInputEvent|should inject</b></span></span><ul><li><span class="name"><span class="innerContentContainer">injectorPid: 注入线程id</span></span></li><li><span class="name"><span class="innerContentContainer">injectorUid: 注入线程uid</span></span></li><li><span class="name"><span class="innerContentContainer">Finished with result to 0: 注入成功。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">事件拦截： interceptKeyBeforeQueueing|interceptKeyBeforeDispatching</span></span></li><li><span class="name"><span class="innerContentContainer">事件cancel： InputDispatcher: cancel</span></span><ul><li><span class="name"><span class="innerContentContainer">各字段含义和 notify Motion相同。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">事件cancel的原因：cancellation events</span></span><ul><li><span class="name"><span class="innerContentContainer">其中，channel, cancel</span></span></li><li><span class="name"><span class="innerContentContainer">synthesized，被cancel的事件的数量</span></span></li><li><span class="name"><span class="innerContentContainer">mode，cancel模式</span></span><ul><li><span class="name"><span class="innerContentContainer">1, 点事件</span></span></li><li><span class="name"><span class="innerContentContainer">2, 非点事件</span></span></li><li><span class="name"><span class="innerContentContainer">3, callback事件</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">事件被跳过： skipping inconsistent motion event</span></span></li><li><span class="name"><span class="innerContentContainer">事件删除： Dropping</span></span><ul><li><span class="name"><span class="innerContentContainer">第二个关键字是删除原因</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">事件过滤： filter|shouldInterceptEventLocked </span></span></li><li><span class="name"><span class="innerContentContainer">事件冲突： Conflicting pointer actions</span></span></li><li><span class="name"></span></li><li><span class="name"><span class="innerContentContainer">设备识别： Device added|New device|Input event</span></span><ul><li><span class="name"><span class="innerContentContainer">其中，id 后面用得比较多。</span></span></li><li><span class="name"><span class="innerContentContainer">classes 为设备类型，为掩码量。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">光标显示： unfade|fade|cursor</span></span></li><li><span class="name"><span class="innerContentContainer">横竖屏切换： Device reconfigured</span></span><ul><li><span class="name"><span class="innerContentContainer">其中，size： 屏幕坐标</span></span></li><li><span class="name"><span class="innerContentContainer">orientation： 0表示竖屏, 1表示横屏。</span></span></li><li><span class="name"><span class="innerContentContainer">mode： 设备模式，参见 DeviceMode.</span></span></li></ul></li></ul>
  </body>
</html>