<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      body {font-family:'Helvetica Neue', Arial, sans-serif; color:#333; font-size:13px; line-height:17px;}
      body .name,body .note {white-space:pre-wrap;}
      body ul {list-style:disc; margin:0; padding:0;}
      body li {margin:4px 0 4px 20px; padding:0;}
      body>.name {font-size:16px; line-height:21px;}
      body>.note {font-size:13px; line-height:17px;}
      body>ul {margin-top:15px;}
      body .name.done {text-decoration:line-through; color:#999;}
      body .note {font-size:12px; color:#666;}
    </style>
  </head>
  <body>
    <span class="name"><span class="innerContentContainer">34-升级</span></span><ul><li><span class="name"><span class="innerContentContainer">FTM模式</span></span><ul><li><span class="name"><span class="innerContentContainer">开机进入recovery机器人界面，且屏幕中间显示“factory”。</span></span></li><li><span class="name"><span class="innerContentContainer">是否进FTM在misc分区中设置。</span></span></li><li><span class="name"><span class="innerContentContainer">FTM子模式有哪几种？</span></span><ul><li><span class="name"><span class="innerContentContainer">NV 453=1，进纯FTM模式；</span></span></li><li><span class="name"><span class="innerContentContainer">如果再加上NV 60003的值，进 FTM各子模式。</span></span><ul><li><span class="name"><span class="innerContentContainer">=1，wifi 校准；</span></span></li><li><span class="name"><span class="innerContentContainer">=2，wifi 环回测试；</span></span></li><li><span class="name"><span class="innerContentContainer">=3，BT 校准。</span></span></li></ul></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">recovery</span></span><ul><li><span class="name"><span class="innerContentContainer">recovery是一种启动模式、一个分区、一个独立的运行单元，也是一个有main()入口的linux程序。</span></span></li><li><span class="name"><span class="innerContentContainer">recovery有自己的kernel，以及运行其上的完成recovery各子功能的linux应用。</span></span></li><li><span class="name"><span class="innerContentContainer">如何进入recovery？</span></span><ul><li><span class="name"><span class="innerContentContainer">按音量上键开机, 进recovery菜单；</span></span></li><li><span class="name"><span class="innerContentContainer">NV 453=1，进FTM模式；</span></span></li><li><span class="name"><span class="innerContentContainer">NV 60002=1（UMTS），或NV 60009=1（CDMA），进快速注册模式；</span></span></li><li><span class="name"><span class="innerContentContainer">NV 60004=1，settings菜单恢复出厂设置即是设置这个值后重启。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">recovery的主要功能</span></span><ul><li><span class="name"><span class="innerContentContainer">格式化data分区</span></span><ul><li><span class="name"><span class="innerContentContainer">格式化前将 /data/dataapp 中的文件备份到cache分区，格式化后再恢复回来。</span></span></li><li><span class="name"><span class="innerContentContainer">这个目录是放运营商定制apk, 不能删除了.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">格式化内置SD卡</span></span></li><li><span class="name"><span class="innerContentContainer">格式化cache分区</span></span></li><li><span class="name"><span class="innerContentContainer">格式化cache分区</span></span></li><li><span class="name"><span class="innerContentContainer">备份数据恢复</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">misc分区作为模块间传递命令的载体</span></span><ul><li><span class="name"><span class="innerContentContainer">好处是重启前后都在。大小一般为2M。</span></span></li><li><span class="name"><span class="innerContentContainer">misc分区可以升级, 升级大包中有，以便初始化该分区。</span></span></li><li><span class="name"><span class="innerContentContainer">misc分区中的数据</span></span><ul><li><span class="name"><span class="innerContentContainer">第1个字段, 关机充电</span></span></li><li><span class="name"><span class="innerContentContainer">第2个字段, recovery信息</span></span></li><li><span class="name"><span class="innerContentContainer">第3个字段, recovery掉电保护</span></span></li><li><span class="name"><span class="innerContentContainer">第4个字段, ota升级标志</span></span></li><li><span class="name"><span class="innerContentContainer">第5个字段, kernel panic信息</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">cust升级</span></span><ul><li><span class="name"><span class="innerContentContainer">cust 升级即定制升级. 定制需求一般来自运营商.</span></span></li><li><span class="name"><span class="innerContentContainer">方案设计原则</span></span><ul><li><span class="name"><span class="innerContentContainer">cust分区是个全集, 包括全球所有定制的配置文件.</span></span></li><li><span class="name"><span class="innerContentContainer">系统运行时, 通过软链接方式将自己需要的子集载入系统, 并mount 到 /data/cust. </span></span></li><li><span class="name"><span class="innerContentContainer">应用访问 /data/cust 来读取自己的配置信息, 完全透明访问. </span></span></li><li><span class="name"><span class="innerContentContainer">从 /data/custom.bin 可读取当前使用的是哪个运营商.</span></span></li><li><span class="name"><span class="innerContentContainer">由此可做到代码和定制归一化。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">cust包的内容</span></span><ul><li><span class="name"><span class="innerContentContainer">cust分区</span></span><ul><li><span class="name"><span class="innerContentContainer">所有定制信息，以“运营商信息/国家“为路径组织起来。</span></span></li><li><span class="name"><span class="innerContentContainer">包括ap侧到的定制配置文件（主要是xml文件）、modem侧的logo和定制nv。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">vendor_id包</span></span><ul><li><span class="name"><span class="innerContentContainer">很小, 一般十几个字节.</span></span></li><li><span class="name"><span class="innerContentContainer">就是文本文件. 内容是 运营商信息 + 国家信息，比如vodafone/German。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">cust包升级方式</span></span><ul><li><span class="name"><span class="innerContentContainer">大包升级的最后一步, 自动升级cust包;</span></span></li><li><span class="name"><span class="innerContentContainer">生产工位打背贴时，通过后台写入vendor_id. 会激活cust升级.</span></span></li><li><span class="name"><span class="innerContentContainer">在研发环境下, 通过diag命令, 切换运营商, 也会触发cust升级.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">升级流程</span></span><ul><li><span class="name"><span class="innerContentContainer">aboot 从oeminfo中读vendor id, 写到 cmdline中。</span></span><ul><li><span class="name"><span class="innerContentContainer">以通过如下命令查看： cat /proc/cmdline</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">init进程会对比 /proc/cmdline（A） 和 /data/custom.bin（B） 的值。会有几种场景:</span></span><ul><li><span class="name"><span class="innerContentContainer">第一次开机，A与B都是空的。</span></span><ul><li><span class="name"><span class="innerContentContainer">init 的做法是：写 hw/default 到B，然后激活 init.rc中的on cust，按默认值激活cust升级, 完成后然后重启。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">第二次开机，A空B不空，则正常启动。</span></span></li><li><span class="name"><span class="innerContentContainer">如果A&lt;&gt;B(原因是升级vendor信息后开机). 则:</span></span><ul><li><span class="name"><span class="innerContentContainer">重启，先进行恢复出厂设置.</span></span><ul><li><span class="name"><span class="innerContentContainer">cust升级前为什么要recovery?</span></span></li><li><span class="name"><span class="innerContentContainer">因为要把data分区中的软链接都删除，如果删除失败则cust升级会失败。</span></span></li><li><span class="name"><span class="innerContentContainer">以防万一，就把data分区格式化一遍。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">然后做on cust操作</span></span><ul><li><span class="name"><span class="innerContentContainer">on cust升级之init.rc中定义，完成三种功能：</span></span></li><li><span class="name"><span class="innerContentContainer">custcopy：copy一个文件；</span></span></li><li><span class="name"><span class="innerContentContainer">custsymlink：copy一个目录；</span></span></li><li><span class="name"><span class="innerContentContainer">load_oemlogo：copy logo。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">最后停在recovery界面下。</span></span></li><li><span class="name"><span class="innerContentContainer">以上就是所谓的cust升级流程.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">如果A=B（非首次开机），不做任何事。</span></span></li><li><span class="name"><span class="innerContentContainer">如果是B不存在，说明刚升过级，且没有走cust升级流程, 则把A写入B，然后进入cust升级流程。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">预置apk的安装位置</span></span><ul><li><span class="name"><span class="innerContentContainer">系统apk 放在 /system/app下，不可删除，恢复出厂设置不会删除。</span></span></li><li><span class="name"><span class="innerContentContainer">厂商预制apk 放在 /system/delapp，可删除，但是恢复出厂设置又会回来。</span></span></li><li><span class="name"><span class="innerContentContainer">用户安装apk 放在 /data/app下，可删除，恢复出厂设置会删除。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">hota升级</span></span><ul><li><span class="name"><span class="innerContentContainer">ota升级: fireware over the air，无线补丁升级。</span></span></li><li><span class="name"><span class="innerContentContainer">有三种方案：</span></span><ul><li><span class="name"><span class="innerContentContainer">redband的fota方案</span></span><ul><li><span class="name"><span class="innerContentContainer">该方案每台手机收费0.2美金。所以现在基本不用.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">google提供的ota方案</span></span><ul><li><span class="name"><span class="innerContentContainer">部分运营商明确要使用google方案.</span></span></li><li><span class="name"><span class="innerContentContainer">升级包需要放在google的服务器上。</span></span></li><li><span class="name"><span class="innerContentContainer">gota升级有如下规则：原始版本与目标版本的平台编译时间戳必须不同，如果相同则google服务器上无法检测到。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">华为实现的hota方案. 常用.</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">hota包下载到手机的方式</span></span><ul><li><span class="name"><span class="innerContentContainer">通过settings下载hota升级包</span></span><ul><li><span class="name"><span class="innerContentContainer">根据手机当前版本号或IMEI号找下载包.</span></span></li><li><span class="name"><span class="innerContentContainer">菜单中只能搜索到一个差分包。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">自动下载</span></span><ul><li><span class="name"><span class="innerContentContainer">默认自动下载周期是10天，周期可通过cust定制。</span></span></li><li><span class="name"><span class="innerContentContainer">用户可在菜单中定制周期，也可以将自动检测关闭。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">下载方式</span></span><ul><li><span class="name"><span class="innerContentContainer">用android原生的DownloadProvider，支持断点续传。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">差分包的保存位置</span></span><ul><li><span class="name"><span class="innerContentContainer">升级包展开后，有sd卡的放在sd卡上，</span></span></li><li><span class="name"><span class="innerContentContainer">无sd卡的放在内置卡，</span></span></li><li><span class="name"><span class="innerContentContainer">内置卡空间不足，放在 /cache/fotapkg下。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">data分区的问题</span></span><ul><li><span class="name"><span class="innerContentContainer">hoto升级不会擦除/data分区，所以用户数据保留。</span></span></li><li><span class="name"><span class="innerContentContainer">但升级过程中可以往 data分区添加文件。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">升级过程</span></span><ul><li><span class="name"><span class="innerContentContainer">ap侧下载升级包</span></span></li><li><span class="name"><span class="innerContentContainer">调用hota_start_update()</span></span></li><li><span class="name"><span class="innerContentContainer">设置misc信息</span></span><ul><li><span class="name"><span class="innerContentContainer">写入misc的信息如下：update_package=SDCARD:文件名.zip </span></span></li><li><span class="name"><span class="innerContentContainer">或者 CACHE:文件名.zip</span></span></li><li><span class="name"><span class="innerContentContainer">取决于差分包的保存位置。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">系统重启进入recovery模式</span></span></li><li><span class="name"><span class="innerContentContainer">hota在recovery中完成</span></span><ul><li><span class="name"><span class="innerContentContainer">recovery中，get_args()函数从misc分区或command文件中获取升级包位置。</span></span></li><li><span class="name"><span class="innerContentContainer">调用ota_status_check()，读misc信息，确定是hota，还是fota。如果都不是，则清空misc和cache，然后重启。</span></span></li><li><span class="name"><span class="innerContentContainer">调用do_hota_update()，完成第一阶段升级，即差分升级。</span></span></li><li><span class="name"><span class="innerContentContainer">调用maybe_install_fireware_update()，将modem侧升级的update.app写入cache分区，设置misc信息为：hota_update_radio。</span></span></li><li><span class="name"><span class="innerContentContainer">手机再次重启，oemsbl_dload_check()中读取misc信息，然后调用dload_sd()完成对aboot、boot、recovery和modem侧诸模块升级。</span></span></li><li><span class="name"><span class="innerContentContainer">升级完成后，重启进入recovery，清除cache和misc对应字段，然后重启。</span></span></li><li><span class="name"><span class="innerContentContainer">升级log放在 data/last.log中，注意进入recovery会被覆盖。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">root过的手机不能进行hota升级。</span></span></li><li><span class="name"><span class="innerContentContainer">hota升级可删除文件</span></span><ul><li><span class="name"><span class="innerContentContainer">hota升级脚本为 /META-INF/com/google/android/updater-script, </span></span></li><li><span class="name"><span class="innerContentContainer">在其中的delete字段中加一行：delete("/data/misc/wifi/load/ar6000.ko");</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">差分算法</span></span><ul><li><span class="name"><span class="innerContentContainer">如果不一致, 拷贝a文件，生成备份文件，叫a.backup。</span></span></li><li><span class="name"><span class="innerContentContainer">差分升级只支持 system、cust等ext4分区。</span></span></li><li><span class="name"><span class="innerContentContainer">具体过程如下：</span></span></li><li><span class="name"><span class="innerContentContainer">先检查新旧文件是否一致，一致就跳过；</span></span></li><li><span class="name"><span class="innerContentContainer">如果system剩余空间小于a文件的1.5倍，则放到/cache分区，如果cache空间也不够，则报错。</span></span></li><li><span class="name"><span class="innerContentContainer">对a.backup进行差分，升级完成后命名为a，拷贝到原处。这样做的目的是掉电保护。</span></span></li><li><span class="name"><span class="innerContentContainer">其实是用google ota的算法。对ext4的文件系统来说，有专门的命令对比两个ext4文件系统的差异，因此极大的降低了方案的复杂程度。</span></span></li></ul></li></ul></li><li><span class="name"><span class="innerContentContainer">升级安全方案</span></span><ul><li><span class="name"><span class="innerContentContainer">升级包结构如下:</span></span></li><li><span class="name"><span class="innerContentContainer">MD5-RSA</span></span><ul><li><span class="name"><span class="innerContentContainer">存放: CRC模块经过MD5加密后，再经过私钥A加密后的数据，128B。</span></span></li><li><span class="name"><span class="innerContentContainer">它的检验方式: oeminfo分区有公钥A，将密文解密为MD5数据，然后将明文进行MD5加密，两个对比，如一致则ok。</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">CRC</span></span><ul><li><span class="name"><span class="innerContentContainer">升级包以下各模块的CRC值表。</span></span></li><li><span class="name"><span class="innerContentContainer">按模块顺序，每32K数据算一个16位的CRC值，不足32K的也算一个CRC。</span></span></li><li><span class="name"><span class="innerContentContainer">最大长度为128KB，对应升级包为1GB大小。(现在肯定改了)</span></span></li></ul></li><li><span class="name"><span class="innerContentContainer">AMSS_ECC</span></span><ul><li><span class="name"><span class="innerContentContainer">目的是给amss加密。</span></span></li><li><span class="name"><span class="innerContentContainer">它分为密文和明文两部分，明文为amss模块的ecc列表，每512B字节算16位的ecc数据；</span></span></li><li><span class="name"><span class="innerContentContainer">密文为明文做md5，然后再rsa加密后的1024位数据。</span></span></li><li><span class="name"><span class="innerContentContainer">amss的ecc检验方案在智能机上没有使用。原因是没有必要去保护。</span></span></li></ul></li></ul></li></ul>
  </body>
</html>